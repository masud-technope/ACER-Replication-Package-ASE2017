licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina valves java i o exception ioexception java util enumeration java util iterator java util linked list linkedlist java util list java util regex pattern javax servlet servlet exception servletexception org apache catalina access log accesslog org apache catalina globals org apache catalina connector request org apache catalina connector response org apache juli logging log org apache juli logging log factory logfactory tomcat port href http http d httpd apache org docs trunk mod mod remote ip remoteip html mod remote ip remoteip valve replaces app are nt apparent client remote address host name hostname request address list presented proxy load balancer request headers for warded forwarded feature valve replace app are nt apparent scheme http https server port scheme presented proxy load balancer request header for warded forwarded proto valve proc eeds proceeds incoming code request get remote addr getremoteaddr code matches valve list internal proxies loop comma delimited list i p s ips host names hostnames passed preceding load balancer proxy request http header named code remote ip header remoteipheader code code for warded forwarded code values processed left order host list matches internal proxies list host swallowed matches trusted proxies list host created proxies header host declared remote looping stopped request http header named code protocol header protocolheader code code for warded forwarded code equals code protocol header https value protocolheaderhttpsvalue code configuration parameter code https code code request is secure issecure code code request scheme https code code request server port serverport code note overwritten code https server port httpsserverport code configuration parameter strong configuration parameters strong table border remote ip valve remoteipvalve property description equivalent mod remote ip remoteip directive format remote ip header remoteipheader http header read valve holds list traversed add res ses addresses starting req uesting requesting client remoteipheader compliant http header for warded forwarded internal proxies internalproxies regular expression matches add res ses addresses internal proxies code remote ip header remoteipheader code trusted code proxies header proxiesheader code remoteipinternalproxy regular expression syntax supported link java util regex pattern java util regex allowed enabled complex describe regular expressions proxies header proxiesheader http header created valve hold list proxies processed incoming code remote ip header remoteipheader code proxies header proxiesheader compliant http header for warded forwarded trusted proxies trustedproxies regular expression matches add res ses addresses trusted proxies code remote ip header remoteipheader code trusted code proxies header proxiesheader code remoteiptrustedproxy regular expression syntax supported link java util regex pattern java util regex nbsp protocol header protocolheader http header read valve holds flag request compliant http header code for warded forwarded proto code code for warded forwarded ssl code code front https code code code protocol header https value protocolheaderhttpsvalue code protocol header protocolheader code https request string code https code code code code https code http server port httpserverport returned link javax servlet servlet request servletrequest get server port getserverport code protocol header protocolheader code code http code protocol int eger integer https server port httpsserverport returned link javax servlet servlet request servletrequest get server port getserverport code protocol header protocolheader code code https code protocol int eger integer table valve attached container depending granularity filtering perform strong regular expression address blocks strong code mod remote ip remoteip code address blocks code code configure code remoteipinternalproxy code code remoteiptrustedproxy code tomcat doesn library href http apr apache org docs apr group apr net work network html apr ipsubnet test code remote ip valve remoteipvalve code regular expression configure code internal proxies internalproxies code code trusted proxies trustedproxies code fashion link request filter valve requestfiltervalve strong sample internal proxies strong remote ip valve remoteipvalve configuration code pre valve class name classname org apache catalina valves remote ip valve remoteipvalve internal proxies internalproxies remote ip header remoteipheader for warded forwarded proxies header proxiesheader for warded forwarded protocol header protocolheader for warded forwarded proto pre code request values table border property remote ip valve remoteipvalve remote ip valve remoteipvalve request remote addr remoteaddr request header for warded forwarded request header for warded forwarded request header for warded forwarded proto https https request scheme http https request secure request server port serverport table note code for warded forwarded code header internal proxies traversed request code for warded forwarded code proxies trusted internal strong sample trusted proxies strong remote ip valve remoteipvalve configuration code pre valve class name classname org apache catalina valves remote ip valve remoteipvalve internal proxies internalproxies remote ip header remoteipheader for warded forwarded proxies header proxiesheader for warded forwarded trusted proxies trustedproxies proxy proxy pre code request values table border property remote ip valve remoteipvalve remote ip valve remoteipvalve request remote addr remoteaddr request header for warded forwarded proxy proxy request header for warded forwarded proxy proxy table note code proxy code code proxy code trusted proxies code for warded forwarded code header migrated code for warded forwarded code header code for warded forwarded code proxies trusted internal strong sample internal trusted proxies strong remote ip valve remoteipvalve configuration code pre valve class name classname org apache catalina valves remote ip valve remoteipvalve internal proxies internalproxies remote ip header remoteipheader for warded forwarded proxies header proxiesheader for warded forwarded trusted proxies trustedproxies proxy proxy pre code request values table border property remote ip valve remoteipvalve remote ip valve remoteipvalve request remote addr remoteaddr request header for warded forwarded proxy proxy request header for warded forwarded proxy proxy table note code proxy code code proxy code trusted proxies code for warded forwarded code header migrated code for warded forwarded code header code code internal proxy code for warded forwarded code code for warded forwarded code proxies trusted internal strong sample untrusted proxy strong remote ip valve remoteipvalve configuration code pre valve class name classname org apache catalina valves remote ip valve remoteipvalve internal proxies internalproxies remote ip header remoteipheader for warded forwarded proxies header proxiesheader for warded forwarded trusted proxies trustedproxies proxy proxy pre code request values table border property remote ip valve remoteipvalve remote ip valve remoteipvalve request remote addr remoteaddr untrusted proxy request header for warded forwarded untrusted proxy proxy request header for warded forwarded proxy table note code for warded forwarded code holds trusted proxy code proxy code code for warded forwarded code holds code code code untrusted proxy code trusted trust code untrusted proxy code actual remote code request remote addr remoteaddr code code untrusted proxy code verified code proxy code remote ip valve remoteipvalve valve base valvebase link pattern comma delimited string support whitespace characters pattern comma separated values pattern commaseparatedvaluespattern pattern compile descriptive implementation string info org apache catalina valves remote ip valve remoteipvalve logger log log log factory logfactory get log getlog remote ip valve remoteipvalve convert comma delimited string array string array string code code string comma delimited list to string array commadelimitedlisttostringarray string comma delimited strings commadelimitedstrings comma delimited strings commadelimitedstrings comma delimited strings commadelimitedstrings length string comma separated values pattern commaseparatedvaluespattern split comma delimited strings commadelimitedstrings convert array strings comma delimited string string list to comma delimited string listtocommadelimitedstring list string string list stringlist string list stringlist string builder stringbuilder result string builder stringbuilder iterator string string list stringlist iterator has next hasnext object element element result append element has next hasnext result append result to string tostring set http server port sethttpserverport http server port httpserverport set https server port sethttpsserverport https server port httpsserverport change local port changelocalport set internal proxies setinternalproxies string pattern internal proxies internalproxies pattern compile set protocol header setprotocolheader string string protocol header protocolheader set protocol header https value setprotocolheaderhttpsvalue string string protocol header https value protocolheaderhttpsvalue https string port header portheader set proxies header setproxiesheader string string proxies header proxiesheader for warded forwarded set remote ip header setremoteipheader string string remote ip header remoteipheader for warded forwarded set request attributes enabled setrequestattributesenabled request attributes enabled requestattributesenabled remote ip valve remoteipvalve set trusted proxies settrustedproxies string pattern trusted proxies trustedproxies constructor ensures link valve base valvebase valve base valvebase called code code remote ip valve remoteipvalve async requests supported valve get https server port gethttpsserverport https server port httpsserverport get http server port gethttpserverport http server port httpserverport is change local port ischangelocalport change local port changelocalport set change local port setchangelocalport change local port changelocalport change local port changelocalport change local port changelocalport http header override returned link request get server port getserverport option ally optionally depending link link is change local port ischangelocalport link request get local port getlocalport http header string get port header getportheader port header portheader http header override returned link request get server port getserverport option ally optionally depending link link is change local port ischangelocalport link request get local port getlocalport param port header portheader http header set port header setportheader string port header portheader port header portheader port header portheader descriptive valve implementation override string get info getinfo info set internal proxies setinternalproxies string regular expression defines internal proxies string get internal proxies getinternalproxies internal proxies internalproxies internal proxies internalproxies to string tostring set protocol header setprotocolheader string protocol header for warded forwarded proto string get protocol header getprotocolheader protocol header protocolheader remote ip valve remoteipvalve set protocol header https value setprotocolheaderhttpsvalue string protocol header incoming https request https string get protocol header https value getprotocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue set proxies header setproxiesheader string proxies header for warded forwarded string get proxies header getproxiesheader proxies header proxiesheader set remote ip header setremoteipheader string remote header for warded forwarded string get remote ip header getremoteipheader remote ip header remoteipheader set request attributes enabled setrequestattributesenabled code code attributes log ged logged code code get request attributes enabled getrequestattributesenabled request attributes enabled requestattributesenabled set trusted proxies settrustedproxies string regular expression defines trusted proxies string get trusted proxies gettrustedproxies trusted proxies trustedproxies trusted proxies trustedproxies to string tostring inherit doc inheritdoc override invoke request request response response i o exception ioexception servlet exception servletexception string original remote addr originalremoteaddr request get remote addr getremoteaddr string original remote host originalremotehost request get remote host getremotehost string original scheme originalscheme request get scheme getscheme original secure originalsecure request is secure issecure original server port originalserverport request get server port getserverport internal proxies internalproxies internal proxies internalproxies matcher original remote addr originalremoteaddr matches string remote ip remoteip java proxies header value proxiesheadervalue declared java util deque linked list linkedlist string proxies header value proxiesheadervalue linked list linkedlist string string builder stringbuilder concat remote ip header value concatremoteipheadervalue string builder stringbuilder enumeration string request get headers getheaders remote ip header remoteipheader has more elements hasmoreelements concat remote ip header value concatremoteipheadervalue length concat remote ip header value concatremoteipheadervalue append concat remote ip header value concatremoteipheadervalue append next element nextelement string remote ip header value remoteipheadervalue comma delimited list to string array commadelimitedlisttostringarray concat remote ip header value concatremoteipheadervalue to string tostring idx loop remote ip header value remoteipheadervalue find trusted remote build proxies chain idx remote ip header value remoteipheadervalue length idx idx string current remote ip currentremoteip remote ip header value remoteipheadervalue idx remote ip remoteip current remote ip currentremoteip internal proxies internalproxies matcher current remote ip currentremoteip matches internal proxies internalproxies i p s ips appended trusted proxies trustedproxies trusted proxies trustedproxies matcher current remote ip currentremoteip matches proxies header value proxiesheadervalue add first addfirst current remote ip currentremoteip decrement idx statement doesn idx loop remote ip header value remoteipheadervalue build remote ip header remoteipheader linked list linkedlist string new remote ip header value newremoteipheadervalue linked list linkedlist string idx idx string current remote ip currentremoteip remote ip header value remoteipheadervalue idx new remote ip header value newremoteipheadervalue add first addfirst current remote ip currentremoteip remote ip remoteip request set remote addr setremoteaddr remote ip remoteip request set remote host setremotehost remote ip remoteip proxies header value proxiesheadervalue size request get coyote request getcoyoterequest get mime headers getmimeheaders remove header removeheader proxies header proxiesheader string comma delimited list of proxies commadelimitedlistofproxies list to comma delimited string listtocommadelimitedstring proxies header value proxiesheadervalue request get coyote request getcoyoterequest get mime headers getmimeheaders set value setvalue proxies header proxiesheader set string setstring comma delimited list of proxies commadelimitedlistofproxies new remote ip header value newremoteipheadervalue size request get coyote request getcoyoterequest get mime headers getmimeheaders remove header removeheader remote ip header remoteipheader string comma delimited remote ip header value commadelimitedremoteipheadervalue list to comma delimited string listtocommadelimitedstring new remote ip header value newremoteipheadervalue request get coyote request getcoyoterequest get mime headers getmimeheaders set value setvalue remote ip header remoteipheader set string setstring comma delimited remote ip header value commadelimitedremoteipheadervalue protocol header protocolheader string protocol header value protocolheadervalue request get header getheader protocol header protocolheader protocol header value protocolheadervalue don modify secure scheme server port serverport attributes request protocol header https value protocolheaderhttpsvalue equals ignore case equalsignorecase protocol header value protocolheadervalue request set secure setsecure request coyote request coyoterequest scheme request set scheme setscheme request set scheme setscheme tomcat request get coyote request getcoyoterequest scheme set string setstring https set ports setports request https server port httpsserverport request set secure setsecure request coyote request coyoterequest scheme request set scheme setscheme request set scheme setscheme tomcat request get coyote request getcoyoterequest scheme set string setstring http set ports setports request http server port httpserverport log is debug enabled isdebugenabled log debug incoming request request getrequesturi original remote addr originalremoteaddr original remote addr originalremoteaddr original remote host originalremotehost original remote host originalremotehost original secure originalsecure original secure originalsecure original scheme originalscheme original scheme originalscheme new remote addr newremoteaddr request get remote addr getremoteaddr new remote host newremotehost request get remote host getremotehost new scheme newscheme request get scheme getscheme new secure newsecure request is secure issecure log is debug enabled isdebugenabled log debug skip remote ip valve remoteipvalve request request getrequesturi original remote addr originalremoteaddr request get remote addr getremoteaddr request attributes enabled requestattributesenabled request set attribute setattribute access log accesslog remote addr attribute request get remote addr getremoteaddr request set attribute setattribute globals remote addr attribute request get remote addr getremoteaddr request set attribute setattribute access log accesslog remote host attribute request get remote host getremotehost request set attribute setattribute access log accesslog protocol attribute request get protocol getprotocol request set attribute setattribute access log accesslog server port attribute integer value of valueof request get server port getserverport get next getnext invoke request response request set remote addr setremoteaddr original remote addr originalremoteaddr request set remote host setremotehost original remote host originalremotehost request set secure setsecure original secure originalsecure request coyote request coyoterequest scheme request set scheme setscheme request set scheme setscheme tomcat request get coyote request getcoyoterequest scheme set string setstring original scheme originalscheme request set server port setserverport original server port originalserverport set ports setports request request default port defaultport port default port defaultport port header portheader string port header value portheadervalue request get header getheader port header portheader port header value portheadervalue port integer parse int parseint port header value portheadervalue number format exception numberformatexception nfe log is debug enabled isdebugenabled log debug get string getstring remote ip valve remoteipvalve invalid port header invalidportheader port header value portheadervalue port header portheader nfe request set server port setserverport port change local port changelocalport request set local port setlocalport port server port link protocol header protocolheader code code http set http server port sethttpserverport http server port httpserverport http server port httpserverport http server port httpserverport server port link protocol header protocolheader https set https server port sethttpsserverport https server port httpsserverport https server port httpsserverport https server port httpsserverport regular expression defines internal proxies set internal proxies setinternalproxies string internal proxies internalproxies internal proxies internalproxies internal proxies internalproxies length internal proxies internalproxies internal proxies internalproxies pattern compile internal proxies internalproxies header holds incoming protocol usally named code for warded forwarded proto code code code request scheme request secure modified code code set protocol header setprotocolheader string protocol header protocolheader protocol header protocolheader protocol header protocolheader insensitive protocol header incoming http request ssl code https code set protocol header https value setprotocolheaderhttpsvalue string protocol header https value protocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue proxies header proxiesheader directive specifies header mod remote ip remoteip collect list int ermediate intermediate client add res ses addresses trusted resolve actual remote note int ermediate intermediate remoteiptrustedproxy add res ses addresses recorded header int ermediate intermediate remoteipinternalproxy add res ses addresses discarded http header holds list trusted proxies traversed http request header comma delimited code for warded forwarded code set proxies header setproxiesheader string proxies header proxiesheader proxies header proxiesheader proxies header proxiesheader http header remote extracted header comma delimited code for warded forwarded code param remote ip header remoteipheader set remote ip header setremoteipheader string remote ip header remoteipheader remote ip header remoteipheader remote ip header remoteipheader valve request attributes address host name hostname protocol port request typically conjunction link access log accesslog log original values code code attributes org apache catalina access log accesslog remote addr remoteaddr org apache catalina access log accesslog remote host remotehost org apache catalina access log accesslog protocol org apache catalina access log accesslog server port serverport org apache tomcat remote addr remoteaddr param request attributes enabled requestattributesenabled code code attributes code code disables setting attributes set request attributes enabled setrequestattributesenabled request attributes enabled requestattributesenabled request attributes enabled requestattributesenabled request attributes enabled requestattributesenabled regular expression defining proxies trusted link remote ip header remoteipheader header empty list external proxy trusted set trusted proxies settrustedproxies string trusted proxies trustedproxies trusted proxies trustedproxies trusted proxies trustedproxies length trusted proxies trustedproxies trusted proxies trustedproxies pattern compile trusted proxies trustedproxies