licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina valves java file java io exception ioexception java util concurrent time unit timeunit javax servlet http http servlet httpservlet javax servlet http http servlet request httpservletrequest javax servlet http http servlet response httpservletresponse org junit org junit org junit test org apache catalina wrapper org apache catalina core standard context standardcontext org apache catalina startup tomcat org apache catalina startup tomcat base test tomcatbasetest org apache tomcat util buf byte chunk bytechunk test stuck thread detection valve teststuckthreaddetectionvalve tomcat base test tomcatbasetest standard context standardcontext context tomcat tomcat override set up setup exception set up setup tomcat get tomcat instance gettomcatinstance file doc base docbase file system get property getproperty java tmp dir tmpdir context standard context standardcontext tomcat add context addcontext doc base docbase get absolute path getabsolutepath test test detection testdetection exception test actual flag startup stucking servlet stuckingservlet stucking servlet stuckingservlet stucking servlet stuckingservlet wrapper servlet tomcat add servlet addservlet context myservlet stucking servlet stuckingservlet servlet add mapping addmapping myservlet stuck thread detection valve stuckthreaddetectionvalve valve stuck thread detection valve stuckthreaddetectionvalve valve set threshold setthreshold context add valve addvalve valve context set background processor delay setbackgroundprocessordelay tomcat start assert equals assertequals valve get stuck thread ids getstuckthreadids length byte chunk bytechunk result byte chunk bytechunk thread async thread asyncthread thread override get url geturl http localhost get port getport myservlet result io exception ioexception print stack trace printstacktrace async thread asyncthread start thread sleep assert equals assertequals valve get stuck thread ids getstuckthreadids length thread sleep assert equals assertequals valve get stuck thread ids getstuckthreadids length async thread asyncthread join check reach join timeout assert false assertfalse async thread asyncthread is alive isalive assert false assertfalse stucking servlet stuckingservlet was interrupted wasinterrupted assert true asserttrue result to string tostring starts with startswith test test interrupt ion testinterruption exception test actual flag startup stucking servlet stuckingservlet stucking servlet stuckingservlet stucking servlet stuckingservlet time unit timeunit seconds to millis tomillis wrapper servlet tomcat add servlet addservlet context myservlet stucking servlet stuckingservlet servlet add mapping addmapping myservlet stuck thread detection valve stuckthreaddetectionvalve valve stuck thread detection valve stuckthreaddetectionvalve valve set threshold setthreshold valve set int err upt thread threshold setinterruptthreadthreshold context add valve addvalve valve context set background processor delay setbackgroundprocessordelay tomcat start assert equals assertequals valve get stuck thread ids getstuckthreadids length byte chunk bytechunk result byte chunk bytechunk thread async thread asyncthread thread override get url geturl http localhost get port getport myservlet result io exception ioexception print stack trace printstacktrace async thread asyncthread start thread sleep assert equals assertequals valve get stuck thread ids getstuckthreadids length async thread asyncthread join check reach join timeout assert false assertfalse async thread asyncthread is alive isalive assert true asserttrue stucking servlet stuckingservlet was interrupted wasinterrupted assert equals assertequals valve get stuck thread ids getstuckthreadids length assert true asserttrue result to string tostring starts with startswith stucking servlet stuckingservlet http servlet httpservlet serialversionuid delay was interrupted wasinterrupted stucking servlet stuckingservlet delay delay delay override do get doget http servlet request httpservletrequest req http servlet response httpservletresponse resp io exception ioexception thread sleep delay interrupted exception interruptedexception was interrupted wasinterrupted resp set content type setcontenttype text plain resp get writer getwriter println