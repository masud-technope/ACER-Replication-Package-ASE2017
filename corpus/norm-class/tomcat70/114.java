licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina loader java io exception ioexception java input stream inputstream java util concurrent executor java util concurrent atomic atomic integer atomicinteger java util logging filter java util logging log manager logmanager java util logging log record logrecord javax servlet http http servlet response httpservletresponse org junit org junit ignore org junit test org apache catalina context org apache catalina core jre memory leak prevention listener jrememoryleakpreventionlistener org apache catalina core standard host standardhost org apache catalina startup tomcat org apache catalina startup tomcat base test tomcatbasetest org apache tomcat util buf byte chunk bytechunk org apache tomcat util threads thread pool executor threadpoolexecutor unit tests rel iable reliable failing reg ularly regularly gump time started fail reg ularly regularly mark t markt laptop problem thread local threadlocal maps occurs wrong point leaking thread local threadlocal cleaned test fail force test pass effectively changing nature test longer tests detection leaks thread locals threadlocals test left place work rel iably reliably systems asf systems bug reported area ignore test webapp class loader thread local memory leak testwebappclassloaderthreadlocalmemoryleak tomcat base test tomcatbasetest test test thread local leak testthreadlocalleak exception tomcat tomcat get tomcat instance gettomcatinstance leak reasons tomcat get server getserver add lifecycle listener addlifecyclelistener jre memory leak prevention listener jrememoryleakpreventionlistener file system doc base docbase required context ctx tomcat add context addcontext tomcat add servlet addservlet ctx leak servlet leakservlet org apache tomcat unit test unittest tester leaking servlet testerleakingservlet ctx add servlet mapping addservletmapping leak leak servlet leakservlet tomcat start executor executor tomcat get connector getconnector get protocol handler getprotocolhandler get executor getexecutor thread pool executor threadpoolexecutor executor set thread renewal delay setthreadrenewaldelay configure logging filter check leak message appears log validation filter logvalidationfilter log validation filter logvalidationfilter web application created thread local threadlocal key log manager logmanager get log manager getlogmanager get logger getlogger org apache catalina loader webapp class loader base webappclassloaderbase set filter setfilter force loading web application classes web application loader load class loadclass tester counter testercounter webapp class loader base webappclassloaderbase ctx get loader getloader get class loader getclassloader load class loadclass tester leaking servlet testerleakingservlet webapp class loader base webappclassloaderbase ctx get loader getloader get class loader getclassloader trigger thread local threadlocal creation get url geturl http localhost get port getport leak byte chunk bytechunk request assert equals assertequals http servlet response httpservletresponse destroy context ctx tomcat get host gethost remove child removechild ctx ctx memory leak string leaks standard host standardhost tomcat get host gethost find reloaded context memory leaks findreloadedcontextmemoryleaks assert not null assertnotnull leaks assert true asserttrue leaks length message log ged logged assert equals assertequals get message count getmessagecount test test thread local leak testthreadlocalleak exception tomcat tomcat get tomcat instance gettomcatinstance leak reasons tomcat get server getserver add lifecycle listener addlifecyclelistener jre memory leak prevention listener jrememoryleakpreventionlistener file system doc base docbase required context ctx tomcat add context addcontext tomcat add servlet addservlet ctx leak servlet leakservlet org apache tomcat unit test unittest tester leaking servlet testerleakingservlet ctx add servlet mapping addservletmapping leak leak servlet leakservlet tomcat start executor executor tomcat get connector getconnector get protocol handler getprotocolhandler get executor getexecutor thread pool executor threadpoolexecutor executor set thread renewal delay setthreadrenewaldelay configure logging filter check leak message appears log validation filter logvalidationfilter log validation filter logvalidationfilter web application created thread local threadlocal key log manager logmanager get log manager getlogmanager get logger getlogger org apache catalina loader webapp class loader base webappclassloaderbase set filter setfilter force loading web application classes web application loader load class loadclass tester counter testercounter webapp class loader base webappclassloaderbase ctx get loader getloader get class loader getclassloader load class loadclass tester thread scope d holder testerthreadscopedholder webapp class loader base webappclassloaderbase ctx get loader getloader get class loader getclassloader load class loadclass tester leaking servlet testerleakingservlet webapp class loader base webappclassloaderbase ctx get loader getloader get class loader getclassloader trigger thread local threadlocal creation get url geturl http localhost get port getport leak byte chunk bytechunk request assert equals assertequals http servlet response httpservletresponse destroy context ctx tomcat get host gethost remove child removechild ctx ctx memory leak string leaks standard host standardhost tomcat get host gethost find reloaded context memory leaks findreloadedcontextmemoryleaks assert not null assertnotnull leaks assert true asserttrue leaks length message log ged logged assert equals assertequals get message count getmessagecount utility method ensure classes loaded webapp class loader webappclassloader create classes loaded current loader webapp class loader webappclassloader leak occurred making test leak point less pointless load bytes current loader define webapp class loader webappclassloader method assumes classes current load class loadclass string webapp class loader base webappclassloaderbase exception input stream inputstream get resource as stream getresourceasstream org apache tomcat unit test unittest roughly big starting point class bytes classbytes offset read read class bytes classbytes offset class bytes classbytes length offset read offset read offset class bytes classbytes length buffer full size tmp class bytes classbytes length system arraycopy class bytes classbytes tmp class bytes classbytes length class bytes classbytes tmp read read class bytes classbytes offset class bytes classbytes length offset lp class lpclass do define class dodefineclass org apache tomcat unit test unittest class bytes classbytes offset get class getclass get protection domain getprotectiondomain create instance object obj lp class lpclass new instance newinstance obj to string tostring close io exception ioexception ioe log validation filter logvalidationfilter filter string target message targetmessage atomic integer atomicinteger message count messagecount atomic integer atomicinteger log validation filter logvalidationfilter string target message targetmessage target message targetmessage target message targetmessage get message count getmessagecount message count messagecount override is log gable isloggable log record logrecord record string msg record get message getmessage msg msg target message targetmessage message count messagecount increment and get incrementandget