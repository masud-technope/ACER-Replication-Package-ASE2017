licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina connector java buffered input stream bufferedinputstream java buffered writer bufferedwriter java file java file input stream fileinputstream java file writer filewriter java io exception ioexception java util arrays java util hash map hashmap java util list java util map javax servlet servlet exception servletexception javax servlet http http servlet httpservlet javax servlet http http servlet request httpservletrequest javax servlet http http servlet response httpservletresponse org junit assert equals assertequals org junit test org apache catalina context org apache catalina globals org apache catalina startup tomcat org apache catalina startup tomcat base test tomcatbasetest org apache tomcat util buf byte chunk bytechunk test send file testsendfile tomcat base test tomcatbasetest iterations expected content length test test send file testsendfile exception tomcat tomcat get tomcat instance gettomcatinstance context root tomcat add context addcontext temp dir file files file iterations iterations files generate file generatefile temp dir expected content length iterations writing servlet writingservlet servlet writing servlet writingservlet files tomcat add servlet addservlet root servlet servlet root add servlet mapping addservletmapping servlet servlet tomcat start byte chunk bytechunk byte chunk bytechunk map string list string resp headers respheaders hash map hashmap string list string iterations start system current time millis currenttimemillis get url geturl http localhost get port getport servlet resp headers respheaders assert equals assertequals http servlet response httpservletresponse system println client received get length getlength bytes system current time millis currenttimemillis start assert equals assertequals expected content length get length getlength recycle file files delete file generate file generatefile string dir string suffix size io exception ioexception string test send file testsendfile system current time millis currenttimemillis suffix txt file file dir file writer filewriter buffered writer bufferedwriter file writer filewriter buffered writer bufferedwriter def size defsize size bytes math min size def size defsize bytes arrays fill write size size bytes flush close close system println created file get absolute path getabsolutepath length bytes writing servlet writingservlet http servlet httpservlet serialversionuid file writing servlet writingservlet file override do get doget http servlet request httpservletrequest req http servlet response httpservletresponse resp servlet exception servletexception io exception ioexception resp set content type setcontenttype application octet stream resp set character encoding setcharacterencoding iso resp set content length setcontentlength length equals req get attribute getattribute globals sendfile supported attr req set attribute setattribute globals sendfile filename attr get absolute path getabsolutepath req set attribute setattribute globals sendfile file start attr req set attribute setattribute globals sendfile file attr length buffered input stream bufferedinputstream buffered input stream bufferedinputstream file input stream fileinputstream len written start system current time millis currenttimemillis len read len resp get output stream getoutputstream write len written len len system println server wrote written bytes system current time millis currenttimemillis start close