licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina loader java file java file output stream fileoutputstream java i o exception ioexception java input stream inputstream java util arrays java util hash set hashset org junit assert equals assertequals org junit assert true asserttrue org junit org junit test org apache catalina core jre memory leak prevention listener jrememoryleakpreventionlistener org apache catalina core standard context standardcontext org apache catalina startup tomcat org apache catalina startup tomcat base test tomcatbasetest org apache naming resources virtual dir context virtualdircontext org apache tomcat util buf byte chunk bytechunk org apache tomcat util http file upload fileupload file utils fileutils org apache tomcat util http file upload fileupload i o utils ioutils org apache tomcat util scan standard jar scanner standardjarscanner test virtual context testvirtualcontext tomcat base test tomcatbasetest override set up setup exception set up setup tomcat tomcat get tomcat instance gettomcatinstance test fails jre memory leak prevention listener jrememoryleakpreventionlistener listener jvm current subsequent tests jvm fair add test tomcat get server getserver add lifecycle listener addlifecyclelistener jre memory leak prevention listener jrememoryleakpreventionlistener test test virtual class loader testvirtualclassloader exception tomcat tomcat get tomcat instance gettomcatinstance file app dir appdir file test webapp virtual webapp src main webapp app dir relative server standard context standardcontext ctx standard context standardcontext tomcat add webapp addwebapp test app dir appdir get absolute path getabsolutepath virtual webapp loader virtualwebapploader loader virtual webapp loader virtualwebapploader ctx get parent class loader getparentclassloader loader set virtual classpath setvirtualclasspath test webapp virtual webapp target classes test webapp virtual library target classes test webapp virtual webapp src main webapp web inf classes test webapp virtual webapp src main webapp web inf classes ctx set loader setloader loader string extra map pings extramappings test webapp virtual webapp src main webapp test webapp virtual webapp src main misc web inf classes test webapp virtual webapp target classes virtual dir context virtualdircontext resources virtual dir context virtualdircontext resources set extra resource paths setextraresourcepaths extra map pings extramappings ctx set resources setresources resources standard jar scanner standardjarscanner jar scanner jarscanner standard jar scanner standardjarscanner jar scanner jarscanner set scan all dir ectories setscanalldirectories ctx set jar scanner setjarscanner jar scanner jarscanner tomcat start assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path none xistent nonexistent resource in web inf classes resourceainwebinfclasses assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path rsrc resource a resourcea properties resource in web inf classes resourceainwebinfclasses assert page contains assertpagecontains test classpath get resource url then get stream classpathgetresourceurlthengetstream jsp path rsrc resource a resourcea properties resource in web inf classes resourceainwebinfclasses assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path rsrc resource b resourceb properties resource in target classes resourcebintargetclasses assert page contains assertpagecontains test classpath get resource url then get stream classpathgetresourceurlthengetstream jsp path rsrc resource b resourceb properties resource in target classes resourcebintargetclasses assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path rsrc resource c resourcec properties resource in dependent library target classes resourcecindependentlibrarytargetclasses assert page contains assertpagecontains test classpath get resource url then get stream classpathgetresourceurlthengetstream jsp path rsrc resource c resourcec properties resource in dependent library target classes resourcecindependentlibrarytargetclasses assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path rsrc resource d resourced properties resource in package d jar in web inf lib resourcedinpackagedjarinwebinflib assert page contains assertpagecontains test classpath get resource url then get stream classpathgetresourceurlthengetstream jsp path rsrc resource d resourced properties resource in package d jar in web inf lib resourcedinpackagedjarinwebinflib assert page contains assertpagecontains test classpath get resource as stream classpathgetresourceasstream jsp path rsrc resource g resourceg properties resource in web inf classes resourceginwebinfclasses assert page contains assertpagecontains test classpath get resource url then get stream classpathgetresourceurlthengetstream jsp path rsrc resource g resourceg properties resource in web inf classes resourceginwebinfclasses test listing paths classpath resource string all urls allurls get url geturl http localhost get port getport test classpath get resources classpathgetresources jsp path rsrc to string tostring assert true asserttrue all urls allurls all urls allurls index of indexof test webapp virtual webapp src main webapp web inf classes rsrc assert true asserttrue all urls allurls all urls allurls index of indexof test webapp virtual webapp src main webapp web inf classes rsrc assert true asserttrue all urls allurls all urls allurls index of indexof test webapp virtual webapp src main webapp web inf lib rsrc jar rsrc assert true asserttrue all urls allurls all urls allurls index of indexof test webapp virtual webapp target classes rsrc assert true asserttrue all urls allurls all urls allurls index of indexof test webapp virtual library target classes rsrc check duplicate url s urls string all urls array allurlsarray all urls allurls split assert equals assertequals hash set hashset string arrays as list aslist all urls array allurlsarray size all urls array allurlsarray length string all rsrsc allrsrsc classpath urls classpathurls get url geturl http localhost get port getport test classpath get resources classpathgetresources jsp path rsrc to string tostring assert true asserttrue all rsrsc allrsrsc classpath urls classpathurls all rsrsc allrsrsc classpath urls classpathurls index of indexof test webapp virtual webapp src main webapp web inf classes rsrc tests context get real path getrealpath fails get real path getrealpath path resource assert page contains assertpagecontains test context get real path contextgetrealpath jsp path none xistent nonexistent resource in web inf classes resourceainwebinfclasses real paths depend test work platforms file convert path platform specific form file file test webapp virtual webapp src main webapp rsrc resource f resourcef properties assert page contains assertpagecontains test context get real path contextgetrealpath jsp path rsrc resource f resourcef properties get path getpath tests context get resource getresource content assert page contains assertpagecontains test context get resource contextgetresource jsp path none xistent nonexistent resource in web inf classes resourceainwebinfclasses assert page contains assertpagecontains test context get resource contextgetresource jsp path web inf classes rsrc resource a resourcea properties resource in web inf classes resourceainwebinfclasses assert page contains assertpagecontains test context get resource contextgetresource jsp path web inf classes rsrc resource g resourceg properties resource in web inf classes resourceginwebinfclasses assert page contains assertpagecontains test context get resource contextgetresource jsp path rsrc resource e resourcee properties resource in dependent library target classes resourceeindependentlibrarytargetclasses assert page contains assertpagecontains test context get resource contextgetresource jsp path resource i resourcei properties resource in webapp resourceiinwebapp assert page contains assertpagecontains test context get resource contextgetresource jsp path rsrc resource j resourcej properties resource in webapp resourcejinwebapp string all rsrc paths allrsrcpaths get url geturl http localhost get port getport test context get resource paths contextgetresourcepaths jsp path rsrc to string tostring assert true asserttrue all rsrc paths allrsrcpaths all rsrc paths allrsrcpaths index of indexof rsrc resource f resourcef properties assert true asserttrue all rsrc paths allrsrcpaths all rsrc paths allrsrcpaths index of indexof rsrc resource e resourcee properties assert true asserttrue all rsrc paths allrsrcpaths all rsrc paths allrsrcpaths index of indexof rsrc resource h resourceh properties check duplicate url s urls string all rsrc paths array allrsrcpathsarray all rsrc paths allrsrcpaths split assert equals assertequals hash set hashset string arrays as list aslist all rsrc paths array allrsrcpathsarray size all rsrc paths array allrsrcpathsarray length string all rsrc allrsrc paths get url geturl http localhost get port getport test context get resource paths contextgetresourcepaths jsp path rsrc to string tostring assert true asserttrue all rsrc allrsrc paths all rsrc allrsrc paths index of indexof rsrc resource j resourcej properties assert page contains assertpagecontains test test tlds testtlds jsp world a worlda assert page contains assertpagecontains test test tlds testtlds jsp world b worldb assert page contains assertpagecontains test test tlds testtlds jsp world c worldc assert page contains assertpagecontains test test tlds testtlds jsp world d worldd test test additional web inf classes paths testadditionalwebinfclassespaths exception tomcat tomcat get tomcat instance gettomcatinstance file app dir appdir file test webapp virtual webapp src main webapp app dir relative server standard context standardcontext ctx standard context standardcontext tomcat add webapp addwebapp test app dir appdir get absolute path getabsolutepath file temp file tempfile file create temp file createtempfile virtual web inf classes virtualwebinfclasses file add ition web inf classes additionwebinfclasses file temp file tempfile get absolute path getabsolutepath dir assert true asserttrue add ition web inf classes additionwebinfclasses mkdirs file target package for annotated class targetpackageforannotatedclass file add ition web inf classes additionwebinfclasses my annotated servlet myannotatedservlet get package getpackage get name getname replace assert true asserttrue target package for annotated class targetpackageforannotatedclass mkdirs input stream inputstream annotated servlet class input stream annotatedservletclassinputstream file output stream fileoutputstream annotated servlet class output stream annotatedservletclassoutputstream annotated servlet class input stream annotatedservletclassinputstream get class getclass get resource as stream getresourceasstream my annotated servlet myannotatedservlet get simple name getsimplename annotated servlet class output stream annotatedservletclassoutputstream file output stream fileoutputstream file target package for annotated class targetpackageforannotatedclass my annotated servlet myannotatedservlet get simple name getsimplename i o utils ioutils copy annotated servlet class input stream annotatedservletclassinputstream annotated servlet class output stream annotatedservletclassoutputstream annotated servlet class input stream annotatedservletclassinputstream annotated servlet class input stream annotatedservletclassinputstream close i o exception ioexception annotated servlet class output stream annotatedservletclassoutputstream annotated servlet class output stream annotatedservletclassoutputstream close i o exception ioexception virtual webapp loader virtualwebapploader loader virtual webapp loader virtualwebapploader ctx get parent class loader getparentclassloader loader set virtual classpath setvirtualclasspath test webapp virtual webapp target classes test webapp virtual library target classes add ition web inf classes additionwebinfclasses get absolute path getabsolutepath ctx set loader setloader loader tomcat start test setting standard context standardcontext annotated servlet detected assert page contains assertpagecontains test annotated servlet annotatedservlet my annotated servlet myannotatedservlet message tomcat test configure standard context standardcontext additional path servlet detected ctx set additional virtual web inf classes setadditionalvirtualwebinfclasses add ition web inf classes additionwebinfclasses get absolute path getabsolutepath virtual dir context virtualdircontext resources virtual dir context virtualdircontext resources set extra resource paths setextraresourcepaths web inf classes add ition web inf classes additionwebinfclasses ctx set resources setresources resources tomcat start assert page contains assertpagecontains test annotated servlet annotatedservlet my annotated servlet myannotatedservlet message tomcat file utils fileutils delete directory deletedirectory add ition web inf classes additionwebinfclasses temp file tempfile delete assert page contains assertpagecontains string page url pageurl string expected body expectedbody i o exception ioexception assert page contains assertpagecontains page url pageurl expected body expectedbody assert page contains assertpagecontains string page url pageurl string expected body expectedbody expected status expectedstatus i o exception ioexception byte chunk bytechunk res byte chunk bytechunk note read timeout asf build bot buildbot consistently failures test failures jsp init ialisation initialisation longer read timeout root frequent poor performance running build bot buildbot instance inc reasing increasing avoid failures get url geturl http localhost get port getport page url pageurl res assert equals assertequals expected status expectedstatus expected status expectedstatus string result res to string tostring assert true asserttrue result result index of indexof expected body expectedbody