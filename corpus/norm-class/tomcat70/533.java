licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache tomcat websocket server java io exception ioexception java util hash set hashset java util java util concurrent count down latch countdownlatch java util concurrent time unit timeunit javax servlet servlet context event servletcontextevent javax websocket close reason closereason javax websocket close reason closereason close code closecode javax websocket close reason closereason close codes closecodes javax websocket deployment exception deploymentexception javax websocket on close onclose javax websocket on error onerror javax websocket on message onmessage javax websocket on open onopen javax websocket session javax websocket server server container servercontainer javax websocket server server endpoint config serverendpointconfig org junit org junit org junit ignore org junit test org apache catalina context org apache catalina lifecycle exception lifecycleexception org apache catalina servlets default servlet defaultservlet org apache catalina startup tomcat org apache juli logging log org apache juli logging log factory logfactory org apache tomcat websocket web socket base test websocketbasetest test behavior closing web sockets websockets conditions test close testclose web socket base test websocketbasetest log log log factory logfactory get log getlog test close testclose simple r simpler inject endpoint events events events block on message onmessage count down latch countdownlatch on message wait onmessagewait count down latch countdownlatch check methods server endpoint called count down latch countdownlatch on error called onerrorcalled count down latch countdownlatch count down latch countdownlatch on message called onmessagecalled count down latch countdownlatch count down latch countdownlatch on close called onclosecalled count down latch countdownlatch parameter on close onclose call close reason closereason close reason closereason parameter on error onerror call throwable on error throwable onerrorthrowable tests on message onmessage send message on message s ends onmessagesends await latch awaitlatch count down latch countdownlatch latch string fail message failmessage latch await time unit timeunit milliseconds fail fail message failmessage interrupted exception interruptedexception runtime exception runtimeexception await on close awaitonclose close code closecode codes close code closecode hash set hashset close code closecode close code closecode code codes add code await on close awaitonclose await on close awaitonclose close code closecode codes await latch awaitlatch events on close called onclosecalled on close onclose called close code closecode received events close reason closereason get close code getclosecode assert true asserttrue received codes received await on error awaitonerror throwable exception clazz exceptionclazz await latch awaitlatch events on error called onerrorcalled on error onerror called assert true asserttrue events on error throwable onerrorthrowable get class getclass get name getname exception clazz exceptionclazz is assignable from isassignablefrom events on error throwable onerrorthrowable get class getclass override set up setup exception set up setup events events test test tcp close testtcpclose exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client close socket closesocket await on close awaitonclose close codes closecodes closed abnormally test test tcp reset testtcpreset exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client force close socket forceclosesocket todo on error onerror called await on error awaitonerror io exception ioexception await on close awaitonclose close codes closecodes closed abnormally test test ws close then tcp close testwsclosethentcpclose exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send close frame sendcloseframe close codes closecodes client close socket closesocket await on close awaitonclose close codes closecodes test test ws close then tcp reset testwsclosethentcpreset exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send close frame sendcloseframe close codes closecodes client force close socket forceclosesocket web socket websocket requires closed abnormally container init iates initiates close close code client client init iates initiates client res ets resets tcp connection sending close operating systems react ways close message drop connection drop connection test handle close codes await on close awaitonclose close codes closecodes closed abnormally close codes closecodes test test tcp close in on message testtcpcloseinonmessage exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send message sendmessage test await latch awaitlatch events on message called onmessagecalled on message onmessage called client close socket closesocket events on message wait onmessagewait count down countdown await on close awaitonclose close codes closecodes closed abnormally test test tcp reset in on message testtcpresetinonmessage exception start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send message sendmessage test await latch awaitlatch events on message called onmessagecalled on message onmessage called client force close socket forceclosesocket events on message wait onmessagewait count down countdown await on error awaitonerror io exception ioexception await on close awaitonclose close codes closecodes closed abnormally test test tcp close when on message s ends testtcpclosewhenonmessagesends exception events on message s ends onmessagesends test tcp close in on message testtcpcloseinonmessage test test tcp reset when on message s ends testtcpresetwhenonmessagesends exception events on message s ends onmessagesends test tcp reset in on message testtcpresetinonmessage test test ws close then tcp close when on message s ends testwsclosethentcpclosewhenonmessagesends exception events on message s ends onmessagesends start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send message sendmessage test await latch awaitlatch events on message called onmessagecalled on message onmessage called client send close frame sendcloseframe close codes closecodes normal closure client close socket closesocket events on message wait onmessagewait count down countdown bio close client sees tcp close await on close awaitonclose close codes closecodes closed abnormally close codes closecodes normal closure test test ws close then tcp reset when on message s ends testwsclosethentcpresetwhenonmessagesends exception events on message s ends onmessagesends start server startserver test endpoint config testendpointconfig tester ws close client testerwscloseclient client tester ws close client testerwscloseclient localhost get port getport client http upgrade httpupgrade base endpoint config baseendpointconfig path client send message sendmessage test await latch awaitlatch events on message called onmessagecalled on message onmessage called client send close frame sendcloseframe close codes closecodes normal closure client force close socket forceclosesocket events on message wait onmessagewait count down countdown apr close client sees tcp reset await on close awaitonclose close codes closecodes closed abnormally close codes closecodes normal closure test endpoint testendpoint on open onopen on open onopen log info session opened on message onmessage on message onmessage session session string message log info message received message events on message called onmessagecalled count down countdown await latch awaitlatch events on message wait onmessagewait on message wait onmessagewait triggered events on message s ends onmessagesends count triggers error count count session get basic remote getbasicremote send text sendtext test reply thread sleep io exception ioexception interrupted exception interruptedexception on error onerror on error onerror throwable log info on error onerror events on error throwable onerrorthrowable events on error called onerrorcalled count down countdown on close onclose on close onclose close reason closereason log info on close onclose events close reason closereason events on close called onclosecalled count down countdown test endpoint config testendpointconfig base endpoint config baseendpointconfig override get endpoint class getendpointclass test endpoint testendpoint tomcat start server startserver ws context listener wscontextlistener config class configclass lifecycle exception lifecycleexception tomcat tomcat get tomcat instance gettomcatinstance file system doc base docbase required context ctx tomcat add context addcontext ctx add application listener addapplicationlistener config class configclass get name getname tomcat add servlet addservlet ctx default servlet defaultservlet ctx add servlet mapping addservletmapping tomcat start tomcat base endpoint config baseendpointconfig ws context listener wscontextlistener string path test get endpoint class getendpointclass override context initialized contextinitialized servlet context event servletcontextevent sce context initialized contextinitialized sce server container servercontainer server container servercontainer sce get servlet context getservletcontext get attribute getattribute constants server container servlet context attribute server endpoint config serverendpointconfig server endpoint config serverendpointconfig builder create get endpoint class getendpointclass path build add endpoint addendpoint deployment exception deploymentexception runtime exception runtimeexception