licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina filters java i o exception ioexception java text date format dateformat java text simple date format simpledateformat java util arrays java util collections java util java util enumeration java util hash map hashmap java util iterator java util linked list linkedlist java util list java util locale java util map java util regex pattern javax servlet filter javax servlet filter chain filterchain javax servlet filter config filterconfig javax servlet servlet exception servletexception javax servlet servlet request servletrequest javax servlet servlet response servletresponse javax servlet http http servlet request httpservletrequest javax servlet http http servlet request wrapper httpservletrequestwrapper javax servlet http http servlet response httpservletresponse org apache catalina access log accesslog org apache catalina globals org apache juli logging log org apache juli logging log factory logfactory servlet filter int egrate integrate for warded forwarded for warded forwarded proto http headers design servlet filter port href http http d httpd apache org docs trunk mod mod remote ip remoteip html mod remote ip remoteip servlet filter replaces app are nt apparent client remote address host name hostname request address list presented proxy load balancer request headers for warded forwarded feature servlet filter replace app are nt apparent scheme http https server port scheme presented proxy load balancer request header for warded forwarded proto servlet filter proc eeds proceeds incoming code request get remote addr getremoteaddr code matches servlet filter list internal proxies loop comma delimited list i p s ips host names hostnames passed preceding load balancer proxy request http header named code remote ip header remoteipheader code code for warded forwarded code values processed left order host list matches internal proxies list host swallowed matches trusted proxies list host created proxies header host declared remote looping stopped request http header named code protocol header protocolheader code code for warded forwarded code equals code protocol header https value protocolheaderhttpsvalue code configuration parameter code https code code request is secure issecure code code request scheme https code code request server port serverport code note overwritten code https server port httpsserverport code configuration parameter strong configuration parameters strong table border x for warded filter xforwardedfilter property description equivalent mod remote ip remoteip directive format remote ip header remoteipheader http header read servlet filter holds list traversed add res ses addresses starting req uesting requesting client remoteipheader compliant http header for warded forwarded internal proxies internalproxies regular expression matches add res ses addresses internal proxies code remote ip header remoteipheader code trusted code proxies header proxiesheader code remoteipinternalproxy regular expression syntax supported link java util regex pattern java util regex allowed enabled complex describe regular expressions proxies header proxiesheader http header created servlet filter hold list proxies processed incoming code remote ip header remoteipheader code remoteipproxiesheader compliant http header for warded forwarded trusted proxies trustedproxies regular expression matches add res ses addresses trusted proxies code remote ip header remoteipheader code trusted code proxies header proxiesheader code remoteiptrustedproxy regular expression syntax supported link java util regex pattern java util regex nbsp protocol header protocolheader http header read servlet filter holds flag request compliant http header code for warded forwarded proto code code for warded forwarded ssl code code front https code code code protocol header https value protocolheaderhttpsvalue code protocol header protocolheader code https request string code https code code code code https code http server port httpserverport returned link servlet request servletrequest get server port getserverport code protocol header protocolheader code code http code protocol int eger integer https server port httpsserverport returned link servlet request servletrequest get server port getserverport code protocol header protocolheader code code https code protocol int eger integer table strong regular expression address blocks strong code mod remote ip remoteip code address blocks code code configure code remoteipinternalproxy code code remoteiptrustedproxy code jvm doesn library href http apr apache org docs apr group apr net work network html apr ipsubnet test rely regular expressions strong sample internal proxies strong x for warded filter xforwardedfilter configuration code pre filter filter remote ip filter remoteipfilter filter filter org apache catalina filters remote ip filter remoteipfilter filter init param param internal proxies internalproxies param param param init param init param param remote ip header remoteipheader param param for warded forwarded param init param init param param remote ip proxies header remoteipproxiesheader param param for warded forwarded param init param init param param protocol header protocolheader param param for warded forwarded proto param init param filter filter mapping filter remote ip filter remoteipfilter filter url pattern url pattern dispatcher request dispatcher filter mapping pre code request values table border property remote ip filter remoteipfilter remote ip filter remoteipfilter request remote addr remoteaddr request header for warded forwarded request header for warded forwarded request header for warded forwarded proto https https request scheme http https request secure request server port serverport table note code for warded forwarded code header internal proxies traversed request code for warded forwarded code proxies trusted internal strong sample trusted proxies strong remote ip filter remoteipfilter configuration code pre filter filter remote ip filter remoteipfilter filter filter org apache catalina filters remote ip filter remoteipfilter filter init param param internal proxies internalproxies param param param init param init param param remote ip header remoteipheader param param for warded forwarded param init param init param param remote ip proxies header remoteipproxiesheader param param for warded forwarded param init param init param param trusted proxies trustedproxies param param proxy proxy param init param filter filter mapping filter remote ip filter remoteipfilter filter url pattern url pattern dispatcher request dispatcher filter mapping pre code request values table border property remote ip filter remoteipfilter remote ip filter remoteipfilter request remote addr remoteaddr request header for warded forwarded proxy proxy request header for warded forwarded proxy proxy table note code proxy code code proxy code trusted proxies code for warded forwarded code header migrated code for warded forwarded code header code for warded forwarded code proxies trusted internal strong sample internal trusted proxies strong remote ip filter remoteipfilter configuration code pre filter filter remote ip filter remoteipfilter filter filter org apache catalina filters remote ip filter remoteipfilter filter init param param internal proxies internalproxies param param param init param init param param remote ip header remoteipheader param param for warded forwarded param init param init param param remote ip proxies header remoteipproxiesheader param param for warded forwarded param init param init param param trusted proxies trustedproxies param param proxy proxy param init param filter filter mapping filter remote ip filter remoteipfilter filter url pattern url pattern dispatcher request dispatcher filter mapping pre code request values table border property remote ip filter remoteipfilter remote ip filter remoteipfilter request remote addr remoteaddr request header for warded forwarded proxy proxy request header for warded forwarded proxy proxy table note code proxy code code proxy code trusted proxies code for warded forwarded code header migrated code for warded forwarded code header code code internal proxy code for warded forwarded code code for warded forwarded code proxies trusted internal strong sample untrusted proxy strong remote ip filter remoteipfilter configuration code pre filter filter remote ip filter remoteipfilter filter filter org apache catalina filters remote ip filter remoteipfilter filter init param param internal proxies internalproxies param param param init param init param param remote ip header remoteipheader param param for warded forwarded param init param init param param remote ip proxies header remoteipproxiesheader param param for warded forwarded param init param init param param trusted proxies trustedproxies param param proxy proxy param init param filter filter mapping filter remote ip filter remoteipfilter filter url pattern url pattern dispatcher request dispatcher filter mapping pre code request values table border property remote ip filter remoteipfilter remote ip filter remoteipfilter request remote addr remoteaddr untrusted proxy request header for warded forwarded untrusted proxy proxy request header for warded forwarded proxy table note code for warded forwarded code holds trusted proxy code proxy code code for warded forwarded code holds code code code untrusted proxy code trusted trust code untrusted proxy code actual remote code request remote addr remoteaddr code code untrusted proxy code verified code proxy code remote ip filter remoteipfilter filter x for warded request xforwardedrequest http servlet request wrapper httpservletrequestwrapper thread local threadlocal simple date format simpledateformat thread local date form ats threadlocaldateformats thread local threadlocal simple date format simpledateformat override simple date format simpledateformat initial value initialvalue simple date format simpledateformat simple date format simpledateformat eee mmm yyyy zzz locale simple date format simpledateformat eee eee eeeeee mmm zzz locale simple date format simpledateformat eee mmm m mmmm yyyy locale map string list string headers local port localport string remote addr remoteaddr string remote host remotehost string scheme secure server port serverport x for warded request xforwardedrequest http servlet request httpservletrequest request request local port localport request get local port getlocalport remote addr remoteaddr request get remote addr getremoteaddr remote host remotehost request get remote host getremotehost scheme request get scheme getscheme secure request is secure issecure server port serverport request get server port getserverport headers hash map hashmap string list string enumeration string header names headernames request get header names getheadernames header names headernames has more elements hasmoreelements string header header names headernames next element nextelement headers header collections list request get headers getheaders header override get date header getdateheader string string get header getheader date format dateformat date form ats dateformats thread local date form ats threadlocaldateformats date form ats dateformats length date format dateformat date format dateformat date form ats dateformats date format dateformat parse exception parse exception parseexception illegal argument exception illegalargumentexception get time gettime override string get header getheader string map entry string list string header get header entry getheaderentry header header get value getvalue header get value getvalue is empty isempty header get value getvalue map entry string list string get header entry getheaderentry string map entry string list string entry headers entry set entryset entry get key getkey equals ignore case equalsignorecase entry override enumeration string get header names getheadernames collections enumeration headers key set keyset override enumeration string get headers getheaders string map entry string list string header get header entry getheaderentry header header get value getvalue collections enumeration collections string empty list emptylist collections enumeration header get value getvalue override get int header getintheader string string get header getheader integer parse int parseint override get local port getlocalport local port localport override string get remote addr getremoteaddr remote addr remoteaddr override string get remote host getremotehost remote host remotehost override string get scheme getscheme scheme override get server port getserverport server port serverport override is secure issecure secure remove header removeheader string map entry string list string header get header entry getheaderentry header headers remove header get key getkey set header setheader string string list string values arrays as list aslist map entry string list string header get header entry getheaderentry header headers values header set value setvalue values set local port setlocalport local port localport local port localport local port localport set remote addr setremoteaddr string remote addr remoteaddr remote addr remoteaddr remote addr remoteaddr set remote host setremotehost string remote host remotehost remote host remotehost remote host remotehost set scheme setscheme string scheme scheme scheme set secure setsecure secure secure secure set server port setserverport server port serverport server port serverport server port serverport override string buffer stringbuffer getrequesturl string buffer stringbuffer url string buffer stringbuffer string scheme get scheme getscheme port get server port getserverport port work java net url bug port url append scheme url append url append get server name getservername scheme equals http port scheme equals https port url append url append port url append getrequesturi url link pattern comma delimited string support whitespace characters pattern comma separated values pattern commaseparatedvaluespattern pattern compile string http server port parameter http server port httpserverport string https server port parameter https server port httpsserverport string internal proxies parameter internal proxies internalproxies logger log log log factory logfactory get log getlog remote ip filter remoteipfilter string protocol header parameter protocol header protocolheader string protocol header https parameter protocol header https value protocolheaderhttpsvalue string port header parameter port header portheader string change local port parameter change local port changelocalport string proxies header parameter proxies header proxiesheader string remote header parameter remote ip header remoteipheader string trusted proxies parameter trusted proxies trustedproxies convert comma delimited list regular expressions array string array patterns code code string comma delimited list to string array commadelimitedlisttostringarray string comma delimited strings commadelimitedstrings comma delimited strings commadelimitedstrings comma delimited strings commadelimitedstrings length string comma separated values pattern commaseparatedvaluespattern split comma delimited strings commadelimitedstrings convert array strings comma delimited string string list to comma delimited string listtocommadelimitedstring list string string list stringlist string list stringlist string builder stringbuilder result string builder stringbuilder iterator string string list stringlist iterator has next hasnext object element element result append element has next hasnext result append result to string tostring set http server port sethttpserverport http server port httpserverport set https server port sethttpsserverport https server port httpsserverport set internal proxies setinternalproxies string pattern internal proxies internalproxies pattern compile set protocol header setprotocolheader string string protocol header protocolheader string protocol header https value protocolheaderhttpsvalue https string port header portheader change local port changelocalport set proxies header setproxiesheader string string proxies header proxiesheader for warded forwarded set remote ip header setremoteipheader string string remote ip header remoteipheader for warded forwarded set request attributes enabled setrequestattributesenabled request attributes enabled requestattributesenabled set trusted proxies settrustedproxies string pattern trusted proxies trustedproxies override destroy noop do filter dofilter http servlet request httpservletrequest request http servlet response httpservletresponse response filter chain filterchain chain i o exception ioexception servlet exception servletexception internal proxies internalproxies internal proxies internalproxies matcher request get remote addr getremoteaddr matches string remote ip remoteip java proxies header value proxiesheadervalue declared java util deque linked list linkedlist string proxies header value proxiesheadervalue linked list linkedlist string string builder stringbuilder concat remote ip header value concatremoteipheadervalue string builder stringbuilder enumeration string request get headers getheaders remote ip header remoteipheader has more elements hasmoreelements concat remote ip header value concatremoteipheadervalue length concat remote ip header value concatremoteipheadervalue append concat remote ip header value concatremoteipheadervalue append next element nextelement string remote ip header value remoteipheadervalue comma delimited list to string array commadelimitedlisttostringarray concat remote ip header value concatremoteipheadervalue to string tostring idx loop remote ip header value remoteipheadervalue find trusted remote build proxies chain idx remote ip header value remoteipheadervalue length idx idx string current remote ip currentremoteip remote ip header value remoteipheadervalue idx remote ip remoteip current remote ip currentremoteip internal proxies internalproxies matcher current remote ip currentremoteip matches internal proxies internalproxies i p s ips appended trusted proxies trustedproxies trusted proxies trustedproxies matcher current remote ip currentremoteip matches proxies header value proxiesheadervalue add first addfirst current remote ip currentremoteip decrement idx statement doesn idx loop remote ip header value remoteipheadervalue build remote ip header remoteipheader linked list linkedlist string new remote ip header value newremoteipheadervalue linked list linkedlist string idx idx string current remote ip currentremoteip remote ip header value remoteipheadervalue idx new remote ip header value newremoteipheadervalue add first addfirst current remote ip currentremoteip x for warded request xforwardedrequest x request xrequest x for warded request xforwardedrequest request remote ip remoteip x request xrequest set remote addr setremoteaddr remote ip remoteip x request xrequest set remote host setremotehost remote ip remoteip proxies header value proxiesheadervalue size x request xrequest remove header removeheader proxies header proxiesheader string comma delimited list of proxies commadelimitedlistofproxies list to comma delimited string listtocommadelimitedstring proxies header value proxiesheadervalue x request xrequest set header setheader proxies header proxiesheader comma delimited list of proxies commadelimitedlistofproxies new remote ip header value newremoteipheadervalue size x request xrequest remove header removeheader remote ip header remoteipheader string comma delimited remote ip header value commadelimitedremoteipheadervalue list to comma delimited string listtocommadelimitedstring new remote ip header value newremoteipheadervalue x request xrequest set header setheader remote ip header remoteipheader comma delimited remote ip header value commadelimitedremoteipheadervalue protocol header protocolheader string protocol header value protocolheadervalue request get header getheader protocol header protocolheader protocol header value protocolheadervalue don modify secure scheme server port serverport attributes request protocol header https value protocolheaderhttpsvalue equals ignore case equalsignorecase protocol header value protocolheadervalue x request xrequest set secure setsecure x request xrequest set scheme setscheme https set ports setports x request xrequest https server port httpsserverport x request xrequest set secure setsecure x request xrequest set scheme setscheme http set ports setports x request xrequest http server port httpserverport log is debug enabled isdebugenabled log debug incoming request request getrequesturi original remote addr originalremoteaddr request get remote addr getremoteaddr original remote host originalremotehost request get remote host getremotehost original secure originalsecure request is secure issecure original scheme originalscheme request get scheme getscheme original remote ip header remoteipheader concat remote ip header value concatremoteipheadervalue original protocol header protocolheader protocol header protocolheader request get header getheader protocol header protocolheader new remote addr newremoteaddr x request xrequest get remote addr getremoteaddr new remote host newremotehost x request xrequest get remote host getremotehost new scheme newscheme x request xrequest get scheme getscheme new secure newsecure x request xrequest is secure issecure remote ip header remoteipheader x request xrequest get header getheader remote ip header remoteipheader proxies header proxiesheader x request xrequest get header getheader proxies header proxiesheader request attributes enabled requestattributesenabled request set attribute setattribute access log accesslog remote addr attribute x request xrequest get remote addr getremoteaddr request set attribute setattribute globals remote addr attribute x request xrequest get remote addr getremoteaddr request set attribute setattribute access log accesslog remote host attribute x request xrequest get remote host getremotehost request set attribute setattribute access log accesslog protocol attribute x request xrequest get protocol getprotocol request set attribute setattribute access log accesslog server port attribute integer value of valueof x request xrequest get server port getserverport chain do filter dofilter x request xrequest response log is debug enabled isdebugenabled log debug skip remote ip filter remoteipfilter request request getrequesturi original remote addr originalremoteaddr request get remote addr getremoteaddr chain do filter dofilter request response set ports setports x for warded request xforwardedrequest xrequest default port defaultport port default port defaultport get port header getportheader string port header value portheadervalue xrequest get header getheader get port header getportheader port header value portheadervalue port integer parse int parseint port header value portheadervalue number format exception numberformatexception nfe log debug invalid port port header value portheadervalue header get port header getportheader xrequest set server port setserverport port is change local port ischangelocalport xrequest set local port setlocalport port wrap incoming code request code link x for warded request xforwardedrequest http header code for war eded forwareded code empty override do filter dofilter servlet request servletrequest request servlet response servletresponse response filter chain filterchain chain i o exception ioexception servlet exception servletexception request http servlet request httpservletrequest response http servlet response httpservletresponse do filter dofilter http servlet request httpservletrequest request http servlet response httpservletresponse response chain chain do filter dofilter request response is change local port ischangelocalport change local port changelocalport get https server port gethttpsserverport https server port httpsserverport pattern get internal proxies getinternalproxies internal proxies internalproxies string get protocol header getprotocolheader protocol header protocolheader string get port header getportheader port header portheader string get protocol header https value getprotocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue string get proxies header getproxiesheader proxies header proxiesheader string get remote ip header getremoteipheader remote ip header remoteipheader set request attributes enabled setrequestattributesenabled code code attributes log ged logged code code get request attributes enabled getrequestattributesenabled request attributes enabled requestattributesenabled pattern get trusted proxies gettrustedproxies trusted proxies trustedproxies override init filter config filterconfig filter config filterconfig servlet exception servletexception filter config filterconfig get init parameter getinitparameter internal proxies parameter set internal proxies setinternalproxies filter config filterconfig get init parameter getinitparameter internal proxies parameter filter config filterconfig get init parameter getinitparameter protocol header parameter set protocol header setprotocolheader filter config filterconfig get init parameter getinitparameter protocol header parameter filter config filterconfig get init parameter getinitparameter protocol header https parameter set protocol header https value setprotocolheaderhttpsvalue filter config filterconfig get init parameter getinitparameter protocol header https parameter filter config filterconfig get init parameter getinitparameter port header parameter set port header setportheader filter config filterconfig get init parameter getinitparameter port header parameter filter config filterconfig get init parameter getinitparameter change local port parameter set change local port setchangelocalport parse boolean parseboolean filter config filterconfig get init parameter getinitparameter change local port parameter filter config filterconfig get init parameter getinitparameter proxies header parameter set proxies header setproxiesheader filter config filterconfig get init parameter getinitparameter proxies header parameter filter config filterconfig get init parameter getinitparameter remote header parameter set remote ip header setremoteipheader filter config filterconfig get init parameter getinitparameter remote header parameter filter config filterconfig get init parameter getinitparameter trusted proxies parameter set trusted proxies settrustedproxies filter config filterconfig get init parameter getinitparameter trusted proxies parameter filter config filterconfig get init parameter getinitparameter http server port parameter set http server port sethttpserverport integer parse int parseint filter config filterconfig get init parameter getinitparameter http server port parameter number format exception numberformatexception number format exception numberformatexception illegal http server port parameter get message getmessage filter config filterconfig get init parameter getinitparameter https server port parameter set https server port sethttpsserverport integer parse int parseint filter config filterconfig get init parameter getinitparameter https server port parameter number format exception numberformatexception number format exception numberformatexception illegal https server port parameter get message getmessage code code values link servlet request servletrequest get local port getlocalport link servlet request servletrequest get server port getserverport wil modified filter link servlet request servletrequest get server port getserverport code code set change local port setchangelocalport change local port changelocalport change local port changelocalport change local port changelocalport server port link protocol header protocolheader http link protocol header protocolheader link protocol header https value protocolheaderhttpsvalue set http server port sethttpserverport http server port httpserverport http server port httpserverport http server port httpserverport server port link protocol header protocolheader https set https server port sethttpsserverport https server port httpsserverport https server port httpsserverport https server port httpsserverport regular expression defines internal proxies set internal proxies setinternalproxies string internal proxies internalproxies internal proxies internalproxies internal proxies internalproxies length internal proxies internalproxies internal proxies internalproxies pattern compile internal proxies internalproxies header holds incoming port usally named code for warded forwarded port code code code link http server port httpserverport link https server port httpsserverport code code set port header setportheader string port header portheader port header portheader port header portheader header holds incoming protocol usally named code for warded forwarded proto code code code request scheme request secure modified code code set protocol header setprotocolheader string protocol header protocolheader protocol header protocolheader protocol header protocolheader insensitive protocol header incoming http request https code https code set protocol header https value setprotocolheaderhttpsvalue string protocol header https value protocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue protocol header https value protocolheaderhttpsvalue proxies header proxiesheader directive specifies header mod remote ip remoteip collect list int ermediate intermediate client add res ses addresses trusted resolve actual remote note int ermediate intermediate remoteiptrustedproxy add res ses addresses recorded header int ermediate intermediate remoteipinternalproxy add res ses addresses discarded http header holds list trusted proxies traversed http request header comma delimited code for warded forwarded code set proxies header setproxiesheader string proxies header proxiesheader proxies header proxiesheader proxies header proxiesheader http header remote extracted header comma delimited code for warded forwarded code set remote ip header setremoteipheader string remote ip header remoteipheader remote ip header remoteipheader remote ip header remoteipheader filter request attributes address host name hostname protocol port request typically conjunction link access log accesslog log original values code code attributes org apache catalina access log accesslog remote addr remoteaddr org apache catalina access log accesslog remote host remotehost org apache catalina access log accesslog protocol org apache catalina access log accesslog server port serverport org apache tomcat remote addr remoteaddr param request attributes enabled requestattributesenabled code code attributes code code disables setting attributes set request attributes enabled setrequestattributesenabled request attributes enabled requestattributesenabled request attributes enabled requestattributesenabled request attributes enabled requestattributesenabled regular expression defining proxies trusted link remote ip header remoteipheader header empty list external proxy trusted set trusted proxies settrustedproxies string trusted proxies trustedproxies trusted proxies trustedproxies trusted proxies trustedproxies length trusted proxies trustedproxies trusted proxies trustedproxies pattern compile trusted proxies trustedproxies