licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache catalina valves java io exception ioexception java util array list arraylist java util java util list java util map java util queue java util concurrent concurrent hash map concurrenthashmap java util concurrent concurrent linked queue concurrentlinkedqueue java util concurrent semaphore java util concurrent atomic atomic integer atomicinteger java util concurrent atomic atomic long atomiclong javax servlet servlet exception servletexception org apache catalina lifecycle exception lifecycleexception org apache catalina connector request org apache catalina connector response org apache juli logging log org apache juli logging log factory logfactory org apache tomcat util res string manager stringmanager valve detect requests time process thread processing stuck stuck thread detection valve stuckthreaddetectionvalve valve base valvebase descriptive implementation string info org apache catalina valves stuck thread detection valve stuckthreaddetectionvalve logger log log log factory logfactory get log getlog stuck thread detection valve stuckthreaddetectionvalve string manager string manager stringmanager string manager stringmanager get manager getmanager constants count number stuck threads detected atomic integer atomicinteger stuck count stuckcount atomic integer atomicinteger count number stuck threads int err uoted interruoted atomic long atomiclong int errupted threads count interruptedthreadscount atomic long atomiclong seconds min utes minutes threshold seconds disable int erruption interruption int errupt thread threshold interruptthreadthreshold references actual running thread objects map automatically cleaned invoke clause threads event hough eventhough valve thinks stuck caused monitor int erval interval map monitored thread monitoredthread active threads activethreads concurrent hash map concurrenthashmap monitored thread monitoredthread queue completed stuck thread completedstuckthread completed stuck threads queue completedstuckthreadsqueue concurrent linked queue concurrentlinkedqueue completed stuck thread completedstuckthread specifies threshold seconds checking stuck threads detection disabled seconds param threshold threshold seconds set threshold setthreshold threshold threshold threshold set threshold setthreshold current threshold seconds get threshold getthreshold threshold get int err upt thread threshold getinterruptthreadthreshold int errupt thread threshold interruptthreadthreshold specifies threshold seconds stuck threads int errupted interrupted int erruption interruption disabled threshold param int errupt thread threshold interruptthreadthreshold thread int erruption interruption threshold seconds set int err upt thread threshold setinterruptthreadthreshold int errupt thread threshold interruptthreadthreshold int errupt thread threshold interruptthreadthreshold int errupt thread threshold interruptthreadthreshold required enable async support stuck thread detection valve stuckthreaddetectionvalve override init internal initinternal lifecycle exception lifecycleexception init internal initinternal log is debug enabled isdebugenabled log debug monitoring stuck threads threshold threshold descriptive valve implementation override string get info getinfo info notify stuck thread detected notifystuckthreaddetected monitored thread monitoredthread monitored thread monitoredthread active time activetime num stuck threads numstuckthreads log is warn enabled iswarnenabled string msg get string getstring stuck thread detection valve stuckthreaddetectionvalve notify stuck thread detected notifystuckthreaddetected monitored thread monitoredthread get thread getthread get name getname value of valueof active time activetime monitored thread monitoredthread get start time getstarttime integer value of valueof num stuck threads numstuckthreads monitored thread monitoredthread get request uri getrequesturi integer value of valueof threshold string value of valueof monitored thread monitoredthread get thread getthread get id getid msg get stack trace as string getstacktraceasstring trace throwable throwable set stack trace setstacktrace monitored thread monitoredthread get thread getthread get stack trace getstacktrace log warn msg notify stuck thread completed notifystuckthreadcompleted completed stuck thread completedstuckthread thread num stuck threads numstuckthreads log is warn enabled iswarnenabled string msg get string getstring stuck thread detection valve stuckthreaddetectionvalve notify stuck thread completed notifystuckthreadcompleted thread get name getname value of valueof thread get total active time gettotalactivetime integer value of valueof num stuck threads numstuckthreads string value of valueof thread get id getid stuck thread not ification notification warn warn log warn msg inherit doc inheritdoc override invoke request request response response io exception ioexception servlet exception servletexception threshold circuit monitoring stuck threads get next getnext invoke request response save thread runnable keeping reference thread object prevent ing reference removed map clause key value of valueof thread current thread currentthread get id getid string buffer stringbuffer request url requesturl request getrequesturl request get query string getquerystring request url requesturl append request url requesturl append request get query string getquerystring monitored thread monitoredthread monitored thread monitoredthread monitored thread monitoredthread thread current thread currentthread request url requesturl to string tostring int errupt thread threshold interruptthreadthreshold active threads activethreads key monitored thread monitoredthread get next getnext invoke request response active threads activethreads remove key monitored thread monitoredthread mark as done markasdone monitored thread state monitoredthreadstate stuck monitored thread monitoredthread was interrupted wasinterrupted int errupted threads count interruptedthreadscount increment and get incrementandget completed stuck threads queue completedstuckthreadsqueue add completed stuck thread completedstuckthread monitored thread monitoredthread get thread getthread monitored thread monitoredthread get active time in millis getactivetimeinmillis override background process backgroundprocess background process backgroundprocess threshold in millis thresholdinmillis threshold completed time examine monitored thread monitoredthread monitored thread monitoredthread active threads activethreads values active time activetime monitored thread monitoredthread get active time in millis getactivetimeinmillis active time activetime threshold in millis thresholdinmillis monitored thread monitoredthread mark as stuck if still running markasstuckifstillrunning num stuck threads numstuckthreads stuck count stuckcount increment and get incrementandget notify stuck thread detected notifystuckthreaddetected monitored thread monitoredthread active time activetime num stuck threads numstuckthreads int errupt thread threshold interruptthreadthreshold active time activetime int errupt thread threshold interruptthreadthreshold monitored thread monitoredthread int errupt if stuck interruptifstuck int errupt thread threshold interruptthreadthreshold check threads reported stuck finished completed stuck thread completedstuckthread completed stuck thread completedstuckthread completed stuck threads queue completedstuckthreadsqueue poll completed stuck thread completedstuckthread completed stuck thread completedstuckthread completed stuck threads queue completedstuckthreadsqueue poll num stuck threads numstuckthreads stuck count stuckcount decrement and get decrementandget notify stuck thread completed notifystuckthreadcompleted completed stuck thread completedstuckthread num stuck threads numstuckthreads get stuck thread count getstuckthreadcount stuck count stuckcount get stuck thread ids getstuckthreadids list id list idlist array list arraylist monitored thread monitoredthread monitored thread monitoredthread active threads activethreads values monitored thread monitoredthread is marked as stuck ismarkedasstuck id list idlist add value of valueof monitored thread monitoredthread get thread getthread get id getid result id list idlist size result length result id list idlist long value longvalue result string get stuck thread names getstuckthreadnames list string name list namelist array list arraylist string monitored thread monitoredthread monitored thread monitoredthread active threads activethreads values monitored thread monitoredthread is marked as stuck ismarkedasstuck name list namelist add monitored thread monitoredthread get thread getthread get name getname name list namelist to array toarray string name list namelist size get interrupted threads count getinterruptedthreadscount int errupted threads count interruptedthreadscount monitored thread monitoredthread reference thread stack trace background task thread thread string request uri requesturi start atomic integer atomicinteger atomic integer atomicinteger monitored thread state monitoredthreadstate running ordinal semaphore synchronize stuck thread background process thread int erruption interruption feature active semaphore int erruption semaphore interruptionsemaphore thread int errupted interrupted accessed acquiring semaphore int errupted interrupted monitored thread monitoredthread thread thread string request uri requesturi int err uptible interruptible thread thread request uri requesturi request uri requesturi start system current time millis currenttimemillis int err uptible interruptible int erruption semaphore interruptionsemaphore semaphore int erruption semaphore interruptionsemaphore thread get thread getthread thread string get request uri getrequesturi request uri requesturi get active time in millis getactivetimeinmillis system current time millis currenttimemillis start get start time getstarttime start mark as stuck if still running markasstuckifstillrunning compare and set compareandset monitored thread state monitoredthreadstate running ordinal monitored thread state monitoredthreadstate stuck ordinal monitored thread state monitoredthreadstate mark as done markasdone val get and set getandset monitored thread state monitoredthreadstate ordinal monitored thread state monitoredthreadstate thread state threadstate monitored thread state monitoredthreadstate values val thread state threadstate monitored thread state monitoredthreadstate stuck int erruption semaphore interruptionsemaphore semaphore synchronize background thread int errupt interrupt current thread current thread int errupted interrupted serving request int erruption semaphore interruptionsemaphore acquire interrupted exception interruptedexception log debug thread int errupted interrupted request finished ignoring release semaphore gc ed gced sync agains semaphore thread state threadstate is marked as stuck ismarkedasstuck monitored thread state monitoredthreadstate stuck ordinal int errupt if stuck interruptifstuck int errupt thread threshold interruptthreadthreshold is marked as stuck ismarkedasstuck int erruption semaphore interruptionsemaphore int erruption semaphore interruptionsemaphore try acquire tryacquire request thread unstuck int errupted interrupted log is warn enabled iswarnenabled string msg get string getstring stuck thread detection valve stuckthreaddetectionvalve notify stuck thread interrupted notifystuckthreadinterrupted get thread getthread get name getname value of valueof get active time in millis getactivetimeinmillis get start time getstarttime get request uri getrequesturi value of valueof int errupt thread threshold interruptthreadthreshold string value of valueof get thread getthread get id getid throwable throwable set stack trace setstacktrace get thread getthread get stack trace getstacktrace log warn msg thread int errupt interrupt int errupted interrupted int erruption semaphore interruptionsemaphore release was interrupted wasinterrupted int errupted interrupted completed stuck thread completedstuckthread string thread name threadname thread id threadid total active time totalactivetime completed stuck thread completedstuckthread thread thread total active time totalactivetime thread name threadname thread get name getname thread id threadid thread get id getid total active time totalactivetime total active time totalactivetime string get name getname thread name threadname get id getid thread id threadid get total active time gettotalactivetime total active time totalactivetime enum monitored thread state monitoredthreadstate running stuck