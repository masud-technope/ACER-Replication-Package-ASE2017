licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache log java util hashtable java util stack java util enumeration java util vector org apache log helpers log log loglog ndc keyword dangerous multiple threads threads share hashtable variable java hash tables hashtables thread safe stacks import antly importantly inheriting diagnostic contexts child thread handed clone parent ndc thread ndc stack hashtable hashtable number times push called push counter pushcounter latest call lazy remove lazyremove number times push called call lazy remove lazyremove small number lazy remove lazyremove called frequently avoid cost creating enumeration higher number longer avarage period logging calls threads blocked reap threshold instances allowed ndc ndc stack current thread ndc stack current thread stack get current stack getcurrentstack stack thread current thread currentthread clear nested diagnostic method cases thread unrelated contexts method equivalent calling link set max depth setmaxdepth method code max depth maxdepth code argument clear stack stack get current stack getcurrentstack stack stack set size setsize clone diagnostic context current thread int ernally internally diagnostic context represented stack thread supply stack diagnostic context child thread child inherit parent thread diagnostic context child thread link inherit inherit method inherit parent diagnostic context stack clone current thread diagnostic context stack clone stack clonestack stack stack get current stack getcurrentstack stack stack stack clone inherit diagnostic context thread parent thread reference diagnostic context link clone stack clonestack method communicate child inherit parent diagnostic context parent diagnostic context clone d cloned inherited inherited diagnostic contexts managed independently java child thread reference parent handed reference client tra nsparent transparent inheriting diagnostic contexts solution problem param stack diagnostic context parent thread inherit stack stack stack thread current thread currentthread stack font color method link org apache log spi logging event loggingevent getndc method font string stack get current stack getcurrentstack is empty isempty diagnostic context diagnosticcontext peek full message fullmessage current nesting depth diagnostic context set max depth setmaxdepth get depth getdepth stack stack get current stack getcurrentstack stack stack size lazy remove lazyremove synchronization prevent jdk throwing concurrent modification exceptions concurrentmodificationexceptions sucks big time solution write hashtable implementation vector avoid calling clean push counter pushcounter reap threshold release lock asap work push counter pushcounter misses vector enumeration enumeration chances removal enumeration has more elements hasmoreelements misses thread thread enumeration next element nextelement is alive isalive misses misses add element addelement size size size thread thread element at elementat log log loglog debug lazy ndc removal thread get name getname size remove clients call method leaving diagnostic context returned pushed context empty string returned string inner most innermost diagnostic context string pop stack stack get current stack getcurrentstack stack stack is empty isempty diagnostic context diagnosticcontext stack pop message diagnostic context top ndc removing returned pushed context empty string returned string inner most innermost diagnostic context string peek stack stack get current stack getcurrentstack stack stack is empty isempty diagnostic context diagnosticcontext stack peek message push diagnostic context current thread contents code message code parameter determined solely client param message diagnostic context push string message stack stack get current stack getcurrentstack stack diagnostic context diagnosticcontext diagnostic context diagnosticcontext message stack stack thread key thread current thread currentthread key stack stack push stack is empty isempty diagnostic context diagnosticcontext diagnostic context diagnosticcontext message stack push diagnostic context diagnosticcontext parent diagnostic context diagnosticcontext stack peek stack push diagnostic context diagnosticcontext message parent remove diagnostic context thread thread created diagnostic context calling link push call method exiting memory thread rec laimed reclaimed problem heavy duty systems diff icu lt difficult guarantee remove method called exiting thread method augmented lazily remove references dead threads practice sloppy occasionally for get forget call link remove exiting thread call code remove code call application memory remove remove thread current thread currentthread lazily remove dead thread references lazy remove lazyremove maximum depth diagnostic context current depth smaller equal code max depth maxdepth code action method convenient alternative multiple link pop calls complex call sequences depth ndc unpredictable code set max depth setmaxdepth code method circumvents problem combination pre foo nbsp depth ndc get depth getdepth nbsp complex sequence calls nbsp ndc set max depth setmaxdepth depth pre ensures entry exit foo depth diagnostic stack cons erved conserved get depth getdepth set max depth setmaxdepth max depth maxdepth stack stack get current stack getcurrentstack stack max depth maxdepth stack size stack set size setsize max depth maxdepth diagnostic context diagnosticcontext string full message fullmessage string message diagnostic context diagnosticcontext string message diagnostic context diagnosticcontext parent message message parent full message fullmessage parent full message fullmessage message full message fullmessage message