licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery impl common heartbeat java util calendar java util java util iterator java util list java util java util uuid javax jcr session org apache felix scr annotations component org apache felix scr annotations reference org apache felix scr annotations reference cardinality referencecardinality org apache felix scr annotations reference policy referencepolicy org apache felix scr annotations service org apache sling api resource login exception loginexception org apache sling api resource modifiable value map modifiablevaluemap org apache sling api resource persistence exception persistenceexception org apache sling api resource resource org apache sling api resource resource resolver resourceresolver org apache sling api resource resource resolver factory resourceresolverfactory org apache sling commons scheduler scheduler org apache sling discovery base commons base view checker baseviewchecker org apache sling discovery base commons periodic background job periodicbackgroundjob org apache sling discovery base connectors base config baseconfig org apache sling discovery base connectors announcement announcement registry announcementregistry org apache sling discovery base connectors ping connector registry connectorregistry org apache sling discovery commons providers util resource helper resourcehelper org apache sling discovery impl config org apache sling discovery impl discovery service impl discoveryserviceimpl org apache sling discovery impl cluster voting voting handler votinghandler org apache sling discovery impl cluster voting voting helper votinghelper org apache sling discovery impl cluster voting voting view votingview org apache sling discovery impl common view org apache sling discovery impl common view helper viewhelper org apache sling launchpad api startup listener startuplistener org apache sling settings sling settings service slingsettingsservice org osgi framework bundle exception bundleexception org osgi service http http service httpservice heartbeat handler responsible capable issuing local remote heartbeats registers periodic job scheduler local heartbeats stored repository remote heartbeats post s posts remote topology connector servlets topologyconnectorservlets component service heartbeat handler heartbeathandler startup listener startuplistener reference reference interface referenceinterface http service httpservice cardinality reference cardinality referencecardinality optional multiple policy reference policy referencepolicy dynamic heartbeat handler heartbeathandler base view checker baseviewchecker string property heartbeat last heartbeat lastheartbeat reference sling settings service slingsettingsservice sling settings service slingsettingsservice reference resource resolver factory resourceresolverfactory resource resolver factory resourceresolverfactory reference connector registry connectorregistry connector registry connectorregistry reference announcement registry announcementregistry announcement registry announcementregistry reference scheduler scheduler reference config config reference voting handler votinghandler voting handler votinghandler voting string next voting id nextvotingid uuid randomuuid to string tostring reset leader election id leaderelectionid heartbeat time reset leader election id resetleaderelectionid sling reset leader election id resetleaderelectionid new leader election id newleaderelectionid calculated passed voting handler votinghandler actual storing cluster instances clusterinstances heartbeats field temp orarily temporarily store leader election id leaderelectionid heartbeat stores string new leader election id newleaderelectionid sling remember heartbeat written repository instance first heartbeat written firstheartbeatwritten sling remember heartbeat instance written time calendar last heartbeat written lastheartbeatwritten discovery service impl discoveryserviceimpl discovery service impl discoveryserviceimpl string last established view id lastestablishedviewid string failed established view id failedestablishedviewid periodic background job periodicbackgroundjob periodic check job periodiccheckjob testing heartbeat handler heartbeathandler test constructor testconstructor sling settings service slingsettingsservice sling settings service slingsettingsservice resource resolver factory resourceresolverfactory factory announcement registry announcementregistry announcement registry announcementregistry connector registry connectorregistry connector registry connectorregistry config config scheduler scheduler voting handler votinghandler voting handler votinghandler heartbeat handler heartbeathandler handler heartbeat handler heartbeathandler handler sling settings service slingsettingsservice sling settings service slingsettingsservice handler resource resolver factory resourceresolverfactory factory handler announcement registry announcementregistry announcement registry announcementregistry handler connector registry connectorregistry connector registry connectorregistry handler config config handler scheduler scheduler handler voting handler votinghandler voting handler votinghandler handler override announcement registry announcementregistry get announcement registry getannouncementregistry announcement registry announcementregistry override base config baseconfig get connector config getconnectorconfig config override connector registry connectorregistry get connector registry getconnectorregistry connector registry connectorregistry override resource resolver factory resourceresolverfactory get resource resolver factory getresourceresolverfactory resource resolver factory resourceresolverfactory override scheduler get scheduler getscheduler scheduler override sling settings service slingsettingsservice get sling settings service getslingsettingsservice sling settings service slingsettingsservice override do activate doactivate activate reset leader election id resetleaderelectionid ensure leader election id leaderelectionid property reset heartbeat iss uance issuance idea node leaves cluster leader join reset ting resetting leader election id leaderelectionid current time ensure d ensured reset leader election id resetleaderelectionid runtime id runtimeid uuid randomuuid to string tostring sling reset variables avoid unnecessary log error first heartbeat written firstheartbeatwritten last heartbeat written lastheartbeatwritten logger info do activate doactivate activated runtime id runtimeid sling id slingid runtime id runtimeid sling id slingid override deactivate deactivate periodic check job periodiccheckjob periodic check job periodiccheckjob periodic check job periodiccheckjob initialize method called discovery service impl discoveryserviceimpl activate require discovery service discoveryservice discovery service discoveryservice reference circular references osgi initial voting id initialvotingid avoid unnecessary topology changed topologychanged event starting instance node cluster instance wait voting finished send topology init event api method get topology gettopology open asks topology voting node cluster cluster id clusterid aim reuse voting initialize discovery service impl discoveryserviceimpl discovery service discoveryservice string initial voting id initialvotingid lock discovery service impl discoveryserviceimpl discovery service discoveryservice next voting id nextvotingid initial voting id initialvotingid logger info initialize next voting id nextvotingid next voting id nextvotingid issue heartbeat issueheartbeat int erval interval config get heartbeat interval getheartbeatinterval logger info initialize starting periodic heartbeat job sling id slingid int erval interval int erval interval int erval interval logger warn initialize repeat int erval interval def aulting defaulting int erval interval periodic ping job periodicpingjob periodic background job periodicbackgroundjob int erval interval exception logger error activate start heartbeat runner addition ally additionally runner int erval interval config get heartbeat interval getheartbeatinterval heartbeat timeout millis heartbeattimeoutmillis config get heartbeat timeout millis getheartbeattimeoutmillis heartbeat interval millis heartbeatintervalmillis config get heartbeat interval getheartbeatinterval max millis since hb maxmillissincehb math max math min heartbeat timeout millis heartbeattimeoutmillis heartbeat interval millis heartbeatintervalmillis heartbeat timeout millis heartbeattimeoutmillis heartbeat interval millis heartbeatintervalmillis logger info initialize starting periodic check for local cluster view change checkforlocalclusterviewchange job sling id slingid max millis since hb maxmillissincehb max millis since hb maxmillissincehb int erval interval int erval interval int erval interval logger warn initialize repeat int erval interval def aulting defaulting int erval interval periodic check job periodiccheckjob periodic background job periodicbackgroundjob int erval interval check for local cluster view change checkforlocalclusterviewchange runnable override calendar last hb lasthb last heartbeat written lastheartbeatwritten last hb lasthb check wrote heartbeat older configured timeout mark topology changing topologychanging automatically time since hb timesincehb system current time millis currenttimemillis last hb lasthb get time in millis gettimeinmillis sling add safety margin sling time since hb timesincehb max millis since hb maxmillissincehb logger warn check for local cluster view change checkforlocalclusterviewchange time local instance wrote heartbeat time since hb timesincehb heartbeat timeout millis heartbeattimeoutmillis heartbeat timeout millis heartbeattimeoutmillis heartbeat interval millis heartbeatintervalmillis heartbeat interval millis heartbeatintervalmillis max millis since hb maxmillissincehb max millis since hb maxmillissincehb flag ging flagging changing mark current established view establishedview faulty invalidate current established view invalidatecurrentestablishedview listeners not e note calling handle topology changing handletopologychanging invalidate won sufficient affect listeners get topology gettopology call discovery service discoveryservice handle topology changing handletopologychanging sling guarantee frequent calls check for local cluster view change checkforlocalclusterviewchange independently blocked write save operations logger debug check for local cluster view change checkforlocalclusterviewchange check topology change discovery service discoveryservice check for local cluster view change checkforlocalclusterviewchange logger debug check for local cluster view change checkforlocalclusterviewchange check topology change exception logger error activate start heartbeat runner create resource resolver resourceresolver resource resolver resourceresolver get resource resolver getresourceresolver login exception loginexception resource resolver factory resourceresolverfactory logger error get resource resolver getresourceresolver resource resolver factory resourceresolverfactory resource resolver factory resourceresolverfactory get administrative resource resolver getadministrativeresourceresolver calcualte local cluster instance path string get local cluster node path getlocalclusternodepath config get cluster instances path getclusterinstancespath sling id slingid hook reset leader election id leaderelectionid invocation issue cluster local heartbeat issueclusterlocalheartbeat leader election id leaderelectionid reset happened earlier prop agated propagated cluster instances clusterinstances reset leader election id resetleaderelectionid reset leader election id resetleaderelectionid reset ting resetting doesn work reset leader election id resetleaderelectionid resource resolver resourceresolver resource resolver resourceresolver resource resolver resourceresolver get resource resolver getresourceresolver resource resolver resourceresolver new leader election id newleaderelectionid new leader election id newleaderelectionid resource resolver resourceresolver voting handler votinghandler logger info reset leader election id resetleaderelectionid leader election id leaderelectionid voting handler votinghandler new leader election id newleaderelectionid voting handler votinghandler set leader election id setleaderelectionid new leader election id newleaderelectionid logger info reset leader election id resetleaderelectionid voting handler votinghandler leader election id leaderelectionid new leader election id newleaderelectionid logger warn reset leader election id resetleaderelectionid login leader election id leaderelectionid calculated heartbeat login exception loginexception logger error reset leader election id resetleaderelectionid login resource resolver resourceresolver resource resolver resourceresolver close issue heartbeat action consists updating local properties issuing cluster local heartbeat repository remote heartbeat topology connectors topology issue heartbeat issueheartbeat update properties updateproperties issue cluster local heartbeat issueclusterlocalheartbeat issue connector pings issueconnectorpings update properties updateproperties discovery service impl discoveryserviceimpl logger debug update properties updateproperties discovery service discoveryservice discovery service impl discoveryserviceimpl update properties updateproperties issue cluster local heartbeat repository issue cluster local heartbeat issueclusterlocalheartbeat logger is debug enabled isdebugenabled logger debug issue cluster local heartbeat issueclusterlocalheartbeat storing cluster local heartbeat repository sling id slingid resource resolver resourceresolver resource resolver resourceresolver string my cluster node path myclusternodepath get local cluster node path getlocalclusternodepath calendar current time currenttime calendar get instance getinstance resource resolver resourceresolver get resource resolver getresourceresolver resource resolver resourceresolver logger error issue cluster local heartbeat issueclusterlocalheartbeat resource resolver resourceresolver resource resource resource helper resourcehelper get or create resource getorcreateresource resource resolver resourceresolver my cluster node path myclusternodepath modifiable value map modifiablevaluemap resource map resourcemap resource adapt to adaptto modifiable value map modifiablevaluemap first heartbeat written firstheartbeatwritten last heartbeat written lastheartbeatwritten sling additional paranoia check heartbeat check sling cluster time since first heartbeat timesincefirstheartbeat system current time millis currenttimemillis first heartbeat written firstheartbeatwritten time since first heartbeat timesincefirstheartbeat config get heartbeat interval getheartbeatinterval wait heartbeat int ervals intervals handle situation bundle ref res hed refreshed startup cases calendar last heartbeat lastheartbeat resource map resourcemap property heartbeat calendar last heartbeat lastheartbeat time last heartbeat written lastheartbeatwritten get time gettime equals last heartbeat lastheartbeat get time gettime hit situation sling instance accessing repository cluster sling writing resource invalidate current established view invalidatecurrentestablishedview discovery service impl discoveryserviceimpl handle topology changing handletopologychanging logger error issue cluster local heartbeat issueclusterlocalheartbeat sling detected unexpected concurrent update my cluster node path myclusternodepath last heartbeat lastheartbeat manually instance running cluster sling sling sling id slingid check sling file installation instances cluster verify duplicate sling ids allowed cluster sling robust paranoia check heartbeat write runtime id runtimeid property ignoring subsequent calls runtime id runtimeid sling id slingid string read runtime id readruntimeid resource map resourcemap property runtime string read runtime id readruntimeid sling deleted resource property first heartbeat written firstheartbeatwritten runtime id runtimeid equals read runtime id readruntimeid invalidate current established view invalidatecurrentestablishedview discovery service impl discoveryserviceimpl handle topology changing handletopologychanging string sling home path slinghomepath sling settings service slingsettingsservice sling settings service slingsettingsservice get sling home path getslinghomepath string end points as string endpointsasstring get end points as string getendpointsasstring string read end points readendpoints resource map resourcemap property end points endpoints string string read sling home path readslinghomepath resource map resourcemap property sling path string logger error issue cluster local heartbeat issueclusterlocalheartbeat sling detected instance running cluster sling sling sling id slingid runtime id runtimeid runtime id runtimeid end points endpoints end points as string endpointsasstring sling home path slinghomepath sling home path slinghomepath runtime id runtimeid read runtime id readruntimeid end points endpoints read end points readendpoints sling home path slinghomepath read sling home path readslinghomepath check sling file installation instances cluster verify duplicate sling ids allowed cluster logger error issue cluster local heartbeat issueclusterlocalheartbeat sending topology changing disabling discovery service impl discoveryserviceimpl for ced shutdown forcedshutdown logger error issue cluster local heartbeat issueclusterlocalheartbeat disabling discovery impl activated context disable components context get bundle context getbundlecontext get bundle getbundle bundle exception bundleexception logger warn issue cluster local heartbeat issueclusterlocalheartbeat bundle context disable component disablecomponent resource map resourcemap property heartbeat current time currenttime first heartbeat written firstheartbeatwritten resource map resourcemap property runtime runtime id runtimeid sling store infos verbose duplicate sling id slingid ghost detection string sling home path slinghomepath sling settings service slingsettingsservice sling settings service slingsettingsservice get sling home path getslinghomepath resource map resourcemap property sling path sling home path slinghomepath string end points as string endpointsasstring get end points as string getendpointsasstring resource map resourcemap property end points endpoints end points as string endpointsasstring logger info issue cluster local heartbeat issueclusterlocalheartbeat storing runtime id runtimeid end points endpoints sling path object runtime id runtimeid end points as string endpointsasstring sling home path slinghomepath reset leader election id resetleaderelectionid resource map resourcemap contains key containskey leader election id leaderelectionid leader election id leaderelectionid pre field new leader election id newleaderelectionid calculate string new leader election id newleaderelectionid new leader election id newleaderelectionid new leader election id newleaderelectionid new leader election id newleaderelectionid resource resolver resourceresolver new leader election id newleaderelectionid resource map resourcemap leader election id leaderelectionid new leader election id newleaderelectionid resource map resourcemap leader election id created at leaderelectionidcreatedat logger info issue cluster local heartbeat issueclusterlocalheartbeat leader election id leaderelectionid new leader election id newleaderelectionid reset leader election id resetleaderelectionid reset leader election id resetleaderelectionid voting handler votinghandler voting handler votinghandler set leader election id setleaderelectionid new leader election id newleaderelectionid reset leader election id resetleaderelectionid logger debug issue cluster local heartbeat issueclusterlocalheartbeat commit ting committing cluster local heartbeat repository sling id slingid resource resolver resourceresolver commit logger debug issue cluster local heartbeat issueclusterlocalheartbeat committed cluster local heartbeat repository sling id slingid sling success remember heartbeat written last heartbeat written lastheartbeatwritten current time currenttime heartbeat written first heartbeat written firstheartbeatwritten first heartbeat written firstheartbeatwritten system current time millis currenttimemillis login exception loginexception logger error issue heartbeat issueheartbeat log admin istratively administratively persistence exception persistenceexception logger error issue heartbeat issueheartbeat persistence exception persistenceexception my cluster node path myclusternodepath resource resolver resourceresolver resource resolver resourceresolver close calculate leader election id leaderelectionid based current config system time string new leader election id newleaderelectionid resource resolver resourceresolver resource resolver resourceresolver max long length maxlonglength string value of valueof max length string current time millis str currenttimemillisstr string format max long length maxlonglength system current time millis currenttimemillis should invert repository descriptor shouldinvertrepositorydescriptor config should invert repository descriptor shouldinvertrepositorydescriptor string prefix should invert repository descriptor shouldinvertrepositorydescriptor string leader election repository descriptor leaderelectionrepositorydescriptor config get leader election repository descriptor getleaderelectionrepositorydescriptor leader election repository descriptor leaderelectionrepositorydescriptor leader election repository descriptor leaderelectionrepositorydescriptor length property configured check repository descriptor include leader election session session resource resolver resourceresolver adapt to adaptto session session string session get repository getrepository get descriptor getdescriptor leader election repository descriptor leaderelectionrepositorydescriptor equals ignore case equalsignorecase should invert repository descriptor shouldinvertrepositorydescriptor prefix prefix string new leader election id newleaderelectionid prefix current time millis str currenttimemillisstr sling id slingid new leader election id newleaderelectionid check established view matches reality matches heartbeats do check view docheckview do check view docheckview resource resolver resourceresolver resource resolver resourceresolver resource resolver resourceresolver get resource resolver getresourceresolver do check view with docheckviewwith resource resolver resourceresolver login exception loginexception logger error check view checkview log admin istratively administratively persistence exception persistenceexception logger error check view checkview encountered persistence exception view check runtime exception runtimeexception logger error check view checkview encountered runtime exception view check resource resolver resourceresolver resource resolver resourceresolver close established heartbeat view check resource resolver resourceresolver do check view with docheckviewwith resource resolver resourceresolver resource resolver resourceresolver persistence exception persistenceexception voting handler votinghandler logger info do check view with docheckviewwith voting handler votinghandler sling id slingid sling id slingid voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver voting handler votinghandler cleanup time do ut votings cleanuptimedoutvotings resource resolver resourceresolver exception logger warn do check view with docheckviewwith exception occurred cleaning votings voting view votingview winning voting winningvoting voting helper votinghelper get winning voting getwinningvoting resource resolver resourceresolver config num open non winning votes numopennonwinningvotes voting helper votinghelper list open non winning votings listopennonwinningvotings resource resolver resourceresolver config size winning voting winningvoting num open non winning votes numopennonwinningvotes votings pending wait set tle settle topology changing logger info do check view with docheckviewwith pending votings marking topology changing invalidate current established view invalidatecurrentestablishedview discovery service impl discoveryserviceimpl handle topology changing handletopologychanging logger is debug enabled isdebugenabled logger debug do check view with docheckviewwith num open non winning votes numopennonwinningvotes ongoing votings winning wait set tle settle resource cluster nodes res clusternodesres resource helper resourcehelper get or create resource getorcreateresource resource resolver resourceresolver config get cluster instances path getclusterinstancespath string live instances liveinstances view helper viewhelper determine live instances determineliveinstances cluster nodes res clusternodesres config view established view establishedview view helper viewhelper get established view getestablishedview resource resolver resourceresolver config last established view id lastestablishedviewid established view establishedview established view establishedview get resource getresource get name getname established view matches establishedviewmatches last established view id lastestablishedviewid failed established view id failedestablishedviewid last established view id lastestablishedviewid equals failed established view id failedestablishedviewid sling heartbeat check caused established view id establishedviewid declared failed voting logger info do check view docheckview current established view id establishedviewid declared failed earlier last established view id lastestablishedviewid established view matches establishedviewmatches established view establishedview established view matches establishedviewmatches string mismatch details mismatchdetails mismatch details mismatchdetails established view establishedview matches live instances liveinstances exception logger error do check view with docheckviewwith compare established view live invalidate current established view invalidatecurrentestablishedview discovery service impl discoveryserviceimpl handle topology changing handletopologychanging mismatch details mismatchdetails logger info do check view docheckview established view match details mismatch details mismatchdetails logger debug do check view docheckview established view matches expected established view matches establishedviewmatches mismatch details mismatchdetails established view matches establishedviewmatches normal established view matches happy fine logger debug do check view with docheckviewwith pending winning votes view fine happy send topology changing logger info do check view with docheckviewwith matching established view marking topology changing invalidate current established view invalidatecurrentestablishedview discovery service impl discoveryserviceimpl handle topology changing handletopologychanging list voting view votingview my yes votes myyesvotes voting helper votinghelper get yes votings of getyesvotingsof resource resolver resourceresolver config sling id slingid my yes votes myyesvotes my yes votes myyesvotes size logger info do check view with docheckviewwith voted my yes votes myyesvotes size vote promoted expecting voting vote my yes votes myyesvotes logger is debug enabled isdebugenabled logger debug do check view with docheckviewwith pending winning votes view match established established init iating initiating voting iterator string live instances liveinstances iterator has next hasnext logger debug do check view with docheckviewwith live instances realize established view doesn t doesnt match live instances init iate initiate voting do start new voting dostartnewvoting resource resolver resourceresolver live instances liveinstances do start new voting dostartnewvoting resource resolver resourceresolver resource resolver resourceresolver string live instances liveinstances persistence exception persistenceexception string voting id votingid next voting id nextvotingid next voting id nextvotingid uuid randomuuid to string tostring voting view votingview new voting newvoting resource resolver resourceresolver config voting id votingid sling id slingid live instances liveinstances mark current established view establishedview invalid req uiring requiring replaced instance vote invalidate current established view invalidatecurrentestablishedview last established view id lastestablishedviewid logger info invalidate current established view invalidatecurrentestablishedview invalidate last established view id lastestablishedviewid logger info invalidate current established view invalidatecurrentestablishedview invalid ating invalidating sling id slingid sling id slingid last established view id lastestablishedviewid last established view id lastestablishedviewid failed established view id failedestablishedviewid last established view id lastestablishedviewid discovery service impl discoveryserviceimpl get cluster view service impl getclusterviewserviceimpl invalidate established view id invalidateestablishedviewid last established view id lastestablishedviewid management function trigger algorithm dependent start voting sense explicitly force leader change allowed discovery api start new voting startnewvoting logger info start new voting startnewvoting explicitly starting voting resource resolver resourceresolver resource resolver resourceresolver resource resolver resourceresolver get resource resolver getresourceresolver resource cluster nodes res clusternodesres resource helper resourcehelper get or create resource getorcreateresource resource resolver resourceresolver config get cluster instances path getclusterinstancespath string live instances liveinstances view helper viewhelper determine live instances determineliveinstances cluster nodes res clusternodesres config do start new voting dostartnewvoting resource resolver resourceresolver live instances liveinstances logger info start new voting startnewvoting explicit voting started login exception loginexception logger error start new voting startnewvoting log admin istratively administratively persistence exception persistenceexception logger error start new voting startnewvoting encountered persistence exception view check resource resolver resourceresolver resource resolver resourceresolver close