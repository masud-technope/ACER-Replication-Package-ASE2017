licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling query resource jcr query java util array list arraylist java util list org apache commons lang string utils stringutils org apache sling query resource jcr jcr operator jcroperator org apache sling query resource jcr jcr type resolver jcrtyperesolver org apache sling query resource jcr query formula org apache sling query selector parser attribute org apache sling query selector parser selector segment selectorsegment jcr query builder jcrquerybuilder jcr type resolver jcrtyperesolver type resolver typeresolver jcr query builder jcrquerybuilder jcr type resolver jcrtyperesolver type resolver typeresolver type resolver typeresolver type resolver typeresolver string build query buildquery list selector segment selectorsegment segments string root path rootpath string builder stringbuilder query string builder stringbuilder query append select query append find primary type findprimarytype segments query append query append string condition string conditionstring get condition string getconditionstring segments root path rootpath string utils stringutils is not blank isnotblank condition string conditionstring query append append condition string conditionstring query to string tostring string get condition string getconditionstring list selector segment selectorsegment segments string root path rootpath formula form ula formula prepare alternative conditions preparealternativeconditions segments string utils stringutils is not blank isnotblank root path rootpath equals root path rootpath list term conditions array list arraylist term conditions add atomic string format isdescendantnode root path rootpath form ula formula conditions add form ula formula form ula formula formula conditions form ula formula form ula formula build string buildstring string find primary type findprimarytype list selector segment selectorsegment segments string result selector segment selectorsegment segments string type get type gettype type resolver typeresolver is jcr type isjcrtype type result result type type resolver typeresolver is subtype issubtype type result result type type resolver typeresolver is subtype issubtype result type result base result result base result formula prepare alternative conditions preparealternativeconditions list selector segment selectorsegment segments list term list array list arraylist term selector segment selectorsegment segment segments formula conditions prepare segment conditions preparesegmentconditions segment get type gettype segment get name getname segment get attributes getattributes conditions list add conditions list is empty isempty formula list formula prepare segment conditions preparesegmentconditions string resource type resourcetype string resource name resourcename list attribute attributes list term conditions array list arraylist term string utils stringutils is not blank isnotblank resource type resourcetype string utils stringutils resource type resourcetype conditions add atomic string format sling resource type resourcetype resource type resourcetype string utils stringutils is not blank isnotblank resource name resourcename conditions add atomic string format resource name resourcename attributes attribute attributes string attribute condition attributecondition get attribute condition getattributecondition string utils stringutils is not blank isnotblank attribute condition attributecondition conditions add atomic attribute condition attributecondition conditions is empty isempty formula conditions string get attribute condition getattributecondition attribute attribute attribute get key getkey jcr operator jcroperator jcr operator jcroperator get selector operator getselectoroperator attribute get operator getoperator string string utils stringutils replace attribute get value getvalue get jcr query fragment getjcrqueryfragment attribute get key getkey