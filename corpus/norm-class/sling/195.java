licensed sakai foundation contributor license agreements notice file distributed work additional copyright ownership licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling form impl java data input stream datainputstream java data output stream dataoutputstream java file java file input stream fileinputstream java file output stream fileoutputstream java io exception ioexception java unsupported encoding exception unsupportedencodingexception java security invalid key exception invalidkeyexception java security message digest messagedigest java security no such algorithm exception nosuchalgorithmexception java security secure random securerandom javax crypto mac javax crypto secret key secretkey javax crypto spec secret key spec secretkeyspec org apache commons lang string utils stringutils org slf logger org slf logger factory loggerfactory code token store tokenstore code secure token hash implementation link form authentication handler formauthenticationhandler generate validate persist secure tokens token store tokenstore array hex characters link byte to hex bytetohex convert array hex string tohex abc def abcdef to char array tochararray code secure random securerandom code generator algorithm string sha prng sha prng hmac function calculate hash code payload secure token string hmac sha hmacsha string encoding convert arrays strings vice versa string utf utf number secret token buffer current tokens currenttokens token buffer size logger log logger factory loggerfactory get logger getlogger token store tokenstore ttl cookie invalid ttl time token created next update nextupdate system current time millis currenttimemillis location current token current token currenttoken ring tokens enc rypt encrypt secret key secretkey current tokens currenttokens secure random generating tokens secure random securerandom random token file persist secure tokens file token file tokenfile temporary file update secure token file file tmp token file tmptokenfile no such algorithm exception nosuchalgorithmexception invalid key exception invalidkeyexception unsupported encoding exception unsupportedencodingexception illegal state exception illegalstateexception null pointer exception nullpointerexception code token file tokenfile code code code token store tokenstore file token file tokenfile session timeout sessiontimeout fast see d fastseed no such algorithm exception nosuchalgorithmexception invalid key exception invalidkeyexception illegal state exception illegalstateexception unsupported encoding exception unsupportedencodingexception token file tokenfile null pointer exception nullpointerexception token file tokenfile random secure random securerandom get instance getinstance sha prng ttl session timeout sessiontimeout token file tokenfile token file tokenfile tmp token file tmptokenfile file token file tokenfile tmp prime secret persistence load tokens loadtokens warm crypto api fast see d fastseed random set see d setseed get fast entropy getfastentropy log info see ding seeding secure random number generator min utes minutes operating systems depending environment fact ors factors problem system property java security egd file dev urandom enable fast see d seed generator web console random next bytes nextbytes secret key secretkey secret key secretkey secret key spec secretkeyspec hmac sha mac mac get instance getinstance hmac sha init secret key secretkey update utf get bytes getbytes utf do final dofinal param expires param user id userid unsupported encoding exception unsupportedencodingexception illegal state exception illegalstateexception no such algorithm exception nosuchalgorithmexception invalid key exception invalidkeyexception string encode expires string user id userid illegal state exception illegalstateexception unsupported encoding exception unsupportedencodingexception no such algorithm exception nosuchalgorithmexception invalid key exception invalidkeyexception token get active token getactivetoken secret key secretkey key current tokens currenttokens token encode expires user id userid token key string encode expires string user id userid token secret key secretkey key illegal state exception illegalstateexception unsupported encoding exception unsupportedencodingexception no such algorithm exception nosuchalgorithmexception invalid key exception invalidkeyexception string cookie payload cookiepayload string value of valueof token string value of valueof expires user id userid mac mac get instance getinstance hmac sha init key update cookie payload cookiepayload get bytes getbytes utf string cookie value cookievalue byte to hex bytetohex do final dofinal cookie value cookievalue cookie payload cookiepayload splits authentication data parts packed encoding cookie param auth data authdata authentication data split parts string array elements parts cookie code code input code code string separated parts string split string auth data authdata string parts string utils stringutils split auth data authdata parts parts length parts returns code code code code valid secure token string code code string fields separated sign exp iry expiry time encoded field passed has hing hashing field exp iry expiry time token number secure token token number contained field method returns code code is valid isvalid string string parts split parts single digit token number token number tokennumber parts char at charat token number tokennumber token number tokennumber current tokens currenttokens length cookie time cookietime parse long parselong parts substring system current time millis currenttimemillis cookie time cookietime secret key secretkey secret key secretkey current tokens currenttokens token number tokennumber string hmac encode cookie time cookietime parts token number tokennumber secret key secretkey equals hmac array index out of bounds exception arrayindexoutofboundsexception log error get message getmessage invalid key exception invalidkeyexception log error get message getmessage illegal state exception illegalstateexception log error get message getmessage unsupported encoding exception unsupportedencodingexception log error get message getmessage no such algorithm exception nosuchalgorithmexception log error get message getmessage log error authncookie invalid log error authncookie expired system current time millis currenttimemillis cookie time cookietime log error authncookie invalid ref ers refers invalid token number token number tokennumber log error authncookie invalid format failed verification reason log ged logged main tain maintain circular buffer tokens current current token get active token getactivetoken system current time millis currenttimemillis next update nextupdate current tokens currenttokens current token currenttoken cycle typical ttl tokens completely ref res hed refreshed next update nextupdate system current time millis currenttimemillis ttl current tokens currenttokens length random next bytes nextbytes secret key secretkey new token newtoken secret key spec secretkeyspec hmac sha next token nexttoken current token currenttoken next token nexttoken current tokens currenttokens length next token nexttoken current tokens currenttokens next token nexttoken new token newtoken current token currenttoken next token nexttoken save tokens savetokens current token currenttoken stores current tokens token file save tokens savetokens file output stream fileoutputstream fout data output stream dataoutputstream key output stream keyoutputstream file parent token file tokenfile get absolute file getabsolutefile get parent file getparentfile log info token file parent token file tokenfile parent parent exists parent mkdirs fout file output stream fileoutputstream tmp token file tmptokenfile key output stream keyoutputstream data output stream dataoutputstream fout key output stream keyoutputstream write int writeint current token currenttoken key output stream keyoutputstream write long writelong next update nextupdate current tokens currenttokens length current tokens currenttokens key output stream keyoutputstream write int writeint key output stream keyoutputstream write int writeint current tokens currenttokens get encoded getencoded key output stream keyoutputstream write int writeint length key output stream keyoutputstream write key output stream keyoutputstream close tmp token file tmptokenfile rename to renameto token file tokenfile io exception ioexception log error failed save cookie get message getmessage key output stream keyoutputstream close exception fout close exception load current tokens token file reading tokens fails token file exist tokens generated demand load tokens loadtokens token file tokenfile is file isfile token file tokenfile can read canread file input stream fileinputstream fin data input stream datainputstream key input stream keyinputstream fin file input stream fileinputstream token file tokenfile key input stream keyinputstream data input stream datainputstream fin new current token newcurrenttoken key input stream keyinputstream read int readint new next update newnextupdate key input stream keyinputstream read long readlong secret key secretkey new keys newkeys secret key secretkey token buffer size new keys newkeys length is null isnull key input stream keyinputstream read int readint is null isnull key input stream keyinputstream read int readint key input stream keyinputstream read new keys newkeys secret key spec secretkeyspec hmac sha new keys newkeys assign tokes schedule update next update nextupdate new next update newnextupdate current token currenttoken new current token newcurrenttoken current tokens currenttokens new keys newkeys io exception ioexception log error failed load cookie get message getmessage key input stream keyinputstream key input stream keyinputstream close io exception ioexception fin fin close io exception ioexception failure read current tokens create current tokens currenttokens current tokens currenttokens secret key secretkey token buffer size next update nextupdate system current time millis currenttimemillis current token currenttoken encode array param base string byte to hex bytetohex base base length base tohex tohex string creates array entry current system current system time milliseconds epoch number nano seconds nanoseconds system startup size modification time files code java tmpdir code folder note method generates entropy fast secure see ding seeding random number generator bytes entropy get fast entropy getfastentropy message digest messagedigest message digest messagedigest get instance getinstance sha no such algorithm exception nosuchalgorithmexception nsae internal error internalerror internal error sha update xor shifted xorshifted time values update system current time millis currenttimemillis update system nano time nanotime scan temp file system file file file system get property getproperty java tmpdir file entries file list files listfiles entries file entry entries update entry get name getname get bytes getbytes update entry last modified lastmodified update entry length digest updates message digest xor shifted param message digest messagedigest update param original xor shifted bytes update message digest update message digest messagedigest update