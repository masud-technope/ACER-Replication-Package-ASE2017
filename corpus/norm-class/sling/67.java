licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling mailarchiveserver impl org apache james mime dom field field name fieldname subject org apache sling mailarchiveserver util message field name messagefieldname content org apache sling mailarchiveserver util message field name messagefieldname html body org apache sling mailarchiveserver util message field name messagefieldname list org apache sling mailarchiveserver util message field name messagefieldname org apache sling mailarchiveserver util message field name messagefieldname plain body org apache sling mailarchiveserver util message field name messagefieldname original header java byte array output stream bytearrayoutputstream java io exception ioexception java text parse position parseposition java text simple date format simpledateformat java util array list arraylist java util collection java util java util hash map hashmap java util hash set hashset java util iterator java util list java util map java util java util sorted set sortedset java util tree set treeset org apache felix scr annotations activate org apache felix scr annotations component org apache felix scr annotations reference org apache felix scr annotations reference cardinality referencecardinality org apache felix scr annotations reference policy referencepolicy org apache felix scr annotations service org apache jackrabbit util text org apache james mime dom binary body binarybody org apache james mime dom body org apache james mime dom entity org apache james mime dom header org apache james mime dom message org apache james mime dom multipart org apache james mime dom text body textbody org apache james mime dom field field name fieldname org apache james mime message body part bodypart org apache james mime message default message writer defaultmessagewriter org apache james mime stream field org apache sling api resource login exception loginexception org apache sling api resource modifiable value map modifiablevaluemap org apache sling api resource persistence exception persistenceexception org apache sling api resource resource org apache sling api resource resource resolver resourceresolver org apache sling api resource resource resolver factory resourceresolverfactory org apache sling mailarchiveserver api attachment filter attachmentfilter org apache sling mailarchiveserver api message processor messageprocessor org apache sling mailarchiveserver api message store messagestore org apache sling mailarchiveserver api thread key generator threadkeygenerator org apache sling mailarchiveserver util mail archive server constants mailarchiveserverconstants org apache sling mailarchiveserver util message field name messagefieldname org osgi framework bundle context bundlecontext org osgi framework service reference servicereference org slf logger org slf logger factory loggerfactory component service message store messagestore message store impl messagestoreimpl message store messagestore string plain mimetype text plain string html mimetype text html reference resource resolver factory resourceresolverfactory resource resolver factory resourceresolverfactory reference thread key generator threadkeygenerator thread key gen threadkeygen reference attachment filter attachmentfilter attachment filter attachmentfilter reference cardinality reference cardinality referencecardinality optional multiple policy reference policy referencepolicy dynamic reference interface referenceinterface message processor messageprocessor sorted set sortedset service reference servicereference message processor refs messageprocessorrefs tree set treeset service reference servicereference list message processor messageprocessor message processors messageprocessors array list arraylist message processor messageprocessor processors updated processorsupdated bundle context bundlecontext bundle context bundlecontext string field separator todo config urable configurable thread key generator impl threadkeygeneratorimpl string prefixes todo testing string archive path archivepath mail archive server constants mailarchiveserverconstants archive path string resource type key resourcetypekey mail archive server constants mailarchiveserverconstants key logger logger logger factory loggerfactory get logger getlogger message store impl messagestoreimpl activate activate bundle context bundlecontext bundle context bundlecontext resource resolver resourceresolver get resource resolver getresourceresolver login exception loginexception resource resolver factory resourceresolverfactory get administrative resource resolver getadministrativeresourceresolver save message msg io exception ioexception resource resolver resourceresolver resolver resolver get resource resolver getresourceresolver save resolver msg login exception loginexception runtime exception runtimeexception login exception loginexception resolver resolver close save resource resolver resourceresolver resolver message msg io exception ioexception login exception loginexception apply message processors message processor messageprocessor processor get sorted message processors getsortedmessageprocessors logger debug calling processor processor process message processmessage msg path archive domain list thread message map string object msg props msgprops hash map hashmap string object list body part bodypart attachments array list arraylist body part bodypart msg props msgprops resource type key resourcetypekey mail archive server constants mailarchiveserverconstants message string builder stringbuilder plain body plainbody string builder stringbuilder string builder stringbuilder html body htmlbody string builder stringbuilder has body hasbody msg is multipart ismultipart plain body plainbody string builder stringbuilder get text part gettextpart msg multipart multipart multipart msg get body getbody recursive multipart processing recursivemultipartprocessing multipart plain body plainbody html body htmlbody has body hasbody attachments msg props msgprops plain body plain body plainbody to string tostring replace all replaceall html body htmlbody length msg props msgprops html body html body htmlbody to string tostring msg props msgprops put all putall get message properties from header getmessagepropertiesfromheader msg get header getheader byte array output stream bytearrayoutputstream baos byte array output stream bytearrayoutputstream default message writer defaultmessagewriter write header writeheader msg get header getheader baos string orig hdr orighdr baos to string tostring mail archive server constants mailarchiveserverconstants encoder charset msg props msgprops original header orig hdr orighdr header hdr msg get header getheader string list id raw listidraw hdr get field getfield list get body getbody remove string list id listid list id raw listidraw substring list id raw listidraw length string list get list node name getlistnodename list id listid string domain get domain node name getdomainnodename list id listid string subject string msg props msgprops subject string thread path threadpath thread key gen threadkeygen get thread key getthreadkey subject string thread name threadname remove re removere subject resource parent resource parentresource assert each node asserteachnode resolver archive path archivepath domain list thread path threadpath thread name threadname string msg node name msgnodename make jcr friendly makejcrfriendly string msg props msgprops is msg node created ismsgnodecreated assert resource assertresource resolver parent resource parentresource msg node name msgnodename msg props msgprops is msg node created ismsgnodecreated resource msg resource msgresource resolver get resource getresource parent resource parentresource msg node name msgnodename body part bodypart att attachments attachment filter attachmentfilter is eligible iseligible att map string object att props attprops hash map hashmap string object parse header to props parseheadertoprops att get header getheader att props attprops body body att get body getbody body binary body binarybody att props attprops content binary body binarybody body get input stream getinputstream body text body textbody att props attprops content text body textbody body get input stream getinputstream string att node name attnodename text escape illegal jcr chars escapeillegaljcrchars att get file name getfilename assert resource assertresource resolver msg resource msgresource att node name attnodename att props attprops update thread updatethread resolver parent resource parentresource msg props msgprops recursive multipart processing recursivemultipartprocessing multipart multipart string builder stringbuilder plain body plainbody string builder stringbuilder html body htmlbody has body hasbody list body part bodypart attachments io exception ioexception entity enitiy multipart get body parts getbodyparts body part bodypart body part bodypart enitiy get disposition type getdispositiontype get disposition type getdispositiontype equals disposition type dispositiontype empty multipart attached file attachments add is mime type ismimetype plain mimetype has body hasbody plain body plainbody append get text part gettextpart has body hasbody is mime type ismimetype html mimetype has body hasbody html body htmlbody append get text part gettextpart is multipart ismultipart recursive multipart processing recursivemultipartprocessing multipart get body getbody plain body plainbody html body htmlbody has body hasbody attachments save all saveall iterator message iterator io exception ioexception resource resolver resourceresolver resolver resolver get resource resolver getresourceresolver mcount iterator has next hasnext message msg iterator save resolver msg mcount mcount logger debug mcount messages processed logger info mcount messages processed login exception loginexception runtime exception runtimeexception login exception loginexception resolver resolver close code http mozgoweb pos ts posts parse mime message mime library string get text part gettextpart entity io exception ioexception text body textbody text body textbody get body getbody byte array output stream bytearrayoutputstream baos byte array output stream bytearrayoutputstream write to writeto baos baos to string tostring mail archive server constants mailarchiveserverconstants encoder charset map string object get message properties from header getmessagepropertiesfromheader header hdr map string object props hash map hashmap string object parse header to props parseheadertoprops hdr props message string hdr get field getfield message hdr get field getfield message get body getbody remove substring length integer to hex string tohexstring hdr get field getfield hash code hashcode props message field name messagefieldname props parse header to props parseheadertoprops header hdr map string object props string processed hash set hashset string field hdr get fields getfields string get name getname processed processed add string list field fields hdr get fields getfields field fields get body getbody field separator props substring length field separator length string get list node name getlistnodename string list id listid string list string split list id listid split split l splitl split length split l splitl split l splitl list split list list substring list length split l splitl list split runtime exception runtimeexception list invalid minimum sep aratory separatory dots required list string get domain node name getdomainnodename string list id listid string split list id listid split split l splitl split length split l splitl split split l splitl split split l splitl runtime exception runtimeexception list invalid minimum sep aratory separatory dots required resource assert each node asserteachnode resource resolver resourceresolver resolver string archive string domain string list string thread path threadpath string thread name threadname persistence exception persistenceexception login exception loginexception string path to message pathtomessage archive domain list thread path threadpath string path path to message pathtomessage resource resource resolver get resource getresource path cnt resource cnt path path substring path last index of lastindexof resource resolver get resource getresource path cnt thread nodes number threadnodesnumber thread path threadpath split length bind paths list string node paths nodepaths array list arraylist string node paths nodepaths add domain node paths nodepaths add list string node thread path threadpath split node paths nodepaths add node bind props list map string object node props nodeprops array list arraylist map string object node props nodeprops add set properties setproperties mail archive server constants mailarchiveserverconstants domain domain node props nodeprops add set properties setproperties mail archive server constants mailarchiveserverconstants list list thread nodes number threadnodesnumber node props nodeprops add node props nodeprops add set properties setproperties mail archive server constants mailarchiveserverconstants thread thread name threadname checking node paths nodepaths size cnt node paths nodepaths size string node paths nodepaths assert resource assertresource resolver resource node props nodeprops resource resolver get resource getresource resource get path getpath resource resolver get resource getresource path to message pathtomessage resource runtime exception runtimeexception parent resource resource map string object set properties setproperties string resource type resourcetype string map string object props hash map hashmap string object props resource type key resourcetypekey resource type resourcetype props message field name messagefieldname props assert resource assertresource resource resolver resourceresolver resolver resource parent string map string object new props newprops login exception loginexception persistence exception persistenceexception string check path checkpath parent get path getpath resource check resource checkresource resolver get resource getresource check path checkpath check resource checkresource resource new resource newresource resolver create parent new props newprops resolver commit logger debug string format resource created new resource newresource get path getpath logger debug string format resource exists check resource checkresource get path getpath update thread updatethread resource resolver resourceresolver resolver resource thread map string object msg props msgprops persistence exception persistenceexception modifiable value map modifiablevaluemap thr d props thrdprops thread adapt to adaptto modifiable value map modifiablevaluemap prop thr d props thrdprops message field name messagefieldname update updated date updateddate prop updated date updateddate prop string msg prop msgprop string msg props msgprops field name fieldname simple date format simpledateformat sdf simple date format simpledateformat eee mmm yyyy msg date msgdate sdf parse msg prop msgprop parse position parseposition updated date updateddate msg date msgdate updated date updateddate thr d props thrdprops message field name messagefieldname update msg date msgdate get time gettime resolver commit string make jcr friendly makejcrfriendly string replace all replaceall replace all replaceall replace all replaceall trim replace all replaceall string remove re removere string trim flag flag flag string prefix prefixes to lower case tolowercase starts with startswith prefix substring trim flag trim bind message processor bindmessageprocessor service reference servicereference message processor refs messageprocessorrefs message processor refs messageprocessorrefs add processors updated processorsupdated logger info message processor pool unbind message processor unbindmessageprocessor service reference servicereference message processor refs messageprocessorrefs message processor refs messageprocessorrefs remove processors updated processorsupdated logger info message processor removed pool collection message processor messageprocessor get sorted message processors getsortedmessageprocessors processors updated processorsupdated message processor refs messageprocessorrefs processors updated processorsupdated message processors messageprocessors clear service reference servicereference message processor refs messageprocessorrefs message processors messageprocessors add message processor messageprocessor bundle context bundlecontext get service getservice logger debug updated sorted list message processor messageprocessor message processors messageprocessors message processors messageprocessors