licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery commons providers base java util array list arraylist java util hash map hashmap java util hash set hashset java util iterator java util list java util map java util java util concurrent locks lock org apache sling commons scheduler scheduler org apache sling discovery discovery service discoveryservice org apache sling discovery instance description instancedescription org apache sling discovery topology event topologyevent org apache sling discovery topology event topologyevent type org apache sling discovery topology event listener topologyeventlistener org apache sling discovery commons providers base topology view basetopologyview org apache sling discovery commons providers event helper eventhelper org apache sling discovery commons providers view state manager viewstatemanager org apache sling discovery commons providers spi cluster sync service clustersyncservice org slf logger org slf logger factory loggerfactory view state manager viewstatemanager core managing topology event listeners topologyeventlisteners view changing changed sending topology events topologyevents registered listeners note synchronization rquires lock object passed constructor applied methods app ropriately appropriately add itionally additionally cluster sync service clustersyncservice callback locked lock object view state manager impl viewstatemanagerimpl view state manager viewstatemanager logger logger logger factory loggerfactory get logger getlogger view state manager impl viewstatemanagerimpl list bound listeners received init event un initialized event listeners uninitializedeventlisteners view state manager impl viewstatemanagerimpl un initialized event listeners uninitializedeventlisteners list topology event listener topologyeventlistener event listeners eventlisteners array list arraylist topology event listener topologyeventlistener list bound listeners received topology init event topology init event moved event listeners eventlisteners stay list cases bind activate activate time topology topology changing point topology init event view state manager impl viewstatemanagerimpl event listeners eventlisteners list topology event listener topologyeventlistener un initialized event listeners uninitializedeventlisteners array list arraylist topology event listener topologyeventlistener bundle activate called deactivate called controls handle changing handlechanging handle new view handlenewview events called handle activated handleactivated handle deactivated handledeactivated view state manager impl viewstatemanagerimpl handle activated handleactivated view state manager impl viewstatemanagerimpl handle changing handlechanging view state manager impl viewstatemanagerimpl handle new view handlenewview base topology view basetopologyview view state manager impl viewstatemanagerimpl handle deactivated handledeactivated activated represents new view newview passed handle new topology view handlenewtopologyview invocation sending topology init event newly bound listeners activate time sending old view oldview marked current topology changing event sending old view oldview marked current handle changing handlechanging invoked topology changed event base topology view basetopologyview previous view previousview handle changing handlechanging called handle new view handlenewview topology changing topology changed is changing ischanging lock object methods guarded constructor lock lock optional cluster sync service clustersyncservice constructor invoked view handle new view handlenewview actual topology changed event cluster sync service clustersyncservice sync method callback sync hronous synchronous async hronous asynchronous cluster sync service clustersyncservice consistency service consistencyservice modification counter increments methods handle activated handleactivated handle deactivated handledeactivated handle changing handlechanging handle new view handlenewview intent consistency service consistencyservice callback cluster sync service clustersyncservice check methods invoked send topology changed event facts happened sync hing synching repository mod cnt modcnt sling reference background async event sender asynceventsender started stopped activate deactivate async event sender asynceventsender async event sender asynceventsender sling map event listener prevent duplicate changing events scheduler broken map topology event listener topologyeventlistener topology event topologyevent type last event map lasteventmap hash map hashmap topology event listener topologyeventlistener topology event topologyevent type min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler creates view state manager viewstatemanager synch ronizes synchronizes method lock option ally optionally cluster sync service clustersyncservice sync repository handling view instances leaves local cluster param lock lock param consistency service consistencyservice optional cluster sync service clustersyncservice sync repository handling view instances leaves local cluster view state manager impl viewstatemanagerimpl lock lock cluster sync service clustersyncservice consistency service consistencyservice lock illegal argument exception illegalargumentexception lock lock lock consistency service consistencyservice consistency service consistencyservice override install min event delay handler installmineventdelayhandler discovery service discoveryservice discovery service discoveryservice scheduler scheduler min event delay secs mineventdelaysecs min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler lock discovery service discoveryservice scheduler min event delay secs mineventdelaysecs had previous view hadpreviousview previous view previousview unchanged base topology view basetopologyview new view newview is changing ischanging previous view previousview previous view previousview equals new view newview javadoc org apache sling discovery commons providers impl view state manager viewstatemanager bind org apache sling discovery topology event listener topologyeventlistener override bind topology event listener topologyeventlistener event listener eventlistener logger trace bind start event listener eventlistener lock lock logger debug bind binding topology event listener topologyeventlistener event listener eventlistener event listeners eventlisteners event listener eventlistener un initialized event listeners uninitializedeventlisteners event listener eventlistener logger info bind topology event listener topologyeventlistener registered event listener eventlistener activated check is changing ischanging previous view previousview send topology init point delay logger is debug enabled isdebugenabled logger debug bind view defined is changing ischanging is changing ischanging previous view previousview previous view previousview delaying init event listener eventlistener un initialized event listeners uninitializedeventlisteners add event listener eventlistener send topology init logger debug bind view defined sending init event listener eventlistener enqueue event listener eventlistener event helper eventhelper new init event newinitevent previous view previousview event listeners eventlisteners add event listener eventlistener logger debug bind activated delaying init event listener eventlistener un initialized event listeners uninitializedeventlisteners add event listener eventlistener lock unlock logger trace bind javadoc org apache sling discovery commons providers impl view state manager viewstatemanager unbind org apache sling discovery topology event listener topologyeventlistener override unbind topology event listener topologyeventlistener event listener eventlistener logger trace unbind start event listener eventlistener lock lock logger debug unbind releasing topology event listener topologyeventlistener event listener eventlistener listener exist unbind safety paranoia reasons remove event listeners eventlisteners remove event listener eventlistener un initialized event listeners uninitializedeventlisteners remove event listener eventlistener lock unlock logger trace unbind enqueue topology event listener topologyeventlistener topology event topologyevent event log info loginfo logger trace enqueue start topology event topologyevent event async event sender asynceventsender happen send topology event sendtopologyevent called activated logger warn enqueue async event sender asynceventsender send event event last event map lasteventmap event get type gettype event get type gettype type topology changing don topology changing log info loginfo logger info enqueue listener topology changing logger debug enqueue listener topology changing log info loginfo logger info enqueue enqueuing topology event topologyevent event helper eventhelper to short string toshortstring event logger debug enqueue enqueuing topology event topologyevent event async event sender asynceventsender enqueue event last event map lasteventmap event get type gettype logger trace enqueue sending topology event topologyevent event internal helper method sends event list listeners enqueue for all enqueueforall list topology event listener topologyeventlistener audience topology event topologyevent event logger info enqueue for all enqueueforall sending topology event topologyevent listeners event helper eventhelper to short string toshortstring event audience size iterator topology event listener topologyeventlistener audience iterator has next hasnext topology event listener topologyeventlistener topology event listener topologyeventlistener enqueue topology event listener topologyeventlistener event logger trace enqueue for all enqueueforall topology event topologyevent listeners event audience size javadoc org apache sling discovery commons providers impl view state manager viewstatemanager handle activated handleactivated override handle activated handleactivated logger trace handle activated handleactivated start lock lock logger debug handle activated handleactivated act ivating activating view state manager viewstatemanager activated mod cnt modcnt sling start async event sender asynceventsender background stopped deactivate point pending events events enqueue d enqueued async event sender asynceventsender async event sender asynceventsender thread thread async event sender asynceventsender set name setname discovery async event sender asynceventsender set daemon setdaemon start previous view previousview is changing ischanging enqueue for all enqueueforall un initialized event listeners uninitializedeventlisteners event helper eventhelper new init event newinitevent previous view previousview event listeners eventlisteners add all addall un initialized event listeners uninitializedeventlisteners un initialized event listeners uninitializedeventlisteners clear logger debug handle activated handleactivated activated view state manager viewstatemanager lock unlock logger trace handle activated handleactivated javadoc org apache sling discovery commons providers impl view state manager viewstatemanager handle deactivated handledeactivated override handle deactivated handledeactivated logger trace handle deactivated handledeactivated start lock lock logger debug handle deactivated handledeactivated deactivating view state manager viewstatemanager activated mod cnt modcnt async event sender asynceventsender async event sender asynceventsender flush then stop flushthenstop async event sender asynceventsender previous view previousview previous view previousview set not current setnotcurrent logger trace handle deactivated handledeactivated setting previous view previousview previous view previousview consistency service consistencyservice consistency service consistencyservice cancel sync cancelsync min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler cancel delaying canceldelaying logger trace handle deactivated handledeactivated setting is changing ischanging is changing ischanging event listeners eventlisteners clear un initialized event listeners uninitializedeventlisteners clear logger debug handle deactivated handledeactivated deactivated view state manager viewstatemanager lock unlock logger trace handle deactivated handledeactivated javadoc org apache sling discovery commons providers impl view state manager viewstatemanager handle changing handlechanging override handle changing handlechanging logger trace handle changing handlechanging start lock lock is changing ischanging is changing ischanging news asap logger debug handle changing handlechanging changing ignoring mod cnt modcnt activated is changing ischanging logger trace handle changing handlechanging setting is changing ischanging is changing ischanging activated activated start sending events activated returning is changing ischanging not e note activated event listeners eventlisteners un initialized event listeners uninitializedeventlisteners moment waiting activate handle new topology view handlenewtopologyview logger debug handle changing handlechanging activated ignoring previous view previousview early changing event view logger debug handle changing handlechanging previous view previousview ignoring logger debug handle changing handlechanging sending topology changing initialized listeners previous view previousview set not current setnotcurrent enqueue for all enqueueforall event listeners eventlisteners event helper eventhelper new changing event newchangingevent previous view previousview lock unlock logger trace handle changing handlechanging javadoc org apache sling discovery commons providers impl view state manager viewstatemanager handle new view handlenewview org apache sling discovery commons providers base topology view basetopologyview override handle new view handlenewview base topology view basetopologyview new view newview logger trace handle new view handlenewview start new view newview new view newview new view newview illegal argument exception illegalargumentexception new view newview new view newview is current iscurrent logger debug handle new view handlenewview new view newview current calling handle changing handlechanging handle changing handlechanging paranoia testing instance description instancedescription local instance localinstance new view newview get local instance getlocalinstance local instance localinstance illegal state exception illegalstateexception new view newview local instance current local instance localinstance is local islocal illegal state exception illegalstateexception new view newview local instance is local islocal unexpected current cancel ongoing sync consistency service consistencyservice consistency service consistencyservice cancel sync cancelsync logger debug handle new view handlenewview new view newview current min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler handles new view handlesnewview new view newview logger debug handle new view handlenewview event delaying applicable time invoking hanlde new view non delayed hanldenewviewnondelayed logger debug handle new view handlenewview min event delay handler mineventdelayhandler invoking hanlde new view non delayed hanldenewviewnondelayed handle new view non delayed handlenewviewnondelayed new view newview handle new view non delayed handlenewviewnondelayed base topology view basetopologyview new view newview logger trace handle new view non delayed handlenewviewnondelayed start lock lock logger debug handle new view non delayed handlenewviewnondelayed start new view newview new view newview new view newview is current iscurrent logger error handle new view non delayed handlenewviewnondelayed new view newview current illegal argument exception illegalargumentexception new view newview current mod cnt modcnt is changing ischanging previous view previousview previous view previousview equals new view newview send view changed have n haven changing event logger debug handle new view non delayed handlenewviewnondelayed changing view matches ignoring previous view previousview only differs in properties onlydiffersinproperties new view newview logger debug handle new view non delayed handlenewviewnondelayed impl icitly implicitly triggering handle changing handlechanging changing handle changing handlechanging logger debug handle new view non delayed handlenewviewnondelayed impl icitly implicitly triggering handle changing handlechanging activated pass prev ioue view previoueview logger trace handle new view non delayed handlenewviewnondelayed setting previous view previousview new view newview previous view previousview new view newview is changing ischanging flag logger trace handle new view non delayed handlenewviewnondelayed setting is changing ischanging is changing ischanging send event activate logger debug handle new view non delayed handlenewviewnondelayed activated ignoring check view changed properties is changing ischanging only differs in properties onlydiffersinproperties new view newview send properties changed event consistency service consistencyservice logger info handle new view non delayed handlenewviewnondelayed properties changed new view newview previous view previousview set not current setnotcurrent enqueue for all enqueueforall event listeners eventlisteners event helper eventhelper new properties changed event newpropertieschangedevent previous view previousview new view newview logger trace handle new view non delayed handlenewviewnondelayed setting previous view previousview new view newview previous view previousview new view newview invoke cluster sync service invokeclustersyncservice consistency service consistencyservice logger info handle new view non delayed handlenewviewnondelayed cluster sync service clustersyncservice continuing invoke cluster sync service invokeclustersyncservice distinct ion distinction previous view previousview invoke consistency service consistencyservice invoke instance left cluster algorithm work newly joining instance previous view previousview sync token synctoken thi ngy thingy existing instances instance left urgent sync token synctoken point joining instance wait sync token synctoken arrive consistency service consistencyservice configured logger info handle new view non delayed handlenewviewnondelayed cluster sync service clustersyncservice invoking invoke cluster sync service invokeclustersyncservice invoke cluster sync service invokeclustersyncservice instances local cluster removed consistency service consistencyservice last mod cnt lastmodcnt mod cnt modcnt logger info handle new view non delayed handlenewviewnondelayed invoking wait for async events waitforasyncevents cluster sync service clustersyncservice mod cnt modcnt mod cnt modcnt async event sender asynceventsender enqueue async event asyncevent override string to string tostring wait for async events waitforasyncevents flush token hash code hashcode override trigger event triggered guaranteed async events cos async events handled queue async event asyncevent queue enqueue time token event calling wait for async event waitforasyncevent blocked token async event handled explicitly lock lock mod cnt modcnt last mod cnt lastmodcnt logger info handle new view non delayed handlenewviewnondelayed wait for async events waitforasyncevents mod cnt modcnt changed ignoring last mod cnt lastmodcnt mod cnt modcnt logger info handle new view non delayed handlenewviewnondelayed wait for async events waitforasyncevents invoking consistency service consistencyservice mod cnt modcnt mod cnt modcnt consistency service consistencyservice sync new view newview runnable logger trace consistency service consistencyservice callback start acquiring lock lock lock logger debug consistency service consistencyservice callback lock aquired mod cnt modcnt last mod cnt lastmodcnt mod cnt modcnt mod cnt modcnt last mod cnt lastmodcnt logger info consistency service consistencyservice callback mod cnt modcnt changed ignoring last mod cnt lastmodcnt mod cnt modcnt logger info consistency service consistencyservice callback invoking do handle consistent dohandleconsistent do handle consistent dohandleconsistent new view newview lock unlock logger trace consistency service consistencyservice callback lock unlock told cluster sync service clustersyncservice applicable stage sending topology changed topology init newly bound topology listeners logger info handle new view non delayed handlenewviewnondelayed invoking consistency service consistencyservice consistent do handle consistent dohandleconsistent new view newview logger debug handle new view non delayed handlenewviewnondelayed lock unlock logger trace handle new view non delayed handlenewviewnondelayed only differs in properties onlydiffersinproperties base topology view basetopologyview new view newview previous view previousview new view newview illegal argument exception illegalargumentexception new view newview string previous sync token id previoussynctokenid string new sync token id newsynctokenid previous sync token id previoussynctokenid previous view previousview get local cluster sync token id getlocalclustersynctokenid illegal state exception illegalstateexception previous sync token id previoussynctokenid new sync token id newsynctokenid new view newview get local cluster sync token id getlocalclustersynctokenid illegal state exception illegalstateexception new sync token id newsynctokenid previous sync token id previoussynctokenid new sync token id newsynctokenid new sync token id newsynctokenid previous sync token id previoussynctokenid previous sync token id previoussynctokenid previous sync token id previoussynctokenid equals new sync token id newsynctokenid previous view previousview get instances getinstances size new view newview get instances getinstances size previous view previousview equals new view newview string new ids newids hash set hashset string instance description instancedescription new instance newinstance new view newview get instances getinstances new ids newids add new instance newinstance get sling id getslingid instance description instancedescription old instance oldinstance previous view previousview get instances getinstances instance description instancedescription new instance newinstance new view newview get instance getinstance old instance oldinstance get sling id getslingid new instance newinstance old instance oldinstance is leader isleader new instance newinstance is leader isleader do handle consistent dohandleconsistent base topology view basetopologyview new view newview logger trace do handle consistent dohandleconsistent start unset is changing ischanging flag logger trace do handle consistent dohandleconsistent setting is changing ischanging is changing ischanging previous view previousview event listeners eventlisteners size logger info do handle consistent dohandleconsistent previous view listeners changed event logger debug do handle consistent dohandleconsistent previous view event listeners quiet normal uninitialized event listeners waiting logger debug do handle consistent dohandleconsistent sending topology changed initialized listeners previous view previousview set not current setnotcurrent enqueue for all enqueueforall event listeners eventlisteners event helper eventhelper new changed event newchangedevent previous view previousview new view newview un initialized event listeners uninitializedeventlisteners size bind topology event listener bindtopologyeventlistener calls coming changing send init waiting logger debug do handle consistent dohandleconsistent sending topology init uninitialized listeners un initialized event listeners uninitializedeventlisteners size enqueue for all enqueueforall un initialized event listeners uninitializedeventlisteners event helper eventhelper new init event newinitevent new view newview event listeners eventlisteners add all addall un initialized event listeners uninitializedeventlisteners un initialized event listeners uninitializedeventlisteners clear logger trace do handle consistent dohandleconsistent setting previous view previousview new view newview previous view previousview new view newview logger trace do handle consistent dohandleconsistent hook testing async event sender asynceventsender get async event sender getasynceventsender async event sender asynceventsender override wait for async events waitforasyncevents timeout system current time millis currenttimemillis timeout in flight event cnt inflighteventcnt get in flight async event cnt getinflightasynceventcnt in flight event cnt inflighteventcnt flight events timeout actual cnt in flight event cnt inflighteventcnt timeout infinite waiting system current time millis currenttimemillis thread sleep interrupted exception interruptedexception timeout hit in flight event cnt inflighteventcnt get in flight async event cnt getinflightasynceventcnt cnt async event sender asynceventsender get in flight event cnt getinflighteventcnt min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler is delaying isdelaying cnt cnt