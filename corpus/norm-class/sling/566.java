licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery base org junit assert equals assertequals org junit assert false assertfalse org junit assert not null assertnotnull org junit assert true asserttrue org apache log level org apache log log manager logmanager org apache sling discovery topology event topologyevent org apache sling discovery topology event topologyevent type org apache sling discovery topology view topologyview org apache sling discovery base setup virtual instance virtualinstance org apache sling discovery base setup virtual instance builder virtualinstancebuilder org apache sling discovery base setup mock asserting topology event listener assertingtopologyeventlistener org junit org junit org junit ignore org junit test org slf logger org slf logger factory loggerfactory test covering correct sending topology events topologyevents scenarios covered tests abstract topology event test abstracttopologyeventtest logger logger logger factory loggerfactory get logger getlogger get class getclass virtual instance virtualinstance instance virtual instance virtualinstance instance level log level loglevel setup exception org apache log logger discovery logger discoverylogger log manager logmanager get root logger getrootlogger get logger getlogger org apache sling discovery log level loglevel discovery logger discoverylogger get level getlevel discovery logger discoverylogger set level setlevel level debug tear down teardown throwable instance instance stop view checker stopviewchecker instance instance instance instance stop view checker stopviewchecker instance instance org apache log logger discovery logger discoverylogger log manager logmanager get root logger getrootlogger get logger getlogger org apache sling discovery discovery logger discoverylogger set level setlevel log level loglevel virtual instance builder virtualinstancebuilder new builder newbuilder tests fact init event delayed voting succeeded slign sling throwable test test delayed init event testdelayedinitevent throwable logger info test delayed init event testdelayedinitevent start instance new builder newbuilder set debug name setdebugname first instance a firstinstancea new repository newrepository discovery impl set connector ping timeout setconnectorpingtimeout set min event delay setmineventdelay build asserting topology event listener assertingtopologyeventlistener asserting topology event listener assertingtopologyeventlistener instance add expected addexpected type topology init instance bind topology event listener bindtopologyeventlistener logger info test delayed init event testdelayedinitevent instance created events expected sling id slingid instance sling id slingid instance heartbeats and check view heartbeatsandcheckview thread sleep instance heartbeats and check view heartbeatsandcheckview thread sleep instance heartbeats and check view heartbeatsandcheckview thread sleep logger info test delayed init event testdelayedinitevent heartbeat expecting topology init instance dump repo dumprepo event assert equals assertequals get events getevents size expected assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount logger info test delayed init event testdelayedinitevent creating instance instance new builder newbuilder set debug name setdebugname second instance b secondinstanceb use repository of userepositoryof instance set connector ping timeout setconnectorpingtimeout set min event delay setmineventdelay build logger info test delayed init event testdelayedinitevent instance created sling id slingid instance sling id slingid asserting topology event listener assertingtopologyeventlistener asserting topology event listener assertingtopologyeventlistener instance instance bind topology event listener bindtopologyeventlistener logger info test delayed init event testdelayedinitevent listener instance events asserting topology event listener assertingtopologyeventlistener asserting topology event listener assertingtopologyeventlistener instance add expected addexpected type topology init logger info test delayed init event testdelayedinitevent listener instance expects init instance bind topology event listener bindtopologyeventlistener sling async event sending requires minimal wait time now adays nowadays thread sleep instance started doesn kick events instance didn send heartbeats event assert equals assertequals get events getevents size expected assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size expected assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount heartbeat triggers voting logger info test delayed init event testdelayedinitevent heartbeats trigger events add expected addexpected type topology changing add expected addexpected type topology changing thread sleep add expected addexpected type topology init instance heartbeats and check view heartbeatsandcheckview instance heartbeats and check view heartbeatsandcheckview thread sleep instance heartbeats and check view heartbeatsandcheckview instance heartbeats and check view heartbeatsandcheckview thread sleep instance heartbeats and check view heartbeatsandcheckview instance heartbeats and check view heartbeatsandcheckview logger info test delayed init event testdelayedinitevent instance instance sling id slingid logger info test delayed init event testdelayedinitevent instance instance sling id slingid instance dump repo dumprepo assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size assert equals assertequals get unexpected count getunexpectedcount sync token service synctokenservice discovery impl tests check longer assert equals assertequals get events getevents size fact sync hing synching requires time bit early stage check work assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size wait changed changing add expected addexpected type topology changed add expected addexpected type topology changed thread sleep assert equals assertequals get unexpected count getunexpectedcount event assert equals assertequals get events getevents size assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get events getevents size logger info test delayed init event testdelayedinitevent test test get during delay testgetduringdelay throwable instance new builder newbuilder set debug name setdebugname first instance a firstinstancea new repository newrepository discovery impl set connector ping timeout setconnectorpingtimeout set min event delay setmineventdelay build asserting topology event listener assertingtopologyeventlistener asserting topology event listener assertingtopologyeventlistener instance add expected addexpected topology event topologyevent type topology init instance bind topology event listener bindtopologyeventlistener topology view topologyview early top o earlytopo instance get discovery service getdiscoveryservice get topology gettopology assert not null assertnotnull early top o earlytopo assert false assertfalse early top o earlytopo is current iscurrent assert equals assertequals early top o earlytopo get instances getinstances size instance heartbeats and check view heartbeatsandcheckview thread sleep topology view topologyview second top o secondtopo instance get discovery service getdiscoveryservice get topology gettopology assert equals assertequals second top o secondtopo get instances getinstances size assert equals assertequals instance get sling id getslingid second top o secondtopo get instances getinstances iterator get sling id getslingid assert true asserttrue second top o secondtopo is current iscurrent instance dump repo dumprepo assert early and first cluster view id matches assertearlyandfirstclusterviewidmatches early top o earlytopo second top o secondtopo thread sleep init remaining expected events assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount add expected addexpected topology event topologyevent type topology changing instance new builder newbuilder set debug name setdebugname second instance b secondinstanceb use repository of userepositoryof instance set connector ping timeout setconnectorpingtimeout set min event delay setmineventdelay build asserting topology event listener assertingtopologyeventlistener asserting topology event listener assertingtopologyeventlistener instance add expected addexpected topology event topologyevent type topology init instance bind topology event listener bindtopologyeventlistener instance heartbeats and check view heartbeatsandcheckview instance heartbeats and check view heartbeatsandcheckview thread sleep assert equals assertequals get unexpected count getunexpectedcount topology view topologyview top o topo instance get discovery service getdiscoveryservice get topology gettopology assert true asserttrue top o topo is current iscurrent assert equals assertequals top o topo get instances getinstances size topology view topologyview top o topo instance get discovery service getdiscoveryservice get topology gettopology assert true asserttrue top o topo is current iscurrent assert equals assertequals top o topo get instances getinstances size add expected addexpected topology event topologyevent type topology changed thread sleep assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount assert equals assertequals get remaining expected count getremainingexpectedcount assert equals assertequals get unexpected count getunexpectedcount assert true asserttrue instance get discovery service getdiscoveryservice get topology gettopology is current iscurrent assert equals assertequals instance get discovery service getdiscoveryservice get topology gettopology get instances getinstances size assert true asserttrue instance get discovery service getdiscoveryservice get topology gettopology is current iscurrent assert equals assertequals instance get discovery service getdiscoveryservice get topology gettopology get instances getinstances size assert early and first cluster view id matches assertearlyandfirstclusterviewidmatches topology view topologyview early top o earlytopo topology view topologyview second top o secondtopo