licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery commons providers spi base org junit assert equals assertequals org junit assert false assertfalse org junit assert not null assertnotnull org junit assert true asserttrue java util uuid java util concurrent locks lock java util concurrent locks reentrant lock reentrantlock org apache jackrabbit oak plugins memory memory node store memorynodestore org apache sling api resource resource resolver factory resourceresolverfactory org apache sling discovery commons providers dummy topology view dummytopologyview org apache sling discovery commons providers view state manager viewstatemanager org apache sling discovery commons providers base dummy listener dummylistener org apache sling discovery commons providers base test helper testhelper org apache sling discovery commons providers base view state manager factory viewstatemanagerfactory org apache sling discovery commons providers spi base abstract service with background check abstractservicewithbackgroundcheck background check runnable backgroundcheckrunnable org apache sling jcr api sling repository slingrepository org junit org junit org junit test org slf logger org slf logger factory loggerfactory test oak sync token service testoaksynctokenservice logger logger logger factory loggerfactory get logger getlogger test oak sync token service testoaksynctokenservice string synctoken path discovery commons sync tokens synctokens string idmap path discovery commons idmap simple commons config simplecommonsconfig discovery lite config discoveryliteconfig bg interval millis bgintervalmillis bg timeout millis bgtimeoutmillis simple commons config simplecommonsconfig defaults simple commons config simplecommonsconfig bg interval millis bgintervalmillis bg timeout millis bgtimeoutmillis bg interval millis bgintervalmillis bg interval millis bgintervalmillis bg timeout millis bgtimeoutmillis bg timeout millis bgtimeoutmillis override string get sync token path getsynctokenpath synctoken path override string get id map path getidmappath idmap path override get cluster sync service timeout millis getclustersyncservicetimeoutmillis bg timeout millis bgtimeoutmillis override get cluster sync service interval millis getclustersyncserviceintervalmillis bg interval millis bgintervalmillis resource resolver factory resourceresolverfactory factory resource resolver factory resourceresolverfactory factory sling repository slingrepository repository sling repository slingrepository repository memory node store memorynodestore memoryns id map service idmapservice id map service idmapservice string sling id slingid setup exception logger info setup start repository test helper repositorytesthelper reset repo resetrepo memoryns memory node store memorynodestore repository repository test helper repositorytesthelper new oak repository newoakrepository memoryns repository test helper repositorytesthelper init sling node types initslingnodetypes repository repository repository test helper repositorytesthelper new oak repository newoakrepository memoryns factory repository test helper repositorytesthelper mock resource resolver factory mockresourceresolverfactory repository factory repository test helper repositorytesthelper mock resource resolver factory mockresourceresolverfactory repository sling id slingid uuid randomuuid to string tostring id map service idmapservice id map service idmapservice test constructor testconstructor simple commons config simplecommonsconfig dummy sling settings service dummyslingsettingsservice sling id slingid factory logger info setup tear down teardown exception logger info tear down teardown start repository repository test helper repositorytesthelper stop repository stoprepository repository repository repository repository test helper repositorytesthelper stop repository stoprepository repository repository logger info tear down teardown test test one node testonenode exception logger info test one node testonenode start dummy topology view dummytopologyview test helper testhelper new view newview sling id slingid sling id slingid sling id slingid lock lock reentrant lock reentrantlock oak backlog cluster sync service oakbacklogclustersyncservice oak backlog cluster sync service oakbacklogclustersyncservice test constructor and activate testconstructorandactivate simple commons config simplecommonsconfig id map service idmapservice dummy sling settings service dummyslingsettingsservice sling id slingid factory view state manager viewstatemanager vsm view state manager factory viewstatemanagerfactory new view state manager newviewstatemanager lock dummy listener dummylistener dummy listener dummylistener assert equals assertequals count events countevents vsm bind trigger background check triggerbackgroundcheck assert equals assertequals count events countevents vsm handle activated handleactivated trigger background check triggerbackgroundcheck assert equals assertequals count events countevents vsm handle new view handlenewview trigger background check triggerbackgroundcheck assert equals assertequals count events countevents trigger background check triggerbackgroundcheck descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder seq active ids activeids set final setfinal assert true asserttrue id map service idmapservice wait for init waitforinit trigger background check triggerbackgroundcheck assert equals assertequals vsm wait for async events waitforasyncevents assert equals assertequals count events countevents logger info test one node testonenode test test two nodes one leaving testtwonodesoneleaving exception logger info test two nodes one leaving testtwonodesoneleaving start string sling id slingid uuid randomuuid to string tostring dummy topology view dummytopologyview test helper testhelper new view newview sling id slingid sling id slingid sling id slingid sling id slingid lock lock reentrant lock reentrantlock oak backlog cluster sync service oakbacklogclustersyncservice oak backlog cluster sync service oakbacklogclustersyncservice test constructor and activate testconstructorandactivate simple commons config simplecommonsconfig id map service idmapservice dummy sling settings service dummyslingsettingsservice sling id slingid factory view state manager viewstatemanager vsm view state manager factory viewstatemanagerfactory new view state manager newviewstatemanager lock dummy listener dummylistener dummy listener dummylistener vsm bind vsm handle activated handleactivated vsm handle new view handlenewview trigger background check triggerbackgroundcheck assert equals assertequals count events countevents descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids deactivating ids deactivatingids trigger background check triggerbackgroundcheck assert equals assertequals count events countevents assert ion assertion background runnable stage sleep waiting deactivating instance disappear logger info test two nodes one leaving testtwonodesoneleaving sync service waiting back log backlog disappear thread sleep background check runnable backgroundcheckrunnable background check runnable backgroundcheckrunnable background check runnable backgroundcheckrunnable assert not null assertnotnull background check runnable backgroundcheckrunnable assert false assertfalse background check runnable backgroundcheckrunnable is done isdone assert false assertfalse background check runnable backgroundcheckrunnable can celled cancelled release deactivating instance removing cluster view clusterview logger info test two nodes one leaving testtwonodesoneleaving freeing back log backlog sync service finish descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids trigger background check triggerbackgroundcheck set tle settle thread sleep background runnable backgroundrunnable events stuck vsm background check runnable backgroundcheckrunnable background check runnable backgroundcheckrunnable assert not null assertnotnull background check runnable backgroundcheckrunnable assert false assertfalse background check runnable backgroundcheckrunnable can celled cancelled assert true asserttrue background check runnable backgroundcheckrunnable is done isdone assert equals assertequals vsm wait for async events waitforasyncevents logger info test two nodes one leaving testtwonodesoneleaving setting node lock lock reentrant lock reentrantlock id map service idmapservice id map service idmapservice id map service idmapservice test constructor testconstructor simple commons config simplecommonsconfig dummy sling settings service dummyslingsettingsservice sling id slingid factory oak backlog cluster sync service oakbacklogclustersyncservice oak backlog cluster sync service oakbacklogclustersyncservice test constructor and activate testconstructorandactivate simple commons config simplecommonsconfig id map service idmapservice dummy sling settings service dummyslingsettingsservice sling id slingid factory view state manager viewstatemanager vsm view state manager factory viewstatemanagerfactory new view state manager newviewstatemanager lock trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck assert equals assertequals count events countevents descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck assert equals assertequals count events countevents descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck assert equals assertequals count events countevents vsm handle activated handleactivated assert true asserttrue id map service idmapservice wait for init waitforinit assert true asserttrue id map service idmapservice wait for init waitforinit dummy topology view dummytopologyview test helper testhelper new view newview get local cluster sync token id getlocalclustersynctokenid get local instance getlocalinstance get cluster view getclusterview get id getid sling id slingid sling id slingid sling id slingid sling id slingid vsm handle new view handlenewview trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck assert equals assertequals vsm wait for async events waitforasyncevents assert equals assertequals count events countevents logger info test two nodes one leaving testtwonodesoneleaving removing instance view vsm didn send topology changing leave deactivating dummy topology view dummytopologyview one leaving oneleaving clone one leaving oneleaving remove instance removeinstance sling id slingid descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids deactivating ids deactivatingids vsm handle new view handlenewview one leaving oneleaving trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck wait topology changing received vsm assert equals assertequals vsm wait for async events waitforasyncevents assert equals assertequals count events countevents logger info test two nodes one leaving testtwonodesoneleaving marking instance longer deactivating vsm send topology changed descriptor helper descriptorhelper set discovery lite descriptor setdiscoverylitedescriptor factory discovery lite descriptor builder discoverylitedescriptorbuilder set final setfinal seq active ids activeids inactive ids inactiveids trigger background check triggerbackgroundcheck trigger background check triggerbackgroundcheck wait topology changed received vsm assert equals assertequals vsm wait for async events waitforasyncevents repository test helper repositorytesthelper dump repo dumprepo factory assert equals assertequals count events countevents