licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery impl cluster voting java util calendar java util java util hash map hashmap java util iterator java util map java util javax jcr property javax jcr repository exception repositoryexception javax jcr value format exception valueformatexception org apache sling api resource modifiable value map modifiablevaluemap org apache sling api resource persistence exception persistenceexception org apache sling api resource resource org apache sling api resource resource resolver resourceresolver org apache sling api resource value map valuemap org apache sling discovery commons providers util resource helper resourcehelper org apache sling discovery impl config org apache sling discovery impl common view org apache sling discovery impl common view helper viewhelper org slf logger org slf logger factory loggerfactory dao ongoing voting providing helper methods voting view votingview view logger avoid frequent initialization cluster view resource clusterviewresource logger logger logger factory loggerfactory get logger getlogger voting view votingview create voting list instances voting view sling id slingid initiator param new view id newviewid voting view param initiator id initiatorid sling id slingid initiator param live instances liveinstances list live instances add voting dao object representing voting voting view votingview new voting newvoting resource resolver resourceresolver resource resolver resourceresolver config config string new view id newviewid string initiator id initiatorid string live instances liveinstances persistence exception persistenceexception live instances liveinstances initiator id initiatorid sling voting single instance created local instance happen local instance live instances fis hy fishy create voting rely retry logger warn new voting newvoting live instances liveinstances include initiator id initiatorid local instance creating invalid voting resource voting resource votingresource resource helper resourcehelper get or create resource getorcreateresource resource resolver resourceresolver config get ongoing votings path getongoingvotingspath new view id newviewid modifiable value map modifiablevaluemap voting map votingmap voting resource votingresource adapt to adaptto modifiable value map modifiablevaluemap voting map votingmap voting start votingstart calendar get instance getinstance string cluster id clusterid calendar cluster id defined at clusteriddefinedat string cluster id defined by clusteriddefinedby view currently established view currentlyestablishedview view helper viewhelper get established view getestablishedview resource resolver resourceresolver config currently established view currentlyestablishedview value map valuemap established view value map establishedviewvaluemap currently established view currentlyestablishedview get resource getresource adapt to adaptto value map valuemap cluster id clusterid established view value map establishedviewvaluemap view property cluster string cluster id clusterid cluster id clusterid length cluster id clusterid currently established view currentlyestablishedview get resource getresource get name getname established view value map establishedviewvaluemap view property cluster defined cluster id defined at clusteriddefinedat calendar get instance getinstance cluster id defined at clusteriddefinedat set time settime cluster id defined by clusteriddefinedby established view value map establishedviewvaluemap view property cluster defined string cluster id clusterid cluster id clusterid length cluster id clusterid new view id newviewid cluster id defined at clusteriddefinedat calendar get instance getinstance voting map votingmap view property cluster cluster id clusterid cluster id defined at clusteriddefinedat voting map votingmap view property cluster defined cluster id defined at clusteriddefinedat cluster id defined by clusteriddefinedby cluster id defined by clusteriddefinedby length cluster id defined by clusteriddefinedby initiator id initiatorid voting map votingmap view property cluster defined cluster id defined by clusteriddefinedby resource members resource membersresource resource resolver resourceresolver create voting resource votingresource members iterator string live instances liveinstances iterator has next hasnext string member id memberid map string object properties hash map hashmap string object member id memberid equals initiator id initiatorid properties initiator properties vote properties voted at votedat calendar get instance getinstance resource instance resource instanceresource resource helper resourcehelper get or create resource getorcreateresource resource resolver resourceresolver config get cluster instances path getclusterinstancespath member id memberid string leader election id leaderelectionid instance resource instanceresource adapt to adaptto value map valuemap leader election id leaderelectionid string properties leader election id leaderelectionid leader election id leaderelectionid resource resolver resourceresolver create members resource membersresource member id memberid properties logger debug new voting newvoting commit ting committing voting new view id newviewid new view id newviewid initiator id initiatorid initiator id initiatorid resource voting resource votingresource members live instances liveinstances size members live instances liveinstances resource resolver resourceresolver commit logger info new voting newvoting voting started new view id newviewid new view id newviewid initiator id initiatorid initiator id initiatorid resource voting resource votingresource members live instances liveinstances size members live instances liveinstances voting view votingview voting resource votingresource construct voting view based resource param view resource viewresource resource place voting voting view votingview resource view resource viewresource view resource viewresource string get voting id getvotingid get resource getresource get name getname override string to string tostring resource members get resource getresource get child getchild members string initiator id initiatorid string builder stringbuilder string builder stringbuilder members iterator resource members get children getchildren iterator has next hasnext resource length append append get name getname value map valuemap properties adapt to adaptto value map valuemap properties initiator properties initiator initiator initiator initiator id initiatorid get name getname voting view votingview view id viewid get view id getviewid get resource getresource get name getname initiator initiator id initiatorid members exception voting view votingview to string tostring checks voting ongoing valid voting start votingstart heartbeat timeout configured param config is ongoing voting isongoingvoting config config voting start votingstart get voting start time getvotingstarttime voting start votingstart system current time millis currenttimemillis diff voting start votingstart diff config get heartbeat timeout millis getheartbeattimeoutmillis checks voting time d timed valid voting start votingstart time d timed is time dout voting istimedoutvoting config config voting start votingstart get voting start time getvotingstarttime voting start votingstart system current time millis currenttimemillis diff voting start votingstart diff config get heartbeat timeout millis getheartbeattimeoutmillis voting start votingstart property wrong reading get voting start time getvotingstarttime value map valuemap properties properties get resource getresource adapt to adaptto value map valuemap runtime exception runtimeexception logger info get voting start time getvotingstarttime properties get resource getresource creation properties properties odd valid voting voting start date votingstartdate properties voting start votingstart voting start date votingstartdate logger is debug enabled isdebugenabled logger debug get voting start time getvotingstarttime voting voting start votingstart creation get resource getresource voting start votingstart voting start date votingstartdate get time gettime voting start votingstart checks votes voting votes voting has no votes hasnovotes resource get resource getresource get child getchild members vote created wait iterator resource get children getchildren iterator has next hasnext resource a member res amemberres value map valuemap properties a member res amemberres adapt to adaptto value map valuemap properties vote properties vote vote vote checks sling id slingid voted voting param sling id slingid sling check sling id slingid voted voting has vote d yes hasvotedyes string sling id slingid vote get vote getvote sling id slingid vote vote vote instance sling id slingid param sling id slingid instance vote structure faulty instance voted voted get vote getvote string sling id slingid resource members get resource getresource get child getchild members members resource member resource memberresource members get child getchild sling id slingid member resource memberresource value map valuemap properties member resource memberresource adapt to adaptto value map valuemap properties vote properties vote vote checks voting init iated initiated sling id slingid voting init iated initiated sling id slingid is init iated by isinitiatedby string sling id slingid resource get resource getresource resource members get child getchild members members logger is debug enabled isdebugenabled logger debug is init iated by isinitiatedby sling id slingid sling id slingid members resource member resource memberresource members get child getchild sling id slingid member resource memberresource logger is debug enabled isdebugenabled logger debug is init iated by isinitiatedby sling id slingid sling id slingid member resource memberresource value map valuemap properties member resource memberresource adapt to adaptto value map valuemap properties logger is debug enabled isdebugenabled logger debug is init iated by isinitiatedby sling id slingid sling id slingid properties initiator properties initiator result initiator initiator logger is debug enabled isdebugenabled logger debug is init iated by isinitiatedby sling id slingid sling id slingid initiator initiator result result result add vote sling id slingid voting param sling id slingid sling id slingid voting param vote vote vote vote string sling id slingid vote string leader election id leaderelectionid logger is debug enabled isdebugenabled logger debug vote sling id slingid sling id slingid vote vote resource get resource getresource logger error vote resource sling id slingid sling id slingid vote vote resource members get child getchild members members logger error vote members resource sling id slingid sling id slingid vote vote resource member resource memberresource members get child getchild sling id slingid member resource memberresource vote vote wanted vote empty big deal find entry logger debug vote member resource memberresource sling id slingid sling id slingid vote vote resource get resource getresource wanted vote big deal find logger error vote member resource memberresource sling id slingid sling id slingid vote vote resource get resource getresource modifiable value map modifiablevaluemap member map membermap member resource memberresource adapt to adaptto modifiable value map modifiablevaluemap vote member map membermap contains key containskey vote logger info vote removing vote vote sling id slingid sling id slingid logger debug vote removing vote vote sling id slingid sling id slingid member map membermap remove vote should vote shouldvote member map membermap contains key containskey vote object member map membermap vote property property property get boolean getboolean vote logger debug vote voted vote vote voting should vote shouldvote vote logger debug vote voted vote vote voting should vote shouldvote value format exception valueformatexception logger warn vote value format exception valueformatexception repository exception repositoryexception logger warn vote repository exception repositoryexception should vote shouldvote logger info vote sling id slingid sling id slingid voting vote vote get resource getresource member map membermap vote vote member map membermap voted at votedat calendar get instance getinstance string current leader election id currentleaderelectionid member map membermap leader election id leaderelectionid string leader election id leaderelectionid current leader election id currentleaderelectionid current leader election id currentleaderelectionid equals leader election id leaderelectionid sling ensure leader step isolated cluster leader election id leaderelectionid explicitly voting cases rejoin is olation isolation logger info vote changing leader election id leaderelectionid vote leader election id leaderelectionid member map membermap leader election id leaderelectionid leader election id leaderelectionid member map membermap leader election id created at leaderelectionidcreatedat get resource getresource get resource resolver getresourceresolver commit persistence exception persistenceexception logger error vote persistence exception persistenceexception voting checks voting winning winning votes members votes voting winning is winning iswinning resource members get resource getresource get child getchild members members vote created wait iterable resource children members get children getchildren iterator resource children iterator is winning iswinning has next hasnext resource a member res amemberres value map valuemap properties a member res amemberres adapt to adaptto value map valuemap vote properties vote vote vote is winning iswinning runtime exception runtimeexception logger info is winning iswinning check vote is winning iswinning runtime exception runtimeexception logger info is winning iswinning check vote checks voting matches current live view exception failed matching string matches live view matchesliveview config config exception resource cluster nodes res clusternodesres get resource getresource get resource resolver getresourceresolver get resource getresource config get cluster instances path getclusterinstancespath cluster nodes res clusternodesres exception cluster nodes res clusternodesres get resource getresource matches live view matchesliveview cluster nodes res clusternodesres config