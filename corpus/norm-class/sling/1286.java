licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling samples esp blog espblog internal java awt graphics java awt geom affine transform affinetransform java awt image buffered image bufferedimage java file java file input stream fileinputstream java file output stream fileoutputstream java io exception ioexception java input stream inputstream java output stream outputstream java util calendar java util hash map hashmap java util map javax image io imageio imageio javax jcr node javax jcr repository javax jcr repository exception repositoryexception javax jcr session javax jcr observation event javax jcr observation event iterator eventiterator javax jcr observation event listener eventlistener javax jcr observation observation manager observationmanager org apache felix scr annotations component org apache felix scr annotations property org apache felix scr annotations reference org apache sling jcr api sling repository slingrepository org osgi service component component context componentcontext org slf logger org slf logger factory loggerfactory observe esp blog espblog content generate thumbnails images component property service description sling esp blog sample thumbnails generator thumbnail generator thumbnailgenerator event listener eventlistener session session observation manager observationmanager observation manager observationmanager reference sling repository slingrepository repository property content esp blog espblog string content path property content path logger log logger factory loggerfactory get logger getlogger thumbnail generator thumbnailgenerator map string string supported mime types supportedmimetypes hash map hashmap string string activate component context componentcontext context exception supported mime types supportedmimetypes image jpeg jpg supported mime types supportedmimetypes image png png string content path contentpath string context get properties getproperties content path property session repository login administrative loginadministrative repository get descriptor getdescriptor repository option observation supported equals observation manager observationmanager session get workspace getworkspace get observation manager getobservationmanager string types file observation manager observationmanager add event listener addeventlistener event node content path contentpath types deactivate component context componentcontext component context componentcontext repository exception repositoryexception observation manager observationmanager observation manager observationmanager remove event listener removeeventlistener session session log out logout session on event onevent event iterator eventiterator has next hasnext event event next event nextevent event get type gettype event node event get path getpath thumbnails log info upload event get path getpath node added node addednode session get root node getrootnode get node getnode event get path getpath substring process new node processnewnode added node addednode log info finished processing event get path getpath exception log error get message getmessage string get mime type getmimetype node repository exception repositoryexception string result string mime type mimetype get property getproperty jcr mime type mimetype get string getstring string key supported mime types supportedmimetypes key set keyset mime type mimetype mime type mimetype starts with startswith key result key result log info node rejected unsupported mime type get path getpath mime type mimetype get name getname starts with startswith log info node rejected starts get path getpath mime type mimetype result result process new node processnewnode node added node addednode exception string mime type mimetype get mime type getmimetype added node addednode mime type mimetype string suffix supported mime types supportedmimetypes mime type mimetype s cal e scale temp file simplicity log info creating thumbnails node added node addednode get path getpath widths width widths create thumbnail createthumbnail added node addednode width mime type mimetype suffix create thumbnail createthumbnail node image scale per cent scalepercent string mime type mimetype string suffix exception file tmp file create temp file createtempfile get class getclass get simple name getsimplename suffix scale image get property getproperty jcr data get stream getstream scale per cent scalepercent file output stream fileoutputstream tmp suffix create thumbnail node mandatory properties node thumbnail folder thumbnailfolder get thumbnail folder getthumbnailfolder image node thumbnail thumbnail folder thumbnailfolder add node addnode image get parent getparent get name getname scale per cent scalepercent suffix file node content node contentnode thumbnail add node addnode jcr content resource content node contentnode set property setproperty jcr data file input stream fileinputstream tmp content node contentnode set property setproperty jcr last modified lastmodified calendar get instance getinstance content node contentnode set property setproperty jcr mime type mimetype mime type mimetype session save log info created thumbnail content node contentnode get path getpath tmp tmp delete node get thumbnail folder getthumbnailfolder node added node addednode exception node post added node addednode get parent getparent get parent getparent get parent getparent post has node hasnode thumbnails log info thumbnails node exists post get path getpath post get node getnode thumbnails node post add node addnode thumbnails folder session save scale input stream inputstream input stream inputstream width output stream outputstream output stream outputstream string suffix io exception ioexception input stream inputstream io exception ioexception input stream inputstream buffered image bufferedimage src imageio read input stream inputstream src string buffer stringbuffer string buffer stringbuffer string fmt imageio get reader format names getreaderformatnames append fmt append io exception ioexception unable read image registered form ats formats scale width src get width getwidth dest width destwidth width dest height destheight src get height getheight scale int value intvalue log debug gen erating generating thumbnail dest width destwidth dest height destheight buffered image bufferedimage dest buffered image bufferedimage dest width destwidth dest height destheight buffered image bufferedimage type rgb graphics dest create graphics creategraphics affine transform affinetransform affine transform affinetransform get s cal e instance getscaleinstance dest width destwidth src get width getwidth dest height destheight src get height getheight draw rendered image drawrenderedimage src imageio write dest suffix substring output stream outputstream