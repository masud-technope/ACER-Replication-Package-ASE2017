licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling installer provider jcr impl java byte array input stream bytearrayinputstream java byte array output stream bytearrayoutputstream java io exception ioexception java input stream inputstream java util array list arraylist java util calendar java util dictionary java util hashtable java util linked list linkedlist java util list java util map java util concurrent atomic atomic boolean atomicboolean java util concurrent atomic atomic integer atomicinteger javax jcr node javax jcr node iterator nodeiterator javax jcr repository exception repositoryexception javax jcr session javax jcr observation event javax jcr observation event iterator eventiterator javax jcr observation event listener eventlistener org apache felix file configuration handler configurationhandler org apache felix scr annotations component org apache felix scr annotations properties org apache felix scr annotations property org apache felix scr annotations property unbounded propertyunbounded org apache felix scr annotations reference org apache felix scr annotations service org apache sling installer api installable resource installableresource org apache sling installer api osgi installer osgiinstaller org apache sling installer api update handler updatehandler org apache sling installer api update result updateresult org apache sling jcr api sling repository slingrepository org apache sling settings sling settings service slingsettingsservice org osgi framework constants org osgi framework service registration serviceregistration org osgi service configuration exception configurationexception org osgi service managed service managedservice org osgi service component component constants componentconstants org osgi service component component context componentcontext org slf logger org slf logger factory loggerfactory main jcr install jcrinstall runs service observes repository folders names match config urable configurable regular expressions registers resources folders osg i osgi installer installation component label jcr install jcrinstall description jcr install jcrinstall description metatype properties property constants service description sling jcr install service property constants service vendor apache software foundation property update handler updatehandler property schemes jcr installer jcrinstaller url scheme unbounded property unbounded propertyunbounded array property constants service ranking int value intvalue service update handler updatehandler jcr installer jcrinstaller update handler updatehandler managed service managedservice loop delay msec string url scheme jcr install jcrinstall pid refactoring string pid org apache sling jcr install impl jcr installer jcrinstaller logger logger logger factory loggerfactory get logger getlogger get class getclass count ers counters statistics testing count ers counters counters count scan folders counter update folders list counter loop counter counters count string file file string resource resource string prop data jcr data string prop modified jcr last modified lastmodified string prop enc jcr encoding string prop mime jcr mime type mimetype string mime txt text plain string encoding utf regexp watched folders string folder regexp install component context componentcontext property overrides folder regexp property folder regexp string folder regexp property sling jcr install jcrinstall folder regexp folder max depth config urable configurable max path depth watched folders property int value intvalue folder max depth string prop install folder max depth sling jcr install jcrinstall folder max depth config urable configurable search path path priorities resource resolver resourceresolver intro ducing introducing dependency values module meant bootstrap services property libs apps unbounded property unbounded propertyunbounded array string prop search path sling jcr install jcrinstall search path string search path libs apps string config path sling install property config path string prop config path sling jcr install jcrinstall config path string pause scan node path system sling installer jcr pause installation pauseinstallation property pause scan node path string prop scan prop path sling jcr install jcrinstall signal path pause message log ged pausemessagelogged enable writeback property bool value boolvalue enable writeback string prop enable writeback sling jcr install jcrinstall enable write back writeback watches repository install able installable resources reference sling repository slingrepository repository additional installation folders activated based current run mode runmode libs foo install dev current mode dev reference sling settings service slingsettingsservice settings osgi installer osgiinstaller installs resources osg i osgi framework reference osgi installer osgiinstaller installer component context component context componentcontext component context componentcontext service reg managed service service registration serviceregistration managed service ref managedserviceref configuration managed service pid dictionary old configuration oldconfiguration convert nodes installable resources installableresources node converter nodeconverter installable resource installableresource convert node convertnode node priority repository exception repositoryexception timer call update folders list updatefolderslist res can timer rescantimer update folders list timer updatefolderslisttimer res can timer rescantimer thread cleanly stopped flag atomic integer atomicinteger bg thread counter bgthreadcounter atomic integer atomicinteger stop pable thread stoppablethread thread event listener eventlistener sync hronizing synchronizing object lock object atomic boolean atomicboolean active atomic boolean atomicboolean atomic boolean atomicboolean running atomic boolean atomicboolean installer config installerconfig cfg detect newly created folders watch list root folder listener rootfolderlistener listeners linked list linkedlist root folder listener rootfolderlistener event listener eventlistener move event listener moveeventlistener session shared watched folder watchedfolder session session stop pable thread stoppablethread installer config installerconfig cfg repository exception repositoryexception cfg cfg set name setname jcr installer jcrinstaller string value of valueof bg thread counter bgthreadcounter increment and get incrementandget set daemon setdaemon open session session repository login administrative loginadministrative repository get default workspace getdefaultworkspace string path cfg get roots getroots listeners add root folder listener rootfolderlistener session path update folders list timer updatefolderslisttimer cfg logger debug configured root folder path watch events root root folders session get workspace getworkspace get observation manager getobservationmanager add event listener addeventlistener event node event node removed is deep isdeep no local nolocal add special observation listener move events move event listener moveeventlistener event listener eventlistener javax jcr observation event listener eventlistener on event onevent javax jcr observation event iterator eventiterator on event onevent event iterator eventiterator events events has next hasnext event events next event nextevent check changes checkchanges get identifier getidentifier check changes checkchanges get path getpath repository exception repositoryexception logger warn repository exception repositoryexception on event onevent session get workspace getworkspace get observation manager getobservationmanager add event listener addeventlistener move event listener moveeventlistener event node moved is deep isdeep no local nolocal logger debug watching node events detect removal add root folders find paths watch create watched folders watchedfolders manage string root cfg get roots getroots find paths to watch findpathstowatch cfg session root scan watched folders watchedfolders register resources installer list installable resource installableresource resources cfg scan watched folders scanwatchedfolders logger debug registering resources osg i osgi installer resources size resources installer register resources registerresources url scheme resources to array toarray installable resource installableresource resources size active active shutdown shutdown running thread sleep interrupted exception interruptedexception thread current thread currentthread int errupt interrupt session root folder listener rootfolderlistener wfc listeners wfc cleanup session session get workspace getworkspace get observation manager getobservationmanager remove event listener removeeventlistener move event listener moveeventlistener session get workspace getworkspace get observation manager getobservationmanager remove event listener removeeventlistener move event listener moveeventlistener move event listener moveeventlistener repository exception repositoryexception logger warn exception session session log out logout session listeners clear javax jcr observation event listener eventlistener on event onevent javax jcr observation event iterator eventiterator on event onevent event iterator eventiterator root folders imp acted impacted has next hasnext event next event nextevent logger debug event check changes checkchanges get path getpath repository exception repositoryexception logger warn repository exception repositoryexception on event onevent check root folders check changes checkchanges string path string root cfg get roots getroots path starts with startswith root logger info event root scheduling scanning folders root update folders list timer updatefolderslisttimer schedule scan schedulescan override logger info background thread starting thread current thread currentthread get name getname active running run one cycle runonecycle cfg session running logger info background thread thread current thread currentthread get name getname count ers counters loop counter installer config installerconfig get configuration getconfiguration cfg stop pable thread stoppablethread background thread backgroundthread activate component activate component context componentcontext context component context componentcontext context start dictionary string object props hashtable string object props constants service pid pid managed service ref managedserviceref component context componentcontext get bundle context getbundlecontext register service registerservice managed service managedservice get name getname props start logger info act ivating activating apache sling jcr installer installer config installerconfig cfg installer config installerconfig logger component context componentcontext old configuration oldconfiguration settings background thread backgroundthread stop pable thread stoppablethread cfg background thread backgroundthread start repository exception repositoryexception logger error repository exception startup deactivating installer component context componentcontext ctx component context componentcontext ctx string string component context componentcontext get properties getproperties component constants componentconstants component ctx disable component disablecomponent deactivate component deactivate component context componentcontext context managed service ref managedserviceref managed service ref managedserviceref unregister managed service ref managedserviceref component context componentcontext logger info deactivating apache sling jcr installer background thread backgroundthread background thread backgroundthread lock background thread backgroundthread active background thread backgroundthread lock notify logger debug waiting background thread backgroundthread get name getname thread background thread backgroundthread shutdown background thread backgroundthread org osgi service managed service managedservice updated java util dictionary updated suppress warnings suppresswarnings rawtypes dictionary properties configuration exception configurationexception restart old configuration oldconfiguration restart properties restart old configuration oldconfiguration properties restart start exception logger error error rest arting restarting find paths watch root path rootpath folder name filter foldernamefilter add result find paths to watch findpathstowatch installer config installerconfig cfg session session string root path rootpath repository exception repositoryexception session repository login administrative loginadministrative repository get default workspace getdefaultworkspace item exists itemexists root path rootpath get item getitem root path rootpath is node isnode logger info bundles root node root path rootpath logger debug bundles root node bundle folders root path rootpath node node get item getitem root path rootpath find paths under node findpathsundernode cfg session log out logout add result folder watch recurse children find paths under node findpathsundernode installer config installerconfig cfg session session node repository exception repositoryexception string path get path getpath priority cfg get folder name filter getfoldernamefilter get priority getpriority path priority cfg add watched folder addwatchedfolder watched folder watchedfolder session path priority cfg get convert ers getconverters depth path split length depth cfg get max watched folder depth getmaxwatchedfolderdepth logger debug recursing max watched folder depth maxwatchedfolderdepth path cfg get max watched folder depth getmaxwatchedfolderdepth node iterator nodeiterator get nodes getnodes has next hasnext find paths under node findpathsundernode cfg session next node nextnode add folders watch detected list installable resource installableresource unregistered folders removed list string update folders list updatefolderslist installer config installerconfig cfg session session exception logger debug updating folder list string root cfg get roots getroots find paths to watch findpathstowatch cfg session root check watched folder watchedfolder deleted list string removed resources removedresources cfg check for removed watched folders checkforremovedwatchedfolders session removed resources removedresources installer config installerconfig get configuration getconfiguration installer config installerconfig cfg stop pable thread stoppablethread background thread backgroundthread cfg get configuration getconfiguration cfg session get session getsession background thread backgroundthread session per iodic periodic scans watched folders watch folders creations deletions run one cycle runonecycle installer config installerconfig cfg session session logger debug running watch cycle did refresh didrefresh cfg any watch folder needs scan anywatchfolderneedsscan session refresh did refresh didrefresh scanning is paused scanningispaused cfg session pause message log ged pausemessagelogged avoid flooding logs msec log info level logger info detected signal pausing jcr provider child nodes path jcr provider scanning performed cfg get pause scan node path getpausescannodepath pause message log ged pausemessagelogged pause message log ged pausemessagelogged pause message log ged pausemessagelogged res can rescan watched folders watchedfolders needed scan wf scanwf watched folder watchedfolder cfg clone watched folders clonewatchedfolders needs scan needsscan scan wf scanwf did refresh didrefresh session refresh did refresh didrefresh count ers counters scan folders counter watched folder watchedfolder scan result scanresult scan to do todo to add toadd size logger info registering resource osg i osgi installer to add toadd to do todo to remove toremove size logger info removing resource osg i osgi installer to remove toremove to do todo to do todo installer update resources updateresources url scheme to add toadd to array toarray installable resource installableresource to add toadd size to remove toremove to array toarray string to remove toremove size watched folder watchedfolder events scan wf scanwf update folders list timer updatefolderslisttimer expired did refresh didrefresh session refresh did refresh didrefresh update folders list timer updatefolderslisttimer reset count ers counters update folders list counter list string to remove toremove update folders list updatefolderslist cfg session to remove toremove size logger info removing resource osg i osgi installer folder deleted to remove toremove installer update resources updateresources url scheme to remove toremove to array toarray string to remove toremove size exception logger warn exception run one cycle runonecycle background thread backgroundthread active background thread backgroundthread lock background thread backgroundthread lock wait loop delay msec interrupted exception interruptedexception ignore thread current thread currentthread int errupt interrupt count ers counters loop counter scanning is paused scanningispaused installer config installerconfig cfg session session repository exception repositoryexception session node exists nodeexists cfg get pause scan node path getpausescannodepath node node session get node getnode cfg get pause scan node path getpausescannodepath result node has nodes hasnodes result logger is debug enabled isdebugenabled list string node names nodenames array list arraylist string node iterator nodeiterator child itr childitr node get nodes getnodes child itr childitr has next hasnext node names nodenames add child itr childitr next node nextnode get name getname logger debug child nodes path scan ning scanning paused node names nodenames cfg get pause scan node path getpausescannodepath result get count ers getcounters count ers counters org apache sling installer api update handler updatehandler handle removal handleremoval java lang string java lang string java lang string update result updateresult handle removal handleremoval string resource type resourcetype string string url configuration installer config installerconfig cfg get configuration getconfiguration cfg cfg is write back iswriteback pos url index of indexof string path url substring pos check protocol url starts with startswith url scheme logger debug removing unmanaged artifact repository url system configuration don delete string root paths rootpaths cfg get folder name filter getfoldernamefilter get root paths getrootpaths string system config root path systemconfigrootpath root paths rootpaths root paths rootpaths length path starts with startswith system config root path systemconfigrootpath logger debug removing system artifact repository path configuration pro visioned provisioned last slash lastslash path last index of lastindexof last slash lastslash string prefix path substring last slash lastslash cfg get folder name filter getfoldernamefilter get priority getpriority prefix last slash lastslash prefix last index of lastindexof remove logger debug removing artifact path session session session repository login administrative loginadministrative session item exists itemexists path session get item getitem path remove session save repository exception repositoryexception logger error unable remove resource path session session log out logout update result updateresult url pro visioned provisioned logger debug removing unmanaged artifact repository path org apache sling installer api update handler updatehandler handle update handleupdate java lang string java lang string java lang string java util dictionary map update result updateresult handle update handleupdate string resource type resourcetype string string url dictionary string object dict map string object attributes handle update handleupdate resource type resourcetype url dict attributes org apache sling installer api update handler updatehandler handle update handleupdate java lang string java lang string java lang string java input stream inputstream map update result updateresult handle update handleupdate string resource type resourcetype string string url input stream inputstream map string object attributes handle update handleupdate resource type resourcetype url attributes string get path with highest prio getpathwithhighestprio installer config installerconfig cfg string old path oldpath string path check root path path highest prio string root path rootpath cfg get folder name filter getfoldernamefilter get root paths getrootpaths old path oldpath starts with startswith root path rootpath slash pos slashpos old path oldpath index of indexof path root path rootpath old path oldpath substring slash pos slashpos path old path oldpath path internal implementation update handling update result updateresult handle update handleupdate string resource type resourcetype string string url input stream inputstream dictionary string object dict map string object attributes configuration installer config installerconfig cfg get configuration getconfiguration cfg cfg is write back iswriteback handle add update configs resource type resourcetype equals installable resource installableresource type config session session session repository login administrative loginadministrative string path resource is moved resourceismoved url update pos url index of indexof string old path oldpath url substring pos calculate node path string node path nodepath url starts with startswith url scheme node path nodepath get path with highest prio getpathwithhighestprio cfg old path oldpath last slash lastslash url last index of lastindexof last pos lastpos url last index of lastindexof string last slash lastslash last pos lastpos last slash lastslash url substring last slash lastslash last pos lastpos node path nodepath get path with highest prio getpathwithhighestprio cfg cfg get new config path getnewconfigpath config ensure extension config node path nodepath ends with endswith config session item exists itemexists node path nodepath session get item getitem node path nodepath remove path node path nodepath config path node path nodepath resource is moved resourceismoved node path nodepath equals old path oldpath logger debug update resource type resourcetype path add string attributes attributes installable resource installableresource resource uri hint string attributes installable resource installableresource resource uri hint path cfg get new config path getnewconfigpath config logger debug add resource type resourcetype path write array stream byte array output stream bytearrayoutputstream baos byte array output stream bytearrayoutputstream baos write configuration created apache sling jcr installer get bytes getbytes utf configuration handler configurationhandler write baos dict baos close create file node jcr util jcrutil create path createpath session path file create resource node node data node datanode jcr util jcrutil create path createpath session path jcr content resource data node datanode set property setproperty prop data byte array input stream bytearrayinputstream baos to byte array tobytearray data node datanode set property setproperty prop modified calendar get instance getinstance data node datanode set property setproperty prop enc encoding data node datanode set property setproperty prop mime mime txt session save update result updateresult result update result updateresult jcr installer jcrinstaller url scheme path priority last slash lastslash path last index of lastindexof string parent path parentpath path substring last slash lastslash result set priority setpriority cfg get folder name filter getfoldernamefilter get priority getpriority parent path parentpath result set resource is moved setresourceismoved resource is moved resourceismoved result repository exception repositoryexception logger error unable add update resource resource type resourcetype io exception ioexception logger error unable add update resource resource type resourcetype session session log out logout