licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery commons providers base org junit assert equals assertequals org junit assert false assertfalse org junit assert not null assertnotnull java lang reflect field java util random java util uuid java util concurrent locks reentrant lock reentrantlock org apache log level org apache log log manager logmanager org apache sling discovery commons providers base topology view basetopologyview org apache sling discovery commons providers default cluster view defaultclusterview org apache sling discovery commons providers dummy topology view dummytopologyview org apache sling discovery commons providers event helper eventhelper org apache sling discovery commons providers base view state manager impl viewstatemanagerimpl org apache sling discovery commons providers spi cluster sync service clustersyncservice org junit org junit org junit ignore org junit test org slf logger org slf logger factory loggerfactory test min event delay handler testmineventdelayhandler logger logger logger factory loggerfactory get logger getlogger get class getclass view state manager impl viewstatemanagerimpl mgr random default random defaultrandom dummy discovery service dummydiscoveryservice sds level log level loglevel dummy scheduler dummyscheduler scheduler setup exception mgr view state manager impl viewstatemanagerimpl reentrant lock reentrantlock cluster sync service clustersyncservice sync base topology view basetopologyview view runnable callback callback override cancel sync cancelsync cancel auto randomness deterministic methods default random defaultrandom random scheduler dummy scheduler dummyscheduler sds dummy discovery service dummydiscoveryservice mgr install min event delay handler installmineventdelayhandler sds scheduler org apache log logger discovery logger discoverylogger log manager logmanager get root logger getrootlogger get logger getlogger org apache sling discovery log level loglevel discovery logger discoverylogger get level getlevel discovery logger discoverylogger set level setlevel level debug tear down teardown exception mgr default random defaultrandom org apache log logger discovery logger discoverylogger log manager logmanager get root logger getrootlogger get logger getlogger org apache sling discovery discovery logger discoverylogger set level setlevel log level loglevel test test reactivate testreactivate exception logger info test reactivate testreactivate start install min event delay handler mineventdelayhandler longer delay mgr install min event delay handler installmineventdelayhandler sds scheduler dummy listener dummylistener listener dummy listener dummylistener logger info test reactivate testreactivate calling handle activated handleactivated mgr bind listener mgr handle activated handleactivated test helper testhelper assert no events assertnoevents listener dummy topology view dummytopologyview view dummy topology view dummytopologyview add instance addinstance dummy topology view dummytopologyview view dummy topology view dummytopologyview clone view add instance addinstance uuid randomuuid to string tostring default cluster view defaultclusterview view get local instance getlocalinstance get cluster view getclusterview dummy topology view dummytopologyview view dummy topology view dummytopologyview clone view add instance addinstance uuid randomuuid to string tostring default cluster view defaultclusterview view get local instance getlocalinstance get cluster view getclusterview logger info test reactivate testreactivate calling handle new view handlenewview mgr handle new view handlenewview view logger info test reactivate testreactivate asserting init event test helper testhelper assert events assertevents mgr listener event helper eventhelper new init event newinitevent view logger info test reactivate testreactivate calling handle changing handlechanging mgr handle changing handlechanging test helper testhelper assert events assertevents mgr listener event helper eventhelper new changing event newchangingevent view logger info test reactivate testreactivate calling handle new view handlenewview time mgr handle new view handlenewview view test helper testhelper assert no events assertnoevents listener min event delay handler mineventdelayhandler finds topology coming delaying sds set top oology settopoology view logger info test reactivate testreactivate waiting async events processed thread sleep logger info test reactivate testreactivate waiting async events processed max assert equals assertequals mgr wait for async events waitforasyncevents logger info test reactivate testreactivate asserting changed event test helper testhelper assert events assertevents mgr listener event helper eventhelper new changed event newchangedevent view view time handle deactivated handledeactivated receiving changed event logger info test reactivate testreactivate calling handle changing handlechanging mgr handle changing handlechanging test helper testhelper assert events assertevents mgr listener event helper eventhelper new changing event newchangingevent view logger info test reactivate testreactivate calling handle new view handlenewview time mgr handle new view handlenewview view test helper testhelper assert no events assertnoevents listener min event delay handler mineventdelayhandler finds topology coming delaying sds set top oology settopoology view logger info test reactivate testreactivate handle deactivated handledeactivated async event sender asynceventsender async event sender asynceventsender mgr get async event sender getasynceventsender field field mgr get class getclass get declared field getdeclaredfield min event delay handler mineventdelayhandler field set accessible setaccessible min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler field mgr assert not null assertnotnull min event delay handler mineventdelayhandler marking view current view set not current setnotcurrent sds set top oology settopoology view mgr handle deactivated handledeactivated test helper testhelper assert no events assertnoevents listener logger info test reactivate testreactivate waiting min event delay handler mineventdelayhandler finished test helper testhelper assert no events assertnoevents listener thread sleep logger info test reactivate testreactivate event test helper testhelper assert no events assertnoevents listener cnt async event sender asynceventsender get in flight event cnt getinflighteventcnt min event delay handler mineventdelayhandler min event delay handler mineventdelayhandler is delaying isdelaying cnt assert equals assertequals cnt assert no events assertnoevents dummy listener dummylistener listener assert equals assertequals listener count events countevents test test normal delaying testnormaldelaying exception dummy listener dummylistener listener dummy listener dummylistener activate logger info test normal delaying testnormaldelaying calling handle activated handleactivated mgr handle activated handleactivated paranoia assert no events assertnoevents listener bind logger info test normal delaying testnormaldelaying calling bind mgr bind listener changing changed assert no events assertnoevents listener logger info test normal delaying testnormaldelaying calling handle changing handlechanging mgr handle changing handlechanging assert no events assertnoevents listener base topology view basetopologyview view dummy topology view dummytopologyview add instance addinstance logger info test normal delaying testnormaldelaying calling handle new view handlenewview mgr handle new view handlenewview view test helper testhelper assert events assertevents mgr listener event helper eventhelper new init event newinitevent view logger info test normal delaying testnormaldelaying calling random event loop randomeventloop test helper testhelper random event loop randomeventloop mgr sds default random defaultrandom listener thread sleep test test failed delaying testfaileddelaying exception scheduler fail mode failmode dummy listener dummylistener listener dummy listener dummylistener activate mgr handle activated handleactivated paranoia assert no events assertnoevents listener bind mgr bind listener changing changed assert no events assertnoevents listener mgr handle changing handlechanging assert no events assertnoevents listener base topology view basetopologyview view dummy topology view dummytopologyview add instance addinstance mgr handle new view handlenewview view test helper testhelper assert events assertevents mgr listener event helper eventhelper new init event newinitevent view test helper testhelper random event loop randomeventloop mgr sds default random defaultrandom listener thread sleep test test long min delay testlongmindelay exception mgr install min event delay handler installmineventdelayhandler sds scheduler dummy listener dummylistener listener dummy listener dummylistener activate logger info test long min delay testlongmindelay calling handle activated handleactivated mgr handle activated handleactivated paranoia assert no events assertnoevents listener bind logger info test long min delay testlongmindelay calling bind mgr bind listener changing changed assert no events assertnoevents listener logger info test long min delay testlongmindelay calling handle changing handlechanging mgr handle changing handlechanging assert no events assertnoevents listener dummy topology view dummytopologyview view dummy topology view dummytopologyview add instance addinstance dummy topology view dummytopologyview clone d view clonedview view clone logger info test long min delay testlongmindelay calling handle new view handlenewview mgr handle new view handlenewview view test helper testhelper assert events assertevents mgr listener event helper eventhelper new init event newinitevent view dummy topology view dummytopologyview view dummy topology view dummytopologyview add instance addinstance view add instance addinstance uuid randomuuid to string tostring default cluster view defaultclusterview view get local instance getlocalinstance get cluster view getclusterview logger info test long min delay testlongmindelay calling handle new view handlenewview clone d view clonedview set not current setnotcurrent mgr handle new view handlenewview view test helper testhelper assert events assertevents mgr listener event helper eventhelper new changing event newchangingevent clone d view clonedview assert false assertfalse view is current iscurrent