licensed apache software foundation asf contributor license agreements notice file distributed work additional copyright ownership asf licenses file apache license version license file compliance license copy license http apache org licenses license required applicable law agreed writing software distributed license distributed basis warranties conditions kind express implied license specific language governing permissions limitations license org apache sling discovery impl cluster voting org junit assert equals assertequals org junit assert false assertfalse org junit assert not null assertnotnull org junit assert true asserttrue org junit fail java util arrays java util hash map hashmap java util hash set hashset java util linked list linkedlist java util list java util map java util java util uuid java util concurrent semaphore java util concurrent time unit timeunit javax jcr path not found exception pathnotfoundexception javax jcr session org apache sling api resource resource resolver resourceresolver org apache sling api resource resource resolver factory resourceresolverfactory org apache sling commons testing jcr repository provider repositoryprovider org apache sling commons threads modifiable thread pool config modifiablethreadpoolconfig org apache sling commons threads impl default thread pool defaultthreadpool org apache sling discovery base setup osg i mock osgimock org apache sling discovery base setup virtual instance helper virtualinstancehelper org apache sling discovery base setup mock dummy resource resolver factory dummyresourceresolverfactory org apache sling discovery commons providers spi base dummy sling settings service dummyslingsettingsservice org apache sling discovery impl cluster voting voting handler votinghandler voting detail votingdetail org apache sling discovery impl common heartbeat heartbeat handler heartbeathandler org apache sling discovery impl common heartbeat heartbeat helper heartbeathelper org apache sling discovery impl setup test config testconfig org eclipse jetty util concurrent hash set concurrenthashset org junit org junit org junit test org slf logger org slf logger factory loggerfactory junit x junitx util private accessor privateaccessor voting handler test votinghandlertest logger logger logger factory loggerfactory get logger getlogger get class getclass voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler string sling id slingid string sling id slingid string sling id slingid string sling id slingid string sling id slingid resource resolver factory resourceresolverfactory factory resource resolver resourceresolver resource resolver resourceresolver test config testconfig config default thread pool defaultthreadpool thread pool threadpool reset repo resetrepo exception session repository provider repositoryprovider instance get repository getrepository login administrative loginadministrative get node getnode remove item removeitem path not found exception pathnotfoundexception pnfe save log out logout set up setup exception sling id slingid uuid randomuuid to string tostring sling id slingid uuid randomuuid to string tostring sling id slingid uuid randomuuid to string tostring sling id slingid uuid randomuuid to string tostring sling id slingid uuid randomuuid to string tostring factory dummy resource resolver factory dummyresourceresolverfactory reset repo resetrepo config test config testconfig discovery impl testing impltesting config set heartbeat interval setheartbeatinterval config set heartbeat timeout setheartbeattimeout voting handler votinghandler voting handler votinghandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config voting handler votinghandler voting handler votinghandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config voting handler votinghandler voting handler votinghandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config voting handler votinghandler voting handler votinghandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config voting handler votinghandler voting handler votinghandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config resource resolver resourceresolver factory get administrative resource resolver getadministrativeresourceresolver modifiable thread pool config modifiablethreadpoolconfig tp config tpconfig modifiable thread pool config modifiablethreadpoolconfig tp config tpconfig set min pool size setminpoolsize tp config tpconfig set max pool size setmaxpoolsize thread pool threadpool default thread pool defaultthreadpool testing tp config tpconfig tear down teardown exception resource resolver resourceresolver resource resolver resourceresolver close thread pool threadpool thread pool threadpool shutdown test test activate deactivate testactivatedeactivate exception assert false assertfalse private accessor privateaccessor get field getfield voting handler votinghandler activated voting handler votinghandler activate assert true asserttrue private accessor privateaccessor get field getfield voting handler votinghandler activated voting handler votinghandler deactivate assert false assertfalse private accessor privateaccessor get field getfield voting handler votinghandler activated test test no votings testnovotings exception voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver voting view votingview new voting newvoting string new view id newviewid string init iator id initiatorid string live instances liveinstances exception voting view votingview new voting newvoting resource resolver resourceresolver config new view id newviewid init iator id initiatorid hash set hashset string arrays as list aslist live instances liveinstances voting view votingview new voting newvoting string init iator id initiatorid string live instances liveinstances exception new voting newvoting uuid randomuuid to string tostring init iator id initiatorid live instances liveinstances test test promotion testpromotion exception voting view votingview voting new voting newvoting sling id slingid sling id slingid assert not null assertnotnull voting virtual instance helper virtualinstancehelper dump repo dumprepo factory voting handler votinghandler activate map voting view votingview voting detail votingdetail result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail promoted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size test test voting yes two nodes testvotingyestwonodes exception voting view votingview voting new voting newvoting sling id slingid sling id slingid sling id slingid assert not null assertnotnull voting heartbeat sling id slingid heartbeat sling id slingid virtual instance helper virtualinstancehelper dump repo dumprepo factory voting handler votinghandler activate map voting view votingview voting detail votingdetail result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail winning result values iterator assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail winning result values iterator test test voting yes three nodes testvotingyesthreenodes exception voting view votingview voting new voting newvoting sling id slingid sling id slingid sling id slingid sling id slingid assert not null assertnotnull voting heartbeat sling id slingid heartbeat sling id slingid heartbeat sling id slingid virtual instance helper virtualinstancehelper dump repo dumprepo factory voting handler votinghandler activate map voting view votingview voting detail votingdetail result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail unchanged result values iterator test test voting yes five nodes testvotingyesfivenodes exception voting view votingview voting new voting newvoting sling id slingid sling id slingid sling id slingid sling id slingid sling id slingid sling id slingid assert not null assertnotnull voting heartbeat sling id slingid heartbeat sling id slingid heartbeat sling id slingid heartbeat sling id slingid heartbeat sling id slingid virtual instance helper virtualinstancehelper dump repo dumprepo factory voting handler votinghandler activate map voting view votingview voting detail votingdetail result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail unchanged result values iterator voting handler votinghandler activate result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail unchanged result values iterator voting handler votinghandler activate result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail unchanged result values iterator voting handler votinghandler activate result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail voted result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail winning result values iterator voting handler votinghandler activate result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail promoted result values iterator heartbeat string sling id slingid exception heartbeat handler heartbeathandler heartbeat handler heartbeathandler test constructor testconstructor dummy sling settings service dummyslingsettingsservice sling id slingid factory config voting handler votinghandler osg i mock osgimock activate heartbeat helper heartbeathelper issue cluster local heartbeat issueclusterlocalheartbeat test test time dout testtimedout exception config set heartbeat timeout setheartbeattimeout voting view votingview voting new voting newvoting sling id slingid sling id slingid assert not null assertnotnull voting thread sleep voting handler votinghandler activate map voting view votingview voting detail votingdetail result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size assert equals assertequals voting detail votingdetail time dout timedout result values iterator result voting handler votinghandler analyze votings analyzevotings resource resolver resourceresolver assert not null assertnotnull result assert equals assertequals result size async vote asyncvote string debug info debuginfo voting handler votinghandler voting handler votinghandler list voting detail votingdetail voting details votingdetails semaphore ready semaphore semaphore throwable exceptions exception runnable runnable override released logger info async vote asyncvote debug info debuginfo logging map voting view votingview voting detail votingdetail result resource resolver resourceresolver retries factory get administrative resource resolver getadministrativeresourceresolver retries logger info async vote asyncvote debug info debuginfo marking ready ready release logger info async vote asyncvote debug info debuginfo waiting acquire logger info async vote asyncvote debug info debuginfo ready retry logger info async vote asyncvote debug info debuginfo analyze votings analyzevotings result voting handler votinghandler analyze votings analyzevotings exception logger warn async vote asyncvote debug info debuginfo exception retries thread sleep logger info async vote asyncvote debug info debuginfo ret rying retrying exception close logger info async vote asyncvote debug info debuginfo asserting assert not null assertnotnull result voting details votingdetails add all addall result values logger info async vote asyncvote debug info debuginfo marking release released runtime exception runtimeexception logger info async vote asyncvote debug info debuginfo runtime exception runtimeexception exceptions add error logger info async vote asyncvote debug info debuginfo error exceptions add exception logger info async vote asyncvote debug info debuginfo exception exceptions add sling info rmed informed thread normal logger info async vote asyncvote debug info debuginfo released released thread pool threadpool execute test test concurrent votes single node testconcurrentvotessinglenode exception do test concurrent votes dotestconcurrentvotes voting handler votinghandler test test concurrent votes two nodes testconcurrentvotestwonodes exception do test concurrent votes dotestconcurrentvotes voting handler votinghandler voting handler votinghandler test test concurrent votes three nodes testconcurrentvotesthreenodes exception do test concurrent votes dotestconcurrentvotes voting handler votinghandler voting handler votinghandler voting handler votinghandler test test concurrent votes four nodes testconcurrentvotesfournodes exception do test concurrent votes dotestconcurrentvotes voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler test test concurrent votes five nodes testconcurrentvotesfivenodes exception do test concurrent votes dotestconcurrentvotes voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler voting handler votinghandler add list voting detail votingdetail voting details votingdetails map voting detail votingdetail integer totals voting detail votingdetail voting details votingdetails integer totals totals count list voting detail votingdetail voting details votingdetails voting detail votingdetail detail result voting detail votingdetail voting details votingdetails equals detail result result do test concurrent votes dotestconcurrentvotes votings loop cnt votingsloopcnt per voting inner loop cnt pervotinginnerloopcnt voting handler votinghandler voting handler votinghandler exception config set heartbeat interval setheartbeatinterval config set heartbeat timeout setheartbeattimeout voting handler votinghandler handler voting handler votinghandler handler activate totals voting handler votinghandler length list map voting detail votingdetail integer total details totaldetails linked list linkedlist map voting detail votingdetail integer voting handler votinghandler length hash map hashmap voting detail votingdetail integer hash map hashmap voting handler votinghandler voting detail votingdetail integer total details totaldetails add string sling ids slingids string voting handler votinghandler length voting handler votinghandler length sling ids slingids string private accessor privateaccessor get field getfield voting handler votinghandler sling id slingid votings loop cnt votingsloopcnt large voting loop logger info test concurrent votes testconcurrentvotes loop voting handler votinghandler cnt voting handler votinghandler length voting handler votinghandler length heartbeat sling ids slingids voting handler votinghandler length string init iator id initiatorid string private accessor privateaccessor get field getfield voting handler votinghandler sling id slingid voting view votingview voting new voting newvoting init iator id initiatorid sling ids slingids assert not null assertnotnull voting semaphore ready semaphore semaphore semaphore semaphore semaphore throwable concurrent hash set concurrenthashset throwable success list list voting detail votingdetail detail list detaillist linked list linkedlist list voting detail votingdetail voting handler votinghandler length detail list detaillist add linked list linkedlist voting handler votinghandler voting detail votingdetail per voting inner loop cnt pervotinginnerloopcnt logger info test concurrent votes testconcurrentvotes loop voting handler votinghandler cnt voting handler votinghandler length voting handler votinghandler length logger info test concurrent votes testconcurrentvotes heartbeat sling id slingid loop voting handler votinghandler cnt voting handler votinghandler length heartbeat sling ids slingids logger info test concurrent votes testconcurrentvotes async vote asyncvote sling id slingid loop voting handler votinghandler cnt voting handler votinghandler length async vote asyncvote voting handler votinghandler detail list detaillist ready assert true asserttrue threads ready ready try acquire tryacquire voting handler votinghandler length time unit timeunit seconds ready logger info test concurrent votes testconcurrentvotes loop voting handler votinghandler cnt voting handler votinghandler length release voting handler votinghandler length assert true asserttrue threads try acquire tryacquire voting handler votinghandler length time unit timeunit seconds size fail exceptions size iterator promotion total count promotiontotalcount no total count nototalcount voting handler votinghandler length promoted cnt promotedcnt count detail list detaillist voting detail votingdetail promoted no cnt nocnt count detail list detaillist voting detail votingdetail voted totals promoted cnt promotedcnt promotion total count promotiontotalcount promoted cnt promotedcnt no total count nototalcount no cnt nocnt promotion total count promotiontotalcount promotion total count promotiontotalcount repeat promotion total count promotiontotalcount fail promoted views promotion total count promotiontotalcount no total count nototalcount voting handler votinghandler length voting handler votinghandler length votes repeat success assert true asserttrue promote per voting inner loop cnt pervotinginnerloopcnt loops success voting handler votinghandler length add detail list detaillist total details totaldetails string buffer stringbuffer string buffer stringbuffer voting handler votinghandler length append sling id slingid append append append totals logger info test concurrent votes testconcurrentvotes promoted total promotion totalpromotion voting handler votinghandler length map entry voting detail votingdetail integer an entry anentry total details totaldetails entry set entryset logger info test concurrent votes testconcurrentvotes sling id slingid detail an entry anentry get key getkey an entry anentry get value getvalue sling assume voting handler votinghandler length votings loop cnt votingsloopcnt happen voting concludes loop instance init iate initiate vote init iator initiator init iator initiator finds completed vote votes check cos voting handler votinghandler length votes loop precise unfortuante assert ion assertion white box assert ions assertions analyze votings analyzevotings helping test stability integer no votes novotes total details totaldetails voting detail votingdetail voted expected voting handler votinghandler length votings loop cnt votingsloopcnt expected assert equals assertequals expected no votes novotes total promotion totalpromotion total details totaldetails voting detail votingdetail promoted assert equals assertequals votings loop cnt votingsloopcnt total promotion totalpromotion